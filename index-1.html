<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة السيرفرات</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #111827;
            --bg-surface: #1F2937;
            --border-color: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --accent: #22D3EE;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        .page.hidden {
            display: none;
        }
        /* File/Folder Item styling */
        .file-item, .folder-item {
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .file-item:hover, .folder-item:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 15px -3px rgba(34, 211, 238, 0.1), 0 2px 4px -2px rgba(34, 211, 238, 0.1);
        }
        .file-item-list, .folder-item-list {
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .file-item-list:hover, .folder-item-list:hover {
            background-color: rgba(31, 41, 55, 0.5);
        }
        .files-container-list {
            display: flex;
            flex-direction: column;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .duration-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        /* تحسينات إضافية */
        .folder-item, .file-item, .folder-item-list, .file-item-list {
            transition: all 0.2s ease-in-out;
        }
        .folder-item:hover, .file-item:hover {
            transform: translateY(-2px);
            border-color: #22D3EE;
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.15);
        }
        .folder-item-list:hover, .file-item-list:hover {
            background-color: rgba(31, 41, 55, 0.8);
            transform: translateX(-4px);
        }
        .cursor-pointer {
            cursor: pointer;
        }
        /* تخصيص إضافي للواجهة */
        .bg-gray-750 {
            background-color: #1a202c;
        }
        /* New modern modal styles */
        .modal-card { background: linear-gradient(180deg, rgba(31,41,55,0.9), rgba(17,24,39,0.95)); border: 1px solid rgba(255,255,255,0.03); }
        .folder-path-pill { background: rgba(34,211,238,0.08); color: #22D3EE; padding: 6px 10px; border-radius: 999px; font-weight:600 }
        .quality-badge { background: rgba(34, 211, 238, 0.1); color: #22D3EE; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; }
        
        /* Scrollable container for files table */
        .files-table-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--bg-surface);
            margin-top: 1rem;
            padding: 0.5rem;
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--bg-surface);
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
            backdrop-filter: blur(8px);
        }
        
        /* ===========================
           START: تصميم المجلدات في وضع الشبكي - التصميم المحدث
           =========================== */
        .folders-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* مجلدتين في صف واحد */
            gap: 0.75rem; /* تقليل المسافة بين المجلدات */
            margin-bottom: 1.5rem;
        }
        
        .folder-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 10px; /* تقليل نصف القطر */
            padding: 0.6rem; /* تصغير الحشو */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            min-height: auto;
            height: 90px; /* الارتفاع العادي */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative; /* إضافة هذه الخاصية لتمكين تحديد موقع زر التعديل */
        }
        
        .folder-card.search-mode {
            height: 115px !important; /* زيادة الارتفاع أثناء البحث */
        }
        
        .folder-card:hover {
            transform: translateY(-2px);
            border-color: #22D3EE;
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.15);
        }
        
        /* زر التعديل في الزاوية العلوية اليمنى - التصميم الجديد */
        .folder-edit-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: transparent; /* بدون خلفية */
            border: none; /* بدون حدود */
            color: #22D3EE; /* نفس لون أيقونة المجلد */
            padding: 0.3rem;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            width: 24px;
            height: 24px;
        }
        
        .folder-edit-btn:hover {
            background: rgba(34, 211, 238, 0.1); /* خلفية خفيفة عند التمرير */
            color: #22D3EE;
        }
        
        .folder-edit-btn i {
            width: 12px !important;
            height: 12px !important;
        }
        
        /* محتوى المجلد في المنتصف - إزالة الهوامش */
        .folder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-grow: 1;
            padding-top: 0; /* إزالة المساحة العلوية */
        }
        
        /* ===========================
           التعديل: أيقونة المجلد فوق العنوان
           =========================== */
        .folder-card .folder-icon-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            width: 100%;
        }
        
        .folder-card .folder-icon-title i {
            width: 1.5rem !important;
            height: 1.5rem !important;
        }
        
        .folder-card .folder-icon-title p {
            font-size: 0.8rem; /* تصغير حجم النص */
            text-align: center; /* توسيط النص */
            margin: 0 auto; /* توسيط النص */
            font-weight: 600;
        }
        
        /* مسار المجلد الجديد */
        .folder-card .folder-path {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin: 0.25rem 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            padding: 0 0.5rem;
        }
        
        .folder-card .folder-stats {
            margin-top: 0.3rem !important; /* تقليل المسافة العلوية */
        }
        
        .folder-card .flex.justify-between.items-center.mt-3.pt-3 {
            margin-top: 0.3rem; /* تقليل المسافة */
            padding-top: 0.3rem; /* تقليل المسافة */
        }
        
        /* تصغير الأيقونات والنصوص في بطاقات المجلدات */
        .folder-card i {
            width: 1rem !important;
            height: 1rem !important;
        }
        
        .folder-card p {
            font-size: 0.8rem; /* تصغير حجم النص */
            text-align: center; /* توسيط النص */
            margin: 0 auto; /* توسيط النص */
        }
        
        .folder-card .stat-item .stat-value {
            font-size: 0.7rem !important; /* تصغير حجم النص في الإحصائيات */
        }
        /* ===========================
   START: استبدال قواعد مجلد الإحصائيات - معدل للارتفاع 110px
   =========================== */

/* الحاوية الرئيسية لصف الإحصائيات داخل البطاقة */
.folder-card .folder-stats,
.folder-item .folder-stats,
.folder-item-list .folder-stats {
  display: flex !important;
  justify-content: space-between !important;
  align-items: flex-start !important;
  gap: 6px !important; /* تقليل المسافة من 8px إلى 6px */
  margin-top: 4px !important; /* تقليل المسافة من 6px إلى 4px */
  width: 100% !important;
}

/* كل مجموعة إحصائيات عبارة عن عمود (stack) */
.folder-card .stats-group,
.folder-item .stats-group,
.folder-item-list .stats-group {
  display: flex !important;
  flex-direction: column !important;
  gap: 3px !important; /* تقليل المسافة من 4px إلى 3px */
  flex: 1 !important;
}

/* المجموعة على الطرف الأيسر (أقصى الشمال) */
.folder-card .stats-group.left-group,
.folder-item .stats-group.left-group,
.folder-item-list .stats-group.left-group {
  align-items: flex-start !important;
  text-align: right !important;
}

/* المجموعة على الطرف الأيمن */
.folder-card .stats-group.right-group,
.folder-item .stats-group.right-group,
.folder-item-list .stats-group.right-group {
  align-items: flex-end !important;
  text-align: left !important;
}

/* عناصر الإحصاء (أيقونة + نص) */
.folder-card .stat-item,
.folder-item .stat-item,
.folder-item-list .stat-item {
  display: flex !important;
  align-items: center !important;
  gap: 3px !important; /* تقليل المسافة من 4px إلى 3px */
  color: var(--text-secondary, #9CA3AF) !important;
  font-weight: 500 !important;
  line-height: 1 !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* أيقونات صغيرة داخل عناصر الإحصاء */
.folder-card .stat-item svg,
.folder-card .stat-item i,
.folder-item .stat-item svg,
.folder-item .stat-item i,
.folder-item-list .stat-item svg,
.folder-item-list .stat-item i {
  width: 10px !important; /* تصغير من 12px إلى 10px */
  height: 10px !important; /* تصغير من 12px إلى 10px */
  flex-shrink: 0 !important;
  color: var(--text-secondary, #9CA3AF) !important;
  display: inline-block !important;
  vertical-align: middle !important;
  margin: 0 !important;
}

/* ضبط نص القيم */
.folder-card .stat-item .stat-value,
.folder-item .stat-item .stat-value,
.folder-item-list .stat-item .stat-value {
  font-size: 9px !important; /* تصغير من 10px إلى 9px */
  color: var(--text-secondary, #9CA3AF) !important;
  margin: 0 !important;
}

.folder-card .folder-icon-title {
  gap: 0.3rem; /* تقليل المسافة بين الأيقونة والعنوان */
  margin-bottom: -0.3rem; /* تقليل المسافة السفلية */
}

.folder-card .folder-icon-title i {
  width: 1.2rem !important; /* تصغير الأيقونة من 1.5rem */
  height: 1.2rem !important;
}

.folder-card .folder-icon-title p {
  font-size: 0.75rem; /* تصغير حجم النص من 0.8rem */
}

/* ===========================
   END: تعديلات إضافية للارتفاع 110px
   =========================== */
        
        /* استثناء للشاشات الضيقة */
        @media (max-width: 480px) {
          .folder-card .folder-stats,
          .folder-item .folder-stats,
          .folder-item-list .folder-stats {
            flex-direction: column !important;
            align-items: center !important;
            gap: 6px !important;
          }
        
          .folder-card .stats-group,
          .folder-item .stats-group,
          .folder-item-list .stats-group,
          .folder-card .stats-group.left-group,
          .folder-item .stats-group.left-group,
          .folder-item-list .stats-group.left-group,
          .folder-card .stats-group.right-group,
          .folder-item .stats-group.right-group,
          .folder-item-list .stats-group.right-group {
            align-items: center !important;
            text-align: center !important;
            flex-direction: row !important;
            gap: 8px !important;
            width: 100% !important;
            justify-content: space-between !important;
          }
        
          .folder-card .stat-item svg,
          .folder-item .stat-item svg,
          .folder-item-list .stat-item svg {
            width: 10px !important;
            height: 10px !important;
          }
        
          .folder-card .stat-item .stat-value,
          .folder-item .stat-item .stat-value,
          .folder-item-list .stat-item .stat-value {
            font-size: 9px !important;
          }
        }
        /* ===========================
           END: استبدال قواعد مجلد الإحصائيات
           =========================== */
        
        /* ===========================
           END: تصميم المجلدات في وضع الشبكي - التصميم المحدث
           =========================== */
        
        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9CA3AF;
        }
        
        /* ===========================
           START: تصميم المجلدات في وضع القائمة - تصغير عمودي وصفين
           =========================== */
        .folders-list-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* مجلدتين في صف واحد */
            gap: 0.75rem; /* تقليل المسافة بين المجلدات */
        }
        
        /* ===========================
           END: تصميم المجلدات في وضع القائمة - تصغير عمودي وصفين
           =========================== */
        
        /* تصميم متطور للنافذة المنبثقة لاختيار المجلد */
        .folder-browser-modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 100;
        }

        .folder-browser-content {
            background: linear-gradient(135deg, rgba(31,41,55,0.95), rgba(17,24,39,0.98)) !important;
            border: 1px solid rgba(34, 211, 238, 0.2) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(34, 211, 238, 0.1) !important;
            border-radius: 16px !important;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .folder-browser-header {
            background: linear-gradient(90deg, rgba(34,211,238,0.1), rgba(56, 189, 248, 0.05)) !important;
            border-bottom: 1px solid rgba(34, 211, 238, 0.2) !important;
            padding: 1.5rem !important;
        }

        .folder-browser-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .folder-browser-footer {
            border-top: 1px solid rgba(34, 211, 238, 0.2);
            padding: 1.5rem;
            background: rgba(17, 24, 39, 0.5);
        }

        .folder-browser-item {
            transition: all 0.2s ease-in-out;
            border-radius: 10px;
            margin: 4px 0;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .folder-browser-item:hover {
            background: rgba(34, 211, 238, 0.1) !important;
            transform: translateX(-5px);
            border-left: 3px solid #22D3EE;
        }

        .folder-browser-item.active {
            background: rgba(34, 211, 238, 0.15) !important;
            border-color: #22D3EE;
        }

        .choose-folder-btn {
            background: linear-gradient(135deg, #22D3EE, #0EA5E9) !important;
            border: none !important;
            color: white !important;
            font-weight: 600 !important;
            padding: 10px 20px !important;
            border-radius: 10px !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3) !important;
        }

        .choose-folder-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4) !important;
        }

        .open-folder-btn {
            background: transparent !important;
            border: 1px solid rgba(34, 211, 238, 0.3) !important;
            color: #22D3EE !important;
            padding: 8px 16px !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        .open-folder-btn:hover {
            background: rgba(34, 211, 238, 0.1) !important;
            border-color: #22D3EE !important;
        }

        .breadcrumb-item {
            display: inline-flex;
            align-items: center;
            color: #9CA3AF;
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: #22D3EE;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #4B5563;
        }

        /* زيادة z-index للنوافذ المنبثقة */
        .modal-overlay {
            z-index: 100;
        }
        
        .folder-modal {
            z-index: 101;
        }
        
        .folder-browser-modal {
            z-index: 102;
        }
        
        /* تحسينات للأداء */
        .folder-browser-content {
            animation: modalAppear 0.2s ease-out forwards;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* تحسينات للتحميل السريع */
        .folder-cache {
            display: none;
        }
        
        /* تصميم جديد للزر العائم */
        .new-fab-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
        
        .new-fab-menu {
            background: rgba(17, 24, 39, 0.95);
            color: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .new-fab-menu.hidden {
            display: none;
        }
        
        .new-fab-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 أعمدة بدلاً من 3 */
            gap: 16px;
            text-align: center;
        }
        
        @media (min-width: 640px) {
            .new-fab-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 أعمدة على الشاشات المتوسطة والكبيرة */
            }
        }
        
        .new-fab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 16px;
            background: rgba(31, 41, 55, 0.8);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .new-fab-item:hover {
            background: rgba(34, 211, 238, 0.1);
            transform: translateY(-2px);
        }
        
        .new-fab-item i {
            margin-bottom: 8px;
        }
        
        .new-fab-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .new-fab-button {
            position: absolute;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #22D3EE, #0EA5E9);
            color: white;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        
        .new-fab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 211, 238, 0.5);
        }
        
        .new-fab-button:active {
            transform: scale(0.95);
        }
        
        .new-fab-button i {
            transition: transform 0.3s ease;
        }
        
        .new-fab-button.open i {
            transform: rotate(180deg);
        }
        
        .drag-handle {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        
        /* ===========================
           START: التعديلات الجديدة للبحث وعكس الجدول
           =========================== */

        /* شريط البحث - مخفي افتراضياً */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
            display: none; /* إخفاء البحث افتراضياً */
        }

        .search-input {
            width: 100%;
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 12px;
            padding: 0.75rem 4rem 0.75rem 1rem; /* زيادة padding-right لزيادة المسافة عن الأيقونة */
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-align: right; /* النص من اليمين للعربية */
        }

        .search-input:focus {
            outline: none;
            border-color: #22D3EE;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #22D3EE; /* تغيير لون أيقونة البحث إلى السماوي */
        }

        /* ===========================
           START: تصغير حجم أزرار تعديل العناوين وإدخالهم داخل المجلد
           =========================== */
        .small-action-btn {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            color: #9CA3AF;
            padding: 0.3rem 0.6rem; /* تم تصغير padding */
            border-radius: 6px;
            font-size: 0.7rem; /* تم تصغير الخط */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem; /* تم تصغير المسافة بين الأيقونة والنص */
        }

        .small-action-btn.primary {
            background: rgba(34, 211, 238, 0.1);
            border-color: rgba(34, 211, 238, 0.3);
            color: #22D3EE;
        }

        .small-action-btn.primary:hover {
            background: rgba(34, 211, 238, 0.2);
            color: #67e8f9;
        }

        .small-action-btn i {
            width: 12px !important; /* تصغير الأيقونة */
            height: 12px !important;
        }
        /* ===========================
           END: تصغير حجم أزرار تعديل العناوين وإدخالهم داخل المجلد
           =========================== */

        /* شريط الإجراءات الجماعية - تصميم جديد */
        .bulk-actions-bar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(34, 211, 238, 0.2);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 99;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .bulk-actions-bar.hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            pointer-events: none;
        }

        .selected-count {
            color: #22D3EE;
            font-weight: 600;
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }

        /* أزرار صغيرة */
        .small-action-btn {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            color: #9CA3AF;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .small-action-btn:hover {
            background: rgba(75, 85, 99, 0.7);
            color: #E5E7EB;
        }

        .small-action-btn.primary {
            background: rgba(34, 211, 238, 0.1);
            border-color: rgba(34, 211, 238, 0.3);
            color: #22D3EE;
        }

        .small-action-btn.primary:hover {
            background: rgba(34, 211, 238, 0.2);
            color: #67e8f9;
        }

        .bulk-actions-bar .close-btn {
            background: transparent;
            border: none;
            color: #9CA3AF;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .bulk-actions-bar .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* تحسينات للاختيار المتعدد */
        .file-item.selected, .table-row-expanded.selected {
            background-color: rgba(34, 211, 238, 0.1);
            border-color: #22D3EE;
        }

        .file-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #4B5563;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-checkbox.checked {
            background: #22D3EE;
            border-color: #22D3EE;
        }

        .file-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* ===========================
           END: التعديلات الجديدة للبحث وعكس الجدول
           =========================== */

        /* ===========================
           START: تصميم المجلدات في وضع القائمة كجدول
           =========================== */
        .folders-table-header {
            display: grid;
            grid-template-columns: 40px 100px minmax(250px, 2fr) 120px minmax(180px, 1fr) 160px 40px;
            gap: 1.5rem;
            padding: 0.75rem 1.5rem;
            text-align: center;
            align-items: center;
        }
        
        .folder-table-row {
            display: grid;
            grid-template-columns: 40px 100px minmax(250px, 2fr) 120px minmax(180px, 1fr) 160px 40px;
            gap: 1.5rem;
            padding: 0.75rem 1.5rem;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease-in-out;
            position: relative;
            cursor: pointer;
        }
        
        .folder-table-row::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                rgba(55, 65, 81, 1) 0%, 
                rgba(55, 65, 81, 1) 70%, 
                rgba(55, 65, 81, 0) 100%);
            pointer-events: none;
        }
        
        .folder-table-row:last-child::after {
            display: none;
        }
        
        .folder-table-row:hover {
            background-color: rgba(31, 41, 55, 0.5);
        }
        
        .folder-table-row.selected {
            background-color: rgba(34, 211, 238, 0.1);
            border-color: #22D3EE;
        }
        
        .folder-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .folder-name-cell {
            text-align: right;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 0.75rem;
            min-width: 0;
        }
        
        .folder-views-cell {
            text-align: center;
            padding: 0 0.5rem;
        }
        
        .folder-contents-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            justify-content: center;
            padding: 0 0.5rem;
        }
        
        .folder-size-cell {
            text-align: left;
            direction: ltr;
            padding: 0 0.5rem;
        }
        
        .folder-arrow-cell {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* ===========================
           END: تصميم المجلدات في وضع القائمة كجدول
           =========================== */

        /* ===========================
           START: التعديلات الجديدة - الصور المصغرة بنسبة 16:9 في وضع الشبكي
           =========================== */
        .file-item .thumbnail-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* نسبة 16:9 (9/16 = 0.5625) */
            overflow: hidden;
        }
        
        .file-item .thumbnail-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
        }
        
        .file-item .duration-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        /* ===========================
           END: التعديلات الجديدة - الصور المصغرة بنسبة 16:9 في وضع الشبكة
           =========================== */
        
        /* ===========================
           START: تصميم تفاصيل الملف المحسن
           =========================== */
        .file-details-modal-content {
            max-height: 92vh;
            display: flex;
            flex-direction: column;
        }

        .file-details-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.2rem 1.2rem 0.8rem 1.2rem;
        }

        .file-details-scrollable {
            max-height: calc(92vh - 180px);
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        /* شريط التمرير */
        .file-details-scrollable::-webkit-scrollbar { width: 6px; }
        .file-details-scrollable::-webkit-scrollbar-track { background: rgba(31,41,55,0.45); border-radius: 10px; }
        .file-details-scrollable::-webkit-scrollbar-thumb { background: rgba(34,211,238,0.85); border-radius: 10px; }

        .smooth-scroll { scroll-behavior: smooth; }

        .title-input-container { position: relative; margin-bottom: 1rem; }
        .title-input {
            transition: all 0.25s ease;
            border: 1px solid rgba(255,255,255,0.04);
            padding-right: 56px !important;
            background: rgba(255,255,255,0.02);
            color: var(--text-primary);
            border-radius: 12px;
            width: 100%;
        }
        .title-input:focus {
            outline: none;
            box-shadow: 0 6px 16px rgba(34,211,238,0.06);
            border-color: rgba(34,211,238,0.26);
        }

        /* زر التعديل: دائري، أيقونة فقط */
        .title-edit-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(34,211,238,0.08);
            border: 1px solid rgba(34,211,238,0.12);
            cursor: pointer;
        }
        .title-edit-btn i { width: 16px; height: 16px; color: var(--accent); }
        .title-edit-btn:hover { transform: translateY(-50%) scale(1.03); }

        /* responsive layout */
        .file-details-responsive { display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 768px) {
            .file-details-responsive { flex-direction: row; }
            .file-thumbnail-container { width: 36%; }
            .file-info-container { width: 64%; }
        }

        .thumbnail-16-9 {
            aspect-ratio: 16 / 9;
            object-fit: cover;
            width: 100%;
            border-radius: 12px;
            display: block;
        }

        /* شبكة التفاصيل: دائماً 2 في كل صف */
        .file-details-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* دائماً عمودين */
            gap: 1rem;
            margin-top: 1rem;
        }

        /* بطاقة التفاصيل مع محتوى في المنتحص */
        .file-detail-card {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 84px; /* ارتفاع موحد */
        }

        .file-detail-card:hover {
            border-color: #22D3EE;
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1);
        }

        /* أزرار الإجراءات بنفس تصميم البطاقات */
        .action-btn {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            gap: 6px;
        }

        .action-btn:hover {
            border-color: #22D3EE;
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1);
            transform: translateY(-2px);
        }

        /* نص التسمية في المنتصف */
        .file-detail-label {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.42rem;
            justify-content: center;
        }

        .file-detail-value {
            font-size: 1.02rem;
            color: var(--text-primary);
            font-weight: 700;
            word-break: break-word;
            line-height: 1;
        }

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 420px) {
            .file-details-grid {
                gap: 0.5rem;
            }
            .file-detail-card {
                padding: 0.65rem;
                border-radius: 10px;
                min-height: 72px;
            }
            .action-btn {
                padding: 0.65rem;
                border-radius: 10px;
            }
            .file-detail-label { font-size: 0.70rem; }
            .file-detail-value { font-size: 0.82rem; }
            .title-edit-btn { width: 32px; height: 32px; }
            .title-input { padding-right: 48px !important; }
            .quality-badge { padding: 5px 8px; font-size: 0.72rem; }
        }

        /* animation */
        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.98) translateY(12px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-overlay { animation: modalAppear 0.18s ease-out forwards; }

        /* ===========================
           END: تصميم تفاصيل الملف المحسن
           =========================== */

        /* ===========================
           START: تصميم خيارات الفترات الزمنية للإحصائيات
           =========================== */
        .period-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .period-selector-label {
            color: #9CA3AF;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .period-dropdown {
            position: relative;
            display: inline-block;
        }

        .period-dropdown-button {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
            color: #9CA3AF;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 150px;
            justify-content: space-between;
        }

        .period-dropdown-button:hover {
            background: rgba(75, 85, 99, 0.7);
            color: #E5E7EB;
        }

        .period-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1F2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 10;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            max-height: 300px;
            overflow-y: auto;
        }

        .period-dropdown-content.show {
            display: block;
        }

        .period-dropdown-item {
            display: block;
            width: 100%;
            text-align: right;
            background: transparent;
            border: none;
            color: #9CA3AF;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .period-dropdown-item:hover {
            background: rgba(34, 211, 238, 0.1);
            color: #22D3EE;
        }

        .period-dropdown-item.active {
            background: rgba(34, 211, 238, 0.2);
            color: #22D3EE;
        }

        /* ===========================
           END: تصميم خيارات الفترات الزمنية للإحصائيات
           =========================== */

        /* ------------------------
           Unified / Clean Table CSS - التعديلات هنا
           ------------------------ */

        /* متغيرات عامة لتسهيل التعديل والاستجابة - التعديلات هنا */
        :root{
          --row-pad-x: 0.5rem;        /* تقليل البادينج الأفقي من 1.5rem إلى 0.5rem */
          --row-pad-y: 0.5rem;        /* تقليل البادينج الرأسي من 0.75rem إلى 0.5rem */
          --row-gap: 0.75rem;         /* تقليل المسافة بين الأعمدة من 1.5rem إلى 0.75rem */
          --border-color: rgba(148,163,184,0.1);
          --accent: #22D3EE;
          --selection-bg: rgba(34,211,238,0.08);
          --row-radius: 8px;
        }

        /* Responsive adjustments (غيرل لتناسب أحجام الشاشات) */
        @media (max-width: 1024px){ :root{ --row-pad-x: 0.5rem; --row-gap: 0.75rem; } }
        @media (max-width: 768px) { :root{ --row-pad-x: 0.5rem; --row-gap: 0.5rem; --row-pad-y: 0.5rem; } }

        /* ========== Table header (واحد فقط) ========== */
        .table-header-expanded{
          display: grid;
          grid-template-columns: 30px 80px minmax(200px, 2fr) 100px minmax(150px, 1fr) 140px 30px; /* تصغير الأعمدة */
          gap: var(--row-gap);
          padding: var(--row-pad-y) var(--row-pad-x);
          text-align: center;
          align-items: center;
          color: #9CA3AF;
          font-weight: 700;
          font-size: 0.8rem; /* تصغير حجم الخط */
          position: relative; /* إضافة */
          border-bottom: 2px solid var(--border-color);
        }

        /* ========== Table row (موحَّد) ========== */
        .table-row-expanded{
          display: grid;
          grid-template-columns: 30px 80px minmax(200px, 2fr) 100px minmax(150px, 1fr) 140px 30px; /* تصغير الأعمدة */
          gap: var(--row-gap);
          padding: var(--row-pad-y) var(--row-pad-x);
          align-items: center;
          border-bottom: 1px solid var(--border-color);
          transition: background-color 0.18s ease, transform .12s ease;
          position: relative;
          cursor: pointer;
          background-clip: padding-box;
          font-size: 0.8rem; /* تصغير حجم الخط */
        }

        /* خط الفاصل تحت كل صف - يبدأ وينتهي داخل حدود البادينج (قابل التعديل) */
        .table-row-expanded::after{
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: var(--border-color);
          pointer-events: none;
        }
        .table-row-expanded:last-child::after{ display: none; }

        /* Hover */
        .table-row-expanded:hover{ background-color: rgba(31,41,55,0.45); }

        /* Selection: نستخدم ::before لتمتد الخلفية حتى خارج البادينج */
        .table-row-expanded.selected{ border-color: var(--accent); }
        .table-row-expanded.selected::before{
          content: '';
          position: absolute;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background: var(--selection-bg);
          z-index: 0;
          border-radius: var(--row-radius);
          pointer-events: none;
        }
        /* ارفع محتوى الصف فوق الخلفية */
        .table-row-expanded.selected > *{ position: relative; z-index: 1; }

        /* ========== Folder rows (استعمل نفس المنهجية) ========== */
        .folders-table-header{
          display: grid;
          grid-template-columns: 30px 80px minmax(200px, 2fr) 100px minmax(150px, 1fr) 140px 30px; /* تصغير الأعمدة */
          gap: var(--row-gap);
          padding: var(--row-pad-y) var(--row-pad-x);
          text-align: center;
          align-items: center;
          color: #9CA3AF;
          font-weight: 700;
          font-size: 0.8rem; /* تصغير حجم الخط */
          position: relative; /* إضافة */
          border-bottom: 2px solid var(--border-color);
        }

        .folder-table-row{
          display: grid;
          grid-template-columns: 30px 80px minmax(200px, 2fr) 100px minmax(150px, 1fr) 140px 30px; /* تصغير الأعمدة */
          gap: var(--row-gap);
          padding: var(--row-pad-y) var(--row-pad-x);
          align-items: center;
          border-bottom: 1px solid var(--border-color);
          transition: background-color 0.18s ease;
          position: relative;
          cursor: pointer;
          font-size: 0.8rem; /* تصغير حجم الخط */
        }
        .folder-table-row::after{
          content:'';
          position:absolute;
          bottom:0;
          left: 0;
          right: 0;
          height:1px;
          background: var(--border-color);
          pointer-events:none;
        }
        .folder-table-row:last-child::after{ display:none; }
        .folder-table-row:hover{ background-color: rgba(31,41,55,0.45); }
        .folder-table-row.selected{ background-color: var(--selection-bg); border-color: var(--accent); }
        .folder-table-row.selected::before{
          content:'';
          position:absolute;
          top:0; bottom:0;
          left: 0;
          right: 0;
          background: var(--selection-bg);
          z-index:0;
          border-radius: var(--row-radius);
        }
        .folder-table-row.selected > *{ position: relative; z-index: 1; }

        /* ========== Cells specifics ========== */
        .table-cell-checkbox{ display:flex; justify-content:center; align-items:center; }
        .table-cell-thumbnail{ display:flex; justify-content:center; align-items:center; }
        .table-cell-title{ text-align:right; overflow:hidden; display:flex; align-items:center; padding:0 0.5rem; min-width:0; font-size: 0.8rem; } /* تصغير الحشو والحجم */
        .table-cell-views, .table-cell-qualities, .table-cell-date{ padding:0 0.25rem; font-size: 0.8rem; } /* تصغير الحشو والحجم */
        .table-cell-views{ text-align:center; }
        .table-cell-date{ text-align:left; direction:ltr; }

        /* ========== Thumbnail 16:9 ========== */
        .table-thumbnail-16-9{
          width:100%;
          aspect-ratio: 16/9;
          object-fit: cover;
          border-radius: 6px; /* تصغير نصف القطر */
          display:block;
        }

        /* ========== File title (ellipsis & clamp) ========== */
        .file-title{
          font-weight:600;
          color: var(--text-primary, #E6EEF8);
          line-height:1.4;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow:hidden;
          text-overflow:ellipsis;
          width:100%;
          min-width:0;
          font-size: 0.8rem; /* تصغير حجم الخط */
        }

        /* ========== Date/time small ========== */
        .upload-date-time{ font-size:0.7rem; color: var(--text-secondary, #9CA3AF); direction:ltr; text-align:left; } /* تصغير حجم الخط */

        /* ========== Checkbox style ========== */
        .file-checkbox{
          width:16px; height:16px; border-radius:4px; border:2px solid #4B5563; background:transparent; /* تصغير الحجم */
          cursor:pointer; transition: all .15s ease; display:flex; align-items:center; justify-content:center;
        }
        .file-checkbox.checked{ background: var(--accent); border-color: var(--accent); }
        .file-checkbox.checked::after{ content:'✓'; color:#fff; font-size:10px; font-weight:700; } /* تصغير حجم الأيقونة */

        /* ========== Bulk actions bar (مراجعته إن أردت تغييرات) ========== */
        .bulk-actions-bar{
          position: fixed;
          bottom: 100px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(31,41,55,0.95);
          border: 1px solid rgba(34,211,238,0.2);
          border-radius: 12px;
          padding: 0.75rem 1rem;
          box-shadow: 0 10px 25px rgba(0,0,0,0.5);
          backdrop-filter: blur(10px);
          z-index: 99;
          display:flex; align-items:center; gap:0.75rem;
        }

        /* ========== Table container scroll ========== */
        .files-table-container{
          max-height: 70vh;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          border: 1px solid var(--border-color);
          border-radius: 12px;
          background-color: var(--bg-surface);
          margin-top: 1rem;
        }

        /* ========== Misc / grid->list compatibility ========== */
        .files-table-wrapper{ width:100%; overflow-x:auto; }

        /* ========== Small UI bits used in file ========== */
        .file-item, .folder-item{ background: var(--bg-surface, #0f1724); border:1px solid var(--border-color); transition: all .18s ease-in-out; }
        .file-item:hover, .folder-item:hover{ transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 6px 18px rgba(34,211,238,0.08); }
        .duration-badge{ position:absolute; bottom:8px; left:8px; background: rgba(0,0,0,0.7); color:#fff; padding:2px6px; border-radius:4px; font-size:0.75rem; font-weight:500; }

        /* ========== Performance helpers ========== */
        .skeleton-loader{ background: linear-gradient(90deg, #1F2937 25%, #374151 50%, #1F2937 75%); background-size:200% 100%; animation: loading 1.5s infinite; border-radius:6px; }
        @keyframes loading{ 0%{ background-position: 200% 0; } 100%{ background-position: -200% 0; } }

        /* ---------- End of unified table CSS ---------- */

        /* ===========================
           START: تصغير الأزرار في النوافذ المنبثقة
           =========================== */
        .modal-footer-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .modal-footer-buttons button {
            padding: 0.5rem 1rem !important;
            font-size: 0.85rem !important;
        }
        /* ===========================
           END: تصغير الأزرار في النوافذ المنبثقة
           =========================== */

        .upload-modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .upload-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .upload-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .upload-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
            background: rgba(34, 211, 238, 0.05);
        }

        .upload-tab-content {
            display: none;
        }

        .upload-tab-content.active {
            display: block;
        }

        .file-drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .file-drop-area:hover, .file-drop-area.dragover {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.05);
        }

        .file-drop-area i {
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item-upload {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-surface);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .file-item-upload .file-info {
            flex: 1;
            text-align: right;
        }

        .file-item-upload .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .upload-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background: var(--bg-surface);
        }

        .upload-status.success {
            border-left: 4px solid #10B981;
        }

        .upload-status.error {
            border-left: 4px solid #EF4444;
        }

        .upload-status.info {
            border-left: 4px solid var(--accent);
        }

        .url-upload-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .url-upload-form input {
            flex: 1;
        }

        .url-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .url-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-surface);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .url-item .url-info {
            flex: 1;
            text-align: right;
            overflow: hidden;
        }

        .url-item .url {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .url-item .url-actions {
            display: flex;
            gap: 0.5rem;
        }
        /* ===========================
           END: أنماط نافذة تحميل الملفات
           =========================== */
           /* ---------- Circular badges & spinner for upload UI ---------- */
.file-item-upload {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 0.75rem;
  background: var(--bg-surface);
  border-radius: 10px;
  margin-bottom: 0.5rem;
}
/* container for circular indicators */
.file-item-badges {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
/* generic circular badge */
.circular-badge {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.04);
  color: var(--text-primary);
  box-shadow: inset 0 -4px 8px rgba(0,0,0,0.25);
}
.circular-badge.small {
  width: 36px;
  height: 36px;
  font-size: 0.82rem;
}
.circular-badge .spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.12);
  border-top-color: var(--accent);
  animation: spin 0.9s linear infinite;
  box-sizing: border-box;
}
@keyframes spin { to { transform: rotate(360deg); } }
.circular-badge.success {
  background: #10B981;
  border-color: rgba(16,185,129,0.25);
  color: white;
}
.circular-badge.error {
  background: #ef4444;
  border-color: rgba(239,68,68,0.25);
  color: white;
}
.file-info {
  flex: 1;
  min-width: 0;
}
.file-info .file-name {
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}
.file-meta-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 6px;
  color: var(--text-secondary);
  font-size: 0.9rem;
}
.progress-bar { width:100%; height:6px; background:var(--border-color); border-radius:3px; overflow:hidden; margin-top:8px; }
.progress-bar-fill { height:100%; background:var(--accent); transition: width 0.3s ease; }
.circular-badge i[data-lucide], .circular-badge svg {
  width: 18px !important;
  height: 18px !important;
}
@media (max-width:480px) {
  .file-item-upload { gap:10px; }
  .circular-badge { width:40px; height:40px; }
  .circular-badge.small { width:30px; height:30px; }
}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-[Tajawal]">
    <main id="app-container" class="p-4 md:p-6 pb-32">
        <!-- Dashboard Page -->
        <section id="dashboard-page" class="page">
            <h1 class="text-3xl font-bold text-white mb-6">لوحة التحكم</h1>
            <div id="dashboard-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                <!-- Dashboard cards will be injected here -->
            </div>
        </section>
        
        <!-- Files Page -->
        <section id="files-page" class="page hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-3xl font-bold text-white">الملفات</h1>
                <div class="flex items-center gap-3">
                    <button 
                        id="create-folder-btn"
                        onclick="showFolderManagementModal()"
                        class="flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white px-4 py-2 rounded-xl transition-all shadow-lg shadow-cyan-500/25"
                    >
                        <i data-lucide="folder-plus" class="w-4 h-4"></i>
                        <span>مجلد جديد</span>
                    </button>
                    <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg">
                        <button id="view-toggle-list" class="p-2 rounded-md hover:bg-gray-700 transition-colors">
                            <i data-lucide="list" class="w-5 h-5"></i>
                        </button>
                        <button id="view-toggle-grid" class="p-2 rounded-md bg-gray-700 text-cyan-400 transition-colors">
                            <i data-lucide="grid" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="breadcrumb-container" class="flex items-center gap-2 text-gray-400 mb-4">
                <!-- Breadcrumbs will be injected here -->
            </div>
            
            <!-- Grid View Container -->
            <div id="files-grid-container">
                <!-- Folders Grid - التصميم المحدث -->
                <div id="folders-grid-container" class="folders-grid">
                    <!-- Folders will be injected here in grid view -->
                </div>
                
                <!-- شريط البحث - تم نقله ليظهر أسفل المجلدات وفوق الملفات -->
                <div class="search-container hidden">
                    <input 
                        type="text" 
                        id="search-input"
                        class="search-input"
                        placeholder="ابحث في جميع المجلدات والملفات..."
                    >
                    <div class="search-icon">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </div>
                </div>
                
                <!-- Files Grid -->
                <div id="files-grid-content" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                    <!-- Files will be injected here in grid view -->
                </div>
            </div>
            
            <!-- List View Container -->
            <div id="files-list-container" class="hidden">
                <!-- Folders Section - وضع الشبكي الجديد -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">المجلدات</h2>
                    <div id="folders-list-content" class="folders-list-grid">
                        <!-- سيتم إضافة المجلدات هنا عبر JavaScript -->
                    </div>
                </div>
                
                <!-- شريط البحث - في وضع القائمة -->
                <div class="search-container hidden">
                    <input 
                        type="text" 
                        id="search-input-list"
                        class="search-input"
                        placeholder="ابحث في جميع المجلدات والملفات..."
                    >
                    <div class="search-icon">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </div>
                </div>
                
                <!-- Files Table Section -->
                <div>
                    <h2 class="text-xl font-bold text-white mb-4">الملفات</h2>
                    <div class="files-table-wrapper">
                        <div class="files-table-container">
                            <div id="files-table-header" class="sticky-header table-header-expanded text-sm text-gray-400 font-bold">
                                <span class="header-cell table-cell-checkbox">
                                    <input type="checkbox" id="select-all-checkbox" class="file-checkbox">
                                </span>
                                <span class="header-cell table-cell-thumbnail">الصورة</span>
                                <span class="header-cell table-cell-title">العنوان</span>
                                <span class="header-cell table-cell-views">المشاهدات</span>
                                <span class="header-cell table-cell-qualities">الجودات المتاحة</span>
                                <span class="header-cell table-cell-date">تاريخ الرفع</span>
                                <span class="header-cell table-cell-arrow"></span>
                            </div>
                            <div id="files-list-content" class="files-container-list">
                                <!-- Files will be injected here in list view -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Stats Page -->
        <section id="stats-page" class="page hidden">
            <h1 class="text-3xl font-bold text-white mb-6">الإحصائيات</h1>
            
            <!-- إحصائيات المشاهدات -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h2 class="text-xl font-bold text-white mb-2 md:mb-0">إحصائيات المشاهدات</h2>
                    
                    <!-- خيارات الفترات الزمنية - وضعت داخل قسم رسم البياني -->
                    <div class="period-selector-container">
                        <span class="period-selector-label">الفترة:</span>
                        <!-- القائمة المنسدلة -->
                        <div class="period-dropdown">
                            <button class="period-dropdown-button">
                                <span id="selected-period-text">أسبوع</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div class="period-dropdown-content">
                                <button class="period-dropdown-item" data-period="1">ساعة</button>
                                <button class="period-dropdown-item" data-period="12">12 ساعة</button>
                                <button class="period-dropdown-item" data-period="24">24 ساعة</button>
                                <button class="period-dropdown-item" data-period="48">48 ساعة</button>
                                <button class="period-dropdown-item active" data-period="7">أسبوع</button>
                                <button class="period-dropdown-item" data-period="10">10 أيام</button>
                                <button class="period-dropdown-item" data-period="15">15 يوم</button>
                                <button class="period-dropdown-item" data-period="30">شهر</button>
                                <button class="period-dropdown-item" data-period="90">3 أشهر</button>
                                <button class="period-dropdown-item" data-period="180">6 أشهر</button>
                                <button class="period-dropdown-item" data-period="365">سنة</button>
                                <button class="period-dropdown-item" data-period="0">إلى الأبد</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-80 relative">
                    <canvas id="stats-chart-views"></canvas>
                </div>
            </div>
            
            <!-- إحصائيات الأرباح -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-white mb-4">إحصائيات الأرباح</h2>
                <div class="h-80 relative">
                    <canvas id="stats-chart-profits"></canvas>
                </div>
            </div>
        </section>
    </main>
    
    <!-- شريط الإجراءات الجماعية - تصميم جديد -->
    <div id="bulk-actions-bar" class="bulk-actions-bar hidden">
        <div class="flex items-center gap-2">
            <i data-lucide="check-square" class="w-4 h-4 text-cyan-400"></i>
            <span class="text-sm">تم تحديد</span>
            <span id="selected-count" class="selected-count">0</span>
            <span class="text-sm">عنصر</span>
        </div>
        <button id="edit-titles-btn" class="small-action-btn primary">
            <i data-lucide="edit" class="w-3 h-3"></i>
            تعديل العناوين
        </button>
        <button id="move-to-folder-btn" class="small-action-btn primary">
            <i data-lucide="folder-input" class="w-3 h-3"></i>
            إدخالهم داخل المجلد
        </button>
        <button id="close-bulk-actions" class="close-btn">
            <i data-lucide="x" class="w-3 h-3"></i>
        </button>
    </div>
    
    <!-- Floating Action Button & Navigation - التصميم الجديد -->
    <div class="new-fab-container">
        <div id="new-fab-menu" class="new-fab-menu hidden">
            <div class="drag-handle"></div>
            <div class="new-fab-grid">
                <button data-page="dashboard" class="new-fab-item">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 text-cyan-400"></i>
                    <span>لوحة التحكم</span>
                </button>
                <button data-page="files" class="new-fab-item">
                    <i data-lucide="folder" class="w-6 h-6 text-cyan-400"></i>
                    <span>الملفات</span>
                </button>
                <button data-page="stats" class="new-fab-item">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 text-cyan-400"></i>
                    <span>الإحصائيات</span>
                </button>
                <!-- إضافة زر تحميل الملفات إلى القائمة العائمة -->
                <button onclick="showUploadModal()" class="new-fab-item">
                    <i data-lucide="upload" class="w-6 h-6 text-cyan-400"></i>
                    <span>تحميل الملفات</span>
                </button>
            </div>
        </div>
        <button id="new-fab-button" class="new-fab-button">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
    </div>

<script>
// API Configuration
const API_KEY = '26175cn9xz17saiklfjq3';
const API_BASE_URL = 'https://streamhgapi.com/api';

// Cache for folder data to improve performance
const folderCache = new Map();
const fileInfoCache = new Map();

// Global statistics storage
const globalStats = {
    totalViewsFromFiles: 0,
    filesViewsHistory: [],
    lastUpdated: null
};

// إعدادات الفترة الزمنية الحالية
let currentPeriod = 7; // القيمة الافتراضية: أسبوع

// المتغيرات الجديدة للبحث والتحديد المتعدد
let selectedFiles = new Set();
let selectedFolders = new Set();
let currentSearchQuery = '';
let currentFilesData = []; // تخزين البيانات الأصلية للاستعادة بعد البحث
let allFoldersData = []; // تخزين جميع المجلدات للبحث المتقدم

// متغيرات تحميل الملفات
let uploadFiles = [];
let remoteUploadUrls = [];
let currentUploadServer = null;

// حالة التطبيق العامة
let state = {
    currentPage: 'dashboard',
    currentFolderId: 0,
    currentView: 'grid',
    breadcrumbs: [{ name: 'الملفات', id: 0 }],
    allFiles: [] // تخزين جميع الملفات
};

// متغيرات التحديث التلقائي
let autoRefreshInterval = null;
let autoRefreshEnabled = true; // مفعل افتراضياً
let autoRefreshIntervalTime = 30000; // 30 ثانية افتراضياً

// Real API Functions
async function fetchApi(endpoint, params = {}) {
    const urlParams = new URLSearchParams({
        key: API_KEY,
        ...params
    });
    const url = `${API_BASE_URL}${endpoint}?${urlParams}`;
    console.log(`API CALL: ${url}`);
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (data.status !== 200) {
            throw new Error(data.msg || 'API error');
        }
        return data;
    } catch (error) {
        console.error('API Error:', error);
        throw error;
    }
}

// دالة محسنة مع إعادة المحاولة
async function fetchApiWithRetry(endpoint, params = {}, maxRetries = 3) {
    let lastError;
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fetchApi(endpoint, params);
        } catch (error) {
            lastError = error;
            console.warn(`API call failed (attempt ${i + 1}/${maxRetries}):`, error);
            if (i < maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            }
        }
    }
    throw lastError;
}

// دوال API مع التخزين المؤقت
async function fetchAccountInfo() {
    const cacheKey = 'account-info';
    if (folderCache.has(cacheKey)) {
        console.log('Using cached account info');
        return folderCache.get(cacheKey);
    }
    
    const data = await fetchApiWithRetry('/account/info');
    folderCache.set(cacheKey, data);
    return data;
}

// دالة محسنة لجلب إحصائيات الحساب مع الفترة الزمنية
async function fetchAccountStats(period = 7) {
    const cacheKey = `account-stats-${period}`;
    
    // مسح الذاكرة المؤقتة إذا كانت قديمة (أكثر من 5 دقائق)
    const cachedData = folderCache.get(cacheKey);
    if (cachedData && cachedData.timestamp) {
        const now = Date.now();
        const cacheAge = now - cachedData.timestamp;
        if (cacheAge > 5 * 60 * 1000) { // 5 دقائق
            folderCache.delete(cacheKey);
        }
    }
    
    if (folderCache.has(cacheKey)) {
        console.log('Using cached account stats for period:', period);
        return folderCache.get(cacheKey).data;
    }
    
    // إذا كانت الفترة 0 (إلى الأبد) أو أكثر من 365 يوم، نستخدم فترة كبيرة
    const last = period === 0 ? 3650 : period; // 0 يعني إلى الأبد، نستخدم 10 سنوات كحد أقصى
    
    const data = await fetchApiWithRetry('/account/stats', { last: last.toString() });
    
    // تخزين البيانات مع الطابع الزمني
    folderCache.set(cacheKey, {
        data: data,
        timestamp: Date.now()
    });
    
    return data;
}

// دالة جديدة محسنة لجلب إحصائيات الملفات من جميع المجلدات بشكل صحيح
async function fetchFilesStats() {
    const cacheKey = 'files-stats';
    
    // مسح الذاكرة المؤقتة إذا كانت قديمة (أكثر من 2 دقيقة)
    const cachedData = folderCache.get(cacheKey);
    if (cachedData && cachedData.timestamp) {
        const now = Date.now();
        const cacheAge = now - cachedData.timestamp;
        if (cacheAge > 2 * 60 * 1000) { // 2 دقائق
            folderCache.delete(cacheKey);
        }
    }
    
    if (folderCache.has(cacheKey)) {
        console.log('Using cached files stats');
        return folderCache.get(cacheKey).data;
    }
    
    try {
        // استخدام دالة جديدة تعمل بشكل متكرر لجمع جميع المشاهدات
        console.log('جاري حساب إجمالي المشاهدات من جميع الملفات...');
        const stats = await calculateAllFilesStats();
        console.log('نتيجة حساب المشاهدات:', stats);
        
        const statsData = {
            totalViews: stats.totalViews,
            totalFiles: stats.totalFiles,
            status: 200
        };
        
        // تخزين البيانات مع الطابع الزمني
        folderCache.set(cacheKey, {
            data: statsData,
            timestamp: Date.now()
        });
        
        return statsData;
    } catch (error) {
        console.error('Error fetching files stats:', error);
        return {
            totalViews: 0,
            totalFiles: 0,
            status: 500
        };
    }
}

// دالة جديدة لجمع إحصائيات جميع الملفات بشكل متكرر - تم التحسين
async function calculateAllFilesStats() {
    let totalViews = 0;
    let totalFiles = 0;
    let processedFiles = 0;
    
    console.log('بدء حساب إحصائيات جميع الملفات...');
    
    // دالة مساعدة محسنة
    async function processFolder(folderId) {
        try {
            console.log(`جاري معالجة المجلد: ${folderId}`);
            const response = await fetchFiles(folderId);
            const folders = response.result.folders || [];
            const files = response.result.files || [];
            
            console.log(`المجلد ${folderId}: ${files.length} ملفات, ${folders.length} مجلدات فرعية`);
            
            // معالجة الملفات في المجلد الحالي
            totalFiles += files.length;
            
            // جمع المشاهدات من البيانات الأساسية أولاً
            for (const file of files) {
                processedFiles++;
                
                // الحصول على معلومات مفصلة للملف لضمان الحصول على أحدث عدد المشاهدات
                try {
                    const fileInfo = await fetchFileInfo(file.file_code);
                    if (fileInfo.result && fileInfo.result[0]) {
                        const detailedFile = fileInfo.result[0];
                        const views = parseInt(detailedFile.views || file.views || 0);
                        totalViews += views;
                        
                        if (views > 0) {
                            console.log(`الملف ${file.file_code}: ${views} مشاهدة (بيانات مفصلة)`);
                        }
                    } else {
                        // استخدام البيانات الأساسية إذا فشل الحصول على البيانات المفصلة
                        const views = parseInt(file.views || 0);
                        totalViews += views;
                        
                        if (views > 0) {
                            console.log(`الملف ${file.file_code}: ${views} مشاهدة (بيانات أساسية)`);
                        }
                    }
                } catch (fileError) {
                    console.warn(`فشل في جلب معلومات الملف ${file.file_code}:`, fileError);
                    // استخدام البيانات الأساسية كبديل
                    const views = parseInt(file.views || 0);
                    totalViews += views;
                    
                    if (views > 0) {
                        console.log(`الملف ${file.file_code}: ${views} مشاهدة (بيانات أساسية - بديل)`);
                    }
                }
                
                // تحديث كل 5 ملفات لتجنب تجميد الواجهة
                if (processedFiles % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            
            // معالجة المجلدات الفرعية
            for (const folder of folders) {
                await processFolder(folder.fld_id);
            }
        } catch (error) {
            console.error('خطأ في معالجة المجلد:', folderId, error);
        }
    }
    
    try {
        await processFolder(0);
        console.log(`النتيجة النهائية: ${totalViews} مشاهدة من ${totalFiles} ملف (معالج: ${processedFiles})`);
        
        // تحديث الإحصائيات العالمية
        globalStats.totalViewsFromFiles = totalViews;
        globalStats.lastUpdated = new Date();
        
        return {
            totalViews,
            totalFiles
        };
    } catch (error) {
        console.error('خطأ جسيم في حساب الإحصائيات:', error);
        return {
            totalViews: 0,
            totalFiles: 0
        };
    }
}

async function fetchFiles(folderId = 0) {
    // Check cache first
    const cacheKey = `files-${folderId}`;
    
    // مسح الذاكرة المؤقتة إذا كانت قديمة (أكثر من 1 دقيقة)
    const cachedData = folderCache.get(cacheKey);
    if (cachedData && cachedData.timestamp) {
        const now = Date.now();
        const cacheAge = now - cachedData.timestamp;
        if (cacheAge > 1 * 60 * 1000) { // 1 دقيقة
            folderCache.delete(cacheKey);
        }
    }
    
    if (folderCache.has(cacheKey)) {
        console.log('Using cached data for folder:', folderId);
        return folderCache.get(cacheKey).data;
    }
    
    const data = await fetchApiWithRetry('/folder/list', { 
        fld_id: folderId.toString(),
        files: '1'
    });
    
    // Cache the result with timestamp
    folderCache.set(cacheKey, {
        data: data,
        timestamp: Date.now()
    });
    
    return data;
}

// دالة جديدة لجلب جميع المجلدات بشكل متكرر للبحث المتقدم
async function fetchAllFoldersRecursively(folderId = 0, path = '') {
    try {
        const response = await fetchFiles(folderId);
        const folders = response.result.folders || [];
        const files = response.result.files || [];
        
        let allFolders = [];
        
        // إضافة المجلدات الحالية مع مسارها
        for (const folder of folders) {
            const folderPath = path ? `${path}/${folder.name}` : folder.name;
            const folderWithPath = {
                ...folder,
                path: folderPath,
                fullPath: folderPath
            };
            allFolders.push(folderWithPath);
            
            // جلب المجلدات الفرعية بشكل متكرر
            const subFolders = await fetchAllFoldersRecursively(folder.fld_id, folderPath);
            allFolders = allFolders.concat(subFolders);
        }
        
        return allFolders;
    } catch (error) {
        console.error('Error fetching all folders recursively:', error);
        return [];
    }
}

// دالة جديدة للبحث المتقدم في جميع المجلدات والملفات - تم التعديل هنا
async function advancedSearch(query) {
    console.log('بدء البحث المتقدم عن:', query);
    
    // جلب جميع المجلدات بشكل متكرر
    if (allFoldersData.length === 0) {
        console.log('جاري تحميل جميع المجلدات للبحث...');
        allFoldersData = await fetchAllFoldersRecursively();
        console.log('تم تحميل', allFoldersData.length, 'مجلد للبحث');
    }
    
    const searchResults = {
        folders: [],
        files: []
    };
    
    const searchTerm = query.toLowerCase().trim();
    
    // البحث في المجلدات - تم التعديل هنا لإضافة isSearch: true
    for (const folder of allFoldersData) {
        if (folder.name.toLowerCase().includes(searchTerm) || 
            (folder.path && folder.path.toLowerCase().includes(searchTerm))) {
            // إضافة خاصية showPath و isSearch للمجلدات التي تم العثور عليها
            searchResults.folders.push({
                ...folder,
                showPath: true,
                isSearch: true
            });
        }
    }
    
    // البحث في الملفات في جميع المجلدات
    try {
        // دالة مساعدة للبحث في الملفات بشكل متكرر
        async function searchFilesInFolder(folderId, folderPath = '') {
            try {
                const response = await fetchFiles(folderId);
                const files = response.result.files || [];
                const folders = response.result.folders || [];
                
                // البحث في الملفات الحالية
                for (const file of files) {
                    const title = file.title || file.name || file.file_name || '';
                    if (title.toLowerCase().includes(searchTerm)) {
                        searchResults.files.push({
                            ...file,
                            folderPath: folderPath
                        });
                    }
                }
                
                // البحث في المجلدات الفرعية
                for (const folder of folders) {
                    const newPath = folderPath ? `${folderPath}/${folder.name}` : folder.name;
                    await searchFilesInFolder(folder.fld_id, newPath);
                }
            } catch (error) {
                console.error('Error searching in folder:', folderId, error);
            }
        }
        
        await searchFilesInFolder(0);
    } catch (error) {
        console.error('Error in advanced file search:', error);
    }
    
    console.log('نتائج البحث:', {
        folders: searchResults.folders.length,
        files: searchResults.files.length
    });
    
    return searchResults;
}

async function fetchFileInfo(fileCode) {
    // Check cache first - مسح الذاكرة المؤقتة إذا كانت قديمة
    const cachedData = fileInfoCache.get(fileCode);
    if (cachedData && cachedData.timestamp) {
        const now = Date.now();
        const cacheAge = now - cachedData.timestamp;
        if (cacheAge > 2 * 60 * 1000) { // 2 دقائق
            fileInfoCache.delete(fileCode);
        }
    }
    
    if (fileInfoCache.has(fileCode)) {
        console.log('Using cached file info:', fileCode);
        return fileInfoCache.get(fileCode).data;
    }
    
    const data = await fetchApiWithRetry('/file/info', { file_code: fileCode });
    
    // Cache the result with timestamp
    fileInfoCache.set(fileCode, {
        data: data,
        timestamp: Date.now()
    });
    
    return data;
}

// دالة محسنة لجلب معلومات مفصلة لعدة ملفات مرة واحدة
async function fetchMultipleFilesInfo(fileCodes) {
    if (!fileCodes || fileCodes.length === 0) return [];
    
    console.log('جلب معلومات مفصلة للملفات:', fileCodes);
    
    // تحقق من الذاكرة المؤقتة أولاً
    const cachedResults = [];
    const missingCodes = [];
    
    fileCodes.forEach(code => {
        const cachedData = fileInfoCache.get(code);
        if (cachedData && cachedData.data && cachedData.data.result) {
            cachedResults.push(cachedData.data.result[0]);
        } else {
            missingCodes.push(code);
        }
    });
    
    // إذا كانت جميع النتائج في الذاكرة المؤقتة
    if (missingCodes.length === 0) {
        console.log('All file info loaded from cache');
        return { result: cachedResults };
    }
    
    try {
        // جلب البيانات المفقودة فقط
        const codesString = missingCodes.join(',');
        const data = await fetchApiWithRetry('/file/info', { file_code: codesString });
        
        console.log('نتيجة جلب معلومات الملفات:', data);
        
        // تخزين النتائج الجديدة في الذاكرة المؤقتة
        if (data && data.result && Array.isArray(data.result)) {
            data.result.forEach(file => {
                if (file && file.file_code) {
                    fileInfoCache.set(file.file_code, {
                        data: { result: [file] },
                        timestamp: Date.now()
                    });
                }
            });
        }
        
        // دمج النتائج من الذاكرة المؤقتة والنتائج الجديدة
        const allResults = [...cachedResults, ...(data.result || [])];
        return { result: allResults };
    } catch (error) {
        console.error('Error fetching multiple files info:', error);
        // في حالة الخطأ، نعود بالبيانات من الذاكرة المؤقتة فقط
        return { result: cachedResults };
    }
}

// دالة محسنة لحساب الحجم الإجمالي للمجلد وعدد المشاهدات
async function calculateFolderStats(folderId) {
    try {
        // جلب محتويات المجلد
        const response = await fetchFiles(folderId);
        const folders = response.result.folders || [];
        const files = response.result.files || [];
        
        let totalSize = 0;
        let filesCount = files.length;
        let foldersCount = folders.length;
        let totalViews = 0;

        // حساب حجم الملفات في المجلد الحالي وعدد المشاهدات
        if (files.length > 0) {
            // جمع معرفات الملفات لاستدعاء واحد
            const fileCodes = files.map(f => f.file_code);
            
            try {
                // جلب معلومات مفصلة عن جميع الملفات مرة واحدة
                const filesInfo = await fetchMultipleFilesInfo(fileCodes);
                
                if (filesInfo && filesInfo.result) {
                    // حساب الحجم الإجمالي وعدد المشاهدات لجميع الملفات
                    for (const fileInfo of filesInfo.result) {
                        if (fileInfo.file_sizes && Array.isArray(fileInfo.file_sizes)) {
                            totalSize += fileInfo.file_sizes.reduce((sum, sizeInfo) => 
                                sum + (parseInt(sizeInfo.size) || 0), 0);
                        }
                        // جمع عدد المشاهدات - استخدام البيانات المفصلة
                        totalViews += parseInt(fileInfo.views || 0);
                    }
                }
            } catch (error) {
                console.error('Error fetching detailed file info:', error);
                // إذا فشل الاستدعاء الجماعي، نجرب ملفاً ملفاً
                for (const file of files) {
                    try {
                        const fileInfo = await fetchFileInfo(file.file_code);
                        if (fileInfo.result && fileInfo.result[0]) {
                            const detailedFile = fileInfo.result[0];
                            if (detailedFile.file_sizes) {
                                totalSize += detailedFile.file_sizes.reduce((sum, sizeInfo) => 
                                    sum + (parseInt(sizeInfo.size) || 0), 0);
                            }
                            // جمع عدد المشاهدات
                            totalViews += parseInt(detailedFile.views || 0);
                        }
                    } catch (fileError) {
                        console.warn('Failed to get file info:', file.file_code, fileError);
                        // استخدام البيانات الأساسية كبديل
                        totalViews += parseInt(file.views || 0);
                    }
                }
            }
        }

        // حساب حجم المجلدات الفرعية وعدد المشاهدات بشكل متكرر
        for (const folder of folders) {
            const subfolderData = await calculateFolderStats(folder.fld_id);
            totalSize += subfolderData.totalSize;
            foldersCount += subfolderData.foldersCount;
            filesCount += subfolderData.filesCount;
            totalViews += subfolderData.totalViews;
        }

        return {
            totalSize,
            filesCount,
            foldersCount,
            totalViews
        };
    } catch (error) {
        console.error('خطأ في حساب إحصائيات المجلد:', folderId, error);
        return {
            totalSize: 0,
            filesCount: 0,
            foldersCount: 0,
            totalViews: 0
        };
    }
}

// دالة جديدة لحساب إجمالي عدد المجلدات
async function calculateTotalFolders() {
    try {
        // جلب جميع المجلدات من المستوى الأعلى
        const response = await fetchFiles(0);
        let totalFolders = response.result.folders?.length || 0;
        
        // حساب المجلدات الفرعية بشكل متكرر
        async function countSubfolders(folderId) {
            const folderData = await fetchFiles(folderId);
            const subfolders = folderData.result.folders || [];
            let count = subfolders.length;
            
            for (const folder of subfolders) {
                count += await countSubfolders(folder.fld_id);
            }
            
            return count;
        }
        
        // حساب جميع المجلدات الفرعية
        for (const folder of response.result.folders || []) {
            totalFolders += await countSubfolders(folder.fld_id);
        }
        
        return totalFolders;
    } catch (error) {
        console.error('خطأ في حساب إجمالي المجلدات:', error);
        return 0;
    }
}

// ===========================
// START: دوال تحميل الملفات الجديدة
// ===========================

// دالة لعرض نافذة تحميل الملفات
function showUploadModal() {
    closeAllModals();
    
    const modalHtml = `
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-100 backdrop-blur-sm">
            <div class="folder-modal modal-card rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] border border-gray-700 overflow-hidden upload-modal-content">
                <!-- Header -->
                <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-cyan-500 bg-opacity-20 rounded-lg">
                            <i data-lucide="upload" class="w-6 h-6 text-cyan-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">تحميل الملفات</h3>
                            <p class="text-sm text-gray-400">رفع الملفات من جهازك أو التحميل عن بعد</p>
                        </div>
                    </div>
                    <button onclick="closeModal(this)" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-700 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="upload-tabs">
                    <div class="upload-tab active" data-tab="file-upload">
                        <i data-lucide="upload" class="w-5 h-5 mx-auto mb-1"></i>
                        <span>رفع ملفات</span>
                    </div>
                    <div class="upload-tab" data-tab="remote-upload">
                        <i data-lucide="link" class="w-5 h-5 mx-auto mb-1"></i>
                        <span>تحميل عن بعد</span>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-5 flex-1 overflow-y-auto">
                    <!-- File Upload Tab -->
                    <div id="file-upload" class="upload-tab-content active">
                        <div class="file-drop-area" id="file-drop-area">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto"></i>
                            <h4 class="text-lg font-semibold text-white mb-2">اسحب وأفلت الملفات هنا</h4>
                            <p class="text-gray-400 mb-4">أو انقر لاختيار الملفات</p>
                            <button class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-lg transition-colors">
                                اختيار الملفات
                            </button>
                            <input type="file" id="file-input" class="file-input" multiple accept="video/*">
                        </div>

                        <div class="file-list" id="file-list">
                            <!-- سيتم إضافة الملفات المختارة هنا -->
                        </div>

                        <div class="upload-status hidden" id="file-upload-status">
                            <!-- سيتم عرض حالة التحميل هنا -->
                        </div>
                    </div>

                    <!-- Remote Upload Tab -->
                    <div id="remote-upload" class="upload-tab-content">
                        <div class="url-upload-form">
                            <input 
                                type="url" 
                                id="remote-url"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                placeholder="أدخل رابط الفيديو..."
                            >
                            <button 
                                onclick="addRemoteUrl()"
                                class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-3 rounded-lg transition-colors"
                            >
                                إضافة
                            </button>
                        </div>

                        <div class="url-list" id="url-list">
                            <!-- سيتم إضافة الروابط هنا -->
                        </div>

                        <div class="upload-status hidden" id="remote-upload-status">
                            <!-- سيتم عرض حالة التحميل هنا -->
                        </div>
                    </div>

                    <!-- Folder Selection -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">المجلد الهدف</label>
                        <div class="flex items-center gap-3">
                            <div id="selected-upload-folder-path" class="flex-1 text-sm text-gray-200">
                                <span class="folder-path-pill" id="upload-folder-path-pill">المجلد الرئيسي</span>
                            </div>
                            <input type="hidden" id="upload-folder-id" value="0">
                            <button type="button" onclick="openFolderBrowserForUpload()" class="choose-folder-btn">
                                اختر
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-gray-700 bg-gray-750 rounded-b-2xl">
                    <div class="modal-footer-buttons">
                        <button 
                            onclick="closeModal(this)"
                            class="flex-1 px-3 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-all font-medium text-sm"
                        >
                            إلغاء
                        </button>
                        <button 
                            id="start-upload-btn"
                            onclick="startUpload()"
                            class="flex-1 px-3 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all font-medium text-sm shadow-lg shadow-cyan-500/25"
                        >
                            <span class="flex items-center justify-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                بدء التحميل
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    lucide.createIcons();
    
    // إعداد event listeners للألسنة
    setupUploadTabs();
    
    // إعداد event listeners لسحب وإفلات الملفات
    setupFileDropArea();
    
    // إعداد event listener لاختيار الملفات
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
}

// دالة لإعداد الألسنة في نافذة التحميل
function setupUploadTabs() {
    const tabs = document.querySelectorAll('.upload-tab');
    const tabContents = document.querySelectorAll('.upload-tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // إزالة النشاط من جميع الألسنة
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // إضافة النشاط للسان المحدد
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
}

// دالة لإعداد منطقة سحب وإفلات الملفات
function setupFileDropArea() {
    const dropArea = document.getElementById('file-drop-area');
    const fileInput = document.getElementById('file-input');
    
    // النقر على المنطقة لفتح نافذة اختيار الملفات
    dropArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // منع السلوك الافتراضي لمنع فتح الملف في المتصفح
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    // إضافة تأثيرات للسحب
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    // التعامل مع إسقاط الملفات
    dropArea.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        dropArea.classList.add('dragover');
    }
    
    function unhighlight() {
        dropArea.classList.remove('dragover');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
}

// دالة للتعامل مع اختيار الملفات
function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

// دالة للتعامل مع الملفات المختارة
function handleFiles(files) {
    uploadFiles = [];
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        uploadFiles.push({
            file: file,
            name: file.name,
            size: file.size,
            progress: 0,
            status: 'pending'
        });
    }
    
    updateFileList();
}

// دالة لتحديث قائمة الملفات
function escapeHtml(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function updateFileList(){
  const fileList = document.getElementById('file-list');
  if(!uploadFiles || uploadFiles.length === 0){
    fileList.innerHTML = '<p class="text-gray-400 text-center py-4">لم يتم اختيار ملفات</p>';
    return;
  }

  fileList.innerHTML = uploadFiles
    .map((file, index) => {
      if (typeof file.progress !== 'number') file.progress = 0;
      const sizeText = (typeof formatBytes === 'function') ? formatBytes(file.size) : (file.size ? (file.size + 'B') : '0B');
      return `
      <div class="file-item-upload">
        <div class="file-info">
          <div class="font-medium text-white">${escapeHtml(file.name)}</div>
          <div class="text-sm text-gray-400">${sizeText}</div>
        </div>
        <div class="progress-bar" style="width: ${file.progress}%"></div>
        <div class="file-actions">
          <button onclick="removeFile(${index})" class="text-red-400 hover:text-red-300">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>`;
    })
    .join(''); // <-- مهم: join('') وليس join()

  if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
}

// دالة لإزالة ملف من القائمة
function removeFile(index) {
  uploadFiles.splice(index, 1);
  updateFileList();
}

// دالة محسنة لإضافة رابط تحميل عن بعد مع آلية التحقق المحسنة
function addRemoteUrl() {
    const urlInput = document.getElementById('remote-url');
    const url = urlInput.value.trim();
    
    if (!url) {
        showNotification('يرجى إدخال رابط صحيح', 'error');
        return;
    }
    
    // التحقق من صحة الرابط
    if (!isValidUrl(url)) {
        showNotification('يرجى إدخال رابط صحيح', 'error');
        return;
    }
    
    // إضافة الرابط إلى القائمة مع حالة "جاري التحقق"
    const newUrlItem = {
        url: url,
        status: 'validating',
        filecode: null,
        progress: 0,
        fileInfo: null,
        validationStatus: 'pending'
    };
    
    remoteUploadUrls.push(newUrlItem);
    urlInput.value = '';
    updateUrlList();
    
    // بدء عملية التحقق من الرابط
    validateRemoteUrl(newUrlItem, remoteUploadUrls.length - 1);
}

// دالة محسنة للتحقق من الرابط قبل التحميل - تم تحسينها لاستخراج معلومات أكثر دقة
async function validateRemoteUrl(urlItem, index) {
    try {
        // تحديث الحالة إلى "جاري التحقق"
        remoteUploadUrls[index].validationStatus = 'validating';
        updateUrlList();
        
        // محاكاة عملية التحقق مع شريط تقدم
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 20;
                remoteUploadUrls[index].progress = Math.min(progress, 90);
                updateUrlList();
            }
        }, 300);
        
        // استدعاء API حقيقي للتحقق من الرابط والحصول على معلومات الملف
        const fileInfo = await fetchRemoteFileInfo(urlItem.url);
        
        clearInterval(progressInterval);
        
        if (fileInfo && fileInfo.file_title) {
            // تم التحقق بنجاح
            remoteUploadUrls[index].validationStatus = 'validated';
            remoteUploadUrls[index].progress = 100;
            remoteUploadUrls[index].fileInfo = fileInfo;
            remoteUploadUrls[index].status = 'pending';
            
            showNotification('تم التحقق من الرابط بنجاح', 'success');
        } else {
            // فشل التحقق - محاولة الحصول على معلومات أساسية من الرابط مباشرة
            const basicInfo = await getBasicFileInfoFromUrl(urlItem.url);
            if (basicInfo) {
                remoteUploadUrls[index].validationStatus = 'validated';
                remoteUploadUrls[index].progress = 100;
                remoteUploadUrls[index].fileInfo = basicInfo;
                remoteUploadUrls[index].status = 'pending';
                showNotification('تم التحقق من الرابط باستخدام المعلومات الأساسية', 'success');
            } else {
                remoteUploadUrls[index].validationStatus = 'validation_failed';
                remoteUploadUrls[index].status = 'error';
                showNotification('فشل في التحقق من الرابط', 'error');
            }
        }
        
        updateUrlList();
        
    } catch (error) {
        console.error('Error validating URL:', error);
        
        // محاولة استخدام المعلومات الأساسية كحل بديل
        try {
            const basicInfo = await getBasicFileInfoFromUrl(urlItem.url);
            if (basicInfo) {
                remoteUploadUrls[index].validationStatus = 'validated';
                remoteUploadUrls[index].progress = 100;
                remoteUploadUrls[index].fileInfo = basicInfo;
                remoteUploadUrls[index].status = 'pending';
                showNotification('تم التحقق من الرابط باستخدام المعلومات الأساسية', 'success');
            } else {
                remoteUploadUrls[index].validationStatus = 'validation_failed';
                remoteUploadUrls[index].status = 'error';
                showNotification('حدث خطأ أثناء التحقق من الرابط: ' + error.message, 'error');
            }
        } catch (fallbackError) {
            remoteUploadUrls[index].validationStatus = 'validation_failed';
            remoteUploadUrls[index].status = 'error';
            showNotification('حدث خطأ أثناء التحقق من الرابط: ' + error.message, 'error');
        }
        
        updateUrlList();
    }
}

// دالة جديدة لجلب معلومات الملف من الرابط عن بعد باستخدام API
async function fetchRemoteFileInfo(url) {
    try {
        const params = {
            url: url
        };
        
        const response = await fetchApiWithRetry('/upload/url_info', params);
        
        if (response.status === 200 && response.result) {
            return {
                file_title: response.result.file_title || extractFileNameFromUrl(url),
                file_sizes: response.result.file_sizes || [],
                duration: response.result.duration || '0',
                file_size: response.result.file_size || '0',
                file_code: response.result.file_code || null
            };
        } else {
            throw new Error(response.msg || 'Failed to get file info');
        }
    } catch (error) {
        console.error('Error fetching remote file info:', error);
        
        // إذا فشل الاستدعاء، نستخدم البيانات الوهمية كحل بديل
        return getMockFileInfoFromUrl(url);
    }
}

// دالة جديدة للحصول على معلومات أساسية من الرابط مباشرة
async function getBasicFileInfoFromUrl(url) {
    try {
        // استخدام fetch مع طريقة HEAD للحصول على المعلومات الأساسية فقط
        const response = await fetch(url, { method: 'HEAD' });
        
        if (response.ok) {
            const contentLength = response.headers.get('content-length');
            const contentType = response.headers.get('content-type');
            
            const fileName = extractFileNameFromUrl(url);
            const fileSize = contentLength ? parseInt(contentLength) : 0;
            
            return {
                file_title: fileName,
                file_sizes: [
                    { name: 'مباشر', size: fileSize.toString() }
                ],
                duration: '0',
                file_size: fileSize.toString(),
                file_code: generateMockFileCode()
            };
        }
    } catch (error) {
        console.error('Error getting basic file info:', error);
    }
    
    return null;
}

// دالة محاكاة للحصول على معلومات الملف من الرابط (تُستخدم فقط إذا فشل API الحقيقي)
async function getMockFileInfoFromUrl(url) {
    // محاكاة تأخير الشبكة
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // محاكاة معلومات الملف بناءً على الرابط
    const fileName = extractFileNameFromUrl(url);
    const fileSize = Math.floor(Math.random() * 500000000) + 1000000; // بين 1MB و 500MB
    const duration = Math.floor(Math.random() * 3600) + 60; // بين 1 دقيقة و 1 ساعة
    
    return {
        file_title: fileName,
        file_sizes: [
            { name: '720p', size: fileSize.toString() },
            { name: '480p', size: Math.floor(fileSize * 0.7).toString() },
            { name: '360p', size: Math.floor(fileSize * 0.5).toString() }
        ],
        duration: duration.toString(),
        file_size: fileSize.toString(),
        file_code: generateMockFileCode()
    };
}

// دالة مساعدة لإنشاء كود ملف وهمي
function generateMockFileCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// دالة محسنة لاستخراج اسم الملف من الرابط
function extractFileNameFromUrl(url) {
    try {
        const urlObj = new URL(url);
        const pathname = urlObj.pathname;
        
        // محاولة استخراج اسم الملف من المسار
        let fileName = pathname.split('/').pop() || 'ملف_فيديو';
        
        // إزالة المعلمات من اسم الملف إذا وجدت
        fileName = fileName.split('?')[0];
        fileName = fileName.split('#')[0];
        
        // فك تشفير الاسم إذا كان مشفراً
        fileName = decodeURIComponent(fileName);
        
        // إزالة الامتداد للحصول على العنوان الأساسي
        const baseName = fileName.replace(/\.[^/.]+$/, "");
        
        // إذا لم يكن هناك اسم، نستخدم اسم افتراضي
        return baseName || 'ملف_فيديو';
    } catch (e) {
        return 'ملف_فيديو';
    }
}

// دالة للتحقق من صحة الرابط
function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

// دالة محسنة لتحديث قائمة الروابط مع إضافة حالة التحقق والمعلومات الحقيقية
function updateUrlList() {
    const urlList = document.getElementById('url-list');
    
    if (remoteUploadUrls.length === 0) {
        urlList.innerHTML = '<p class="text-gray-400 text-center py-4">لم يتم إضافة أي روابط</p>';
        return;
    }
    
    urlList.innerHTML = remoteUploadUrls.map((item, index) => {
        let statusText = '';
        let progressBar = '';
        let fileDetails = '';
        let validationStatus = '';
        
        // حالة التحقق من الرابط
        if (item.validationStatus === 'validating') {
            statusText = 'جاري التحقق من الرابط...';
            validationStatus = `
                <div class="validation-status validating">
                    <div class="validation-step">
                        <div class="step-icon">
                            <i data-lucide="shield" class="w-4 h-4"></i>
                        </div>
                        <div class="step-text">
                            <span>جاري التحقق من الرابط</span>
                            <div class="progress-bar mini">
                                <div class="progress-bar-fill" style="width: ${item.progress}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (item.validationStatus === 'validated') {
            statusText = 'تم التحقق بنجاح - جاهز للتحميل';
            
            // عرض المعلومات الحقيقية بعد التحقق
            const fileTitle = item.fileInfo?.file_title || 'غير معروف';
            const fileSize = item.fileInfo?.file_size ? formatBytes(parseInt(item.fileInfo.file_size)) : 'غير معروف';
            const fileCode = item.fileInfo?.file_code || 'في انتظار التحميل';
            
            validationStatus = `
                <div class="validation-status validated">
                    <div class="validation-step completed">
                        <div class="step-icon">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                        </div>
                        <div class="step-text">
                            <span>تم التحقق بنجاح</span>
                        </div>
                    </div>
                    <div class="file-info-preview">
                        <div class="file-info-item">
                            <i data-lucide="file-text" class="w-3 h-3"></i>
                            <span>العنوان: ${fileTitle}</span>
                        </div>
                        <div class="file-info-item">
                            <i data-lucide="hash" class="w-3 h-3"></i>
                            <span>الكود: ${fileCode}</span>
                        </div>
                        <div class="file-info-item">
                            <i data-lucide="database" class="w-3 h-3"></i>
                            <span>الحجم: ${fileSize}</span>
                        </div>
                    </div>
                </div>
            `;
        } else if (item.validationStatus === 'validation_failed') {
            statusText = 'فشل في التحقق من الرابط';
            validationStatus = `
                <div class="validation-status failed">
                    <div class="validation-step failed">
                        <div class="step-icon">
                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                        </div>
                        <div class="step-text">
                            <span>فشل في التحقق من الرابط</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // حالة التحميل
        switch (item.status) {
            case 'pending':
                if (item.validationStatus !== 'validating') {
                    statusText = 'في انتظار التحميل';
                }
                break;
            case 'uploading':
                statusText = 'جاري التحميل...';
                progressBar = `
                    <div class="progress-bar mt-2">
                        <div class="progress-bar-fill" style="width: ${item.progress}%"></div>
                    </div>
                `;
                break;
            case 'completed':
                statusText = 'تم التحميل بنجاح';
                if (item.fileInfo) {
                    const fileSize = item.fileInfo.file_sizes ? 
                        formatBytes(item.fileInfo.file_sizes.reduce((sum, size) => sum + (parseInt(size.size) || 0), 0)) : 
                        'غير معروف';
                    fileDetails = `
                        <div class="file-details mt-2 p-2 bg-gray-700 rounded">
                            <div class="text-sm text-white">${item.fileInfo.file_title || 'بدون عنوان'}</div>
                            <div class="text-xs text-gray-400">الحجم: ${fileSize}</div>
                            <div class="text-xs text-cyan-400">الكود: ${item.filecode}</div>
                            <button class="download-btn mt-1 bg-cyan-500 hover:bg-cyan-600 text-white px-2 py-1 rounded text-xs" onclick="downloadFile('${item.filecode}')">
                                تحميل
                            </button>
                            <div class="progress-bar mt-2">
                                <div class="progress-bar-fill" style="width: 100%"></div>
                            </div>
                        </div>
                    `;
                } else {
                    fileDetails = `
                        <div class="file-details mt-2 p-2 bg-gray-700 rounded">
                            <div class="text-sm text-white">تم التحميل: ${item.filecode}</div>
                            <div class="text-xs text-gray-400">جاري جلب المعلومات...</div>
                        </div>
                    `;
                }
                break;
            case 'error':
                statusText = 'فشل في التحميل';
                break;
        }
        
        return `
            <div class="url-item">
                <div class="url-info">
                    <div class="font-medium text-white">${item.url}</div>
                    <div class="url-status">${statusText}</div>
                    ${validationStatus}
                    ${progressBar}
                    ${fileDetails}
                </div>
                <div class="url-actions">
                    <button onclick="removeUrl(${index})" class="text-red-400 hover:text-red-300">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    lucide.createIcons();
}

// دالة لإزالة رابط من القائمة
function removeUrl(index) {
    remoteUploadUrls.splice(index, 1);
    updateUrlList();
}

// دالة لفتح نافذة اختيار المجلد للتحميل
async function openFolderBrowserForUpload() {
    closeAllModals();
    
    // إعادة تعيين حالة المتصغير
    currentFolderBrowserState = {
        currentFolderId: 0,
        breadcrumbs: [{ id: 0, name: 'المجلد الرئيسي' }],
        selectedFolder: null
    };
    
    await renderFolderBrowserForUpload();
}

// دالة لعرض نافذة تصفح المجلدات للتحميل
async function renderFolderBrowserForUpload() {
    const { currentFolderId, breadcrumbs } = currentFolderBrowserState;
    
    try {
        // جلب محتويات المجلد الحالي
        const response = await fetchFiles(currentFolderId);
        const folders = response.result.folders || [];
        
        const modalId = `folder-browser-upload-${Date.now()}`;
        
        // إنشاء breadcrumbs HTML
        const breadcrumbsHtml = breadcrumbs.map((crumb, index) => `
            <span class="breadcrumb-item ${index === breadcrumbs.length - 1 ? 'text-cyan-400 font-bold' : ''}" 
                  onclick="navigateToFolderInBrowserForUpload(${crumb.id}, ${index})">
                ${crumb.name}
            </span>
            ${index < breadcrumbs.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ''}
        `).join('');
        
        const modalHtml = `
            <div id="${modalId}" class="folder-browser-modal fixed inset-0 flex items-center justify-center p-4 z-102">
                <div class="folder-browser-content rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
                    <div class="folder-browser-header flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-white mb-2">اختر مجلد التحميل</h4>
                            <div class="text-sm text-gray-300">
                                ${breadcrumbsHtml}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-white p-2 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="folder-browser-body">
                        ${folders.length === 0 ? `
                            <div class="text-center py-12">
                                <i data-lucide="folder-open" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                                <p class="text-gray-400 text-lg">لا توجد مجلدات هنا</p>
                            </div>` : ''}
                        <div class="space-y-2">
                            ${folders.map(f => `
                                <div class="folder-browser-item flex items-center justify-between p-4 cursor-pointer rounded-lg border border-gray-700 hover:border-cyan-500 transition-colors ${currentFolderBrowserState.selectedFolder?.id === f.fld_id ? 'active' : ''}" 
                                     onclick="selectFolderInBrowserForUpload(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="folder" class="w-6 h-6 text-cyan-400"></i>
                                        <div class="text-sm">
                                            <div class="font-semibold text-gray-200">${f.name}</div>
                                            <div class="text-gray-400 text-xs mt-1">انقر لتحديد هذا المجلد</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="event.stopPropagation(); navigateToSubfolderForUpload(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')" class="open-folder-btn">
                                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                                            فتح
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="folder-browser-footer flex justify-between items-center">
                        <div class="text-gray-300">
                            ${currentFolderBrowserState.selectedFolder ? 
                                `المجلد المحدد: <span class="text-cyan-400 font-bold">${currentFolderBrowserState.selectedFolder.name}</span>` : 
                                'لم يتم تحديد أي مجلد'}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 border border-gray-600 text-gray-300 rounded-xl hover:bg-gray-700 transition-all font-medium">
                                إلغاء
                            </button>
                            <button onclick="confirmFolderSelectionForUpload('${modalId}')" class="choose-folder-btn" ${!currentFolderBrowserState.selectedFolder ? 'disabled' : ''}>
                                تأكيد الاختيار
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        lucide.createIcons();
    } catch (error) {
        console.error('Error rendering folder browser for upload:', error);
        showNotification('فشل في جلب المجلدات', 'error');
    }
}

// دالة للانتقال إلى مجلد فرعي للتحميل
async function navigateToSubfolderForUpload(folderId, folderName) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs.push({ id: folderId, name: folderName });
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowserForUpload();
}

// دالة للانتقال إلى مجلد في breadcrumb للتحميل
async function navigateToFolderInBrowserForUpload(folderId, breadcrumbIndex) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs = currentFolderBrowserState.breadcrumbs.slice(0, breadcrumbIndex + 1);
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowserForUpload();
}

// دالة لتحديد مجلد في المتصغير للتحميل
function selectFolderInBrowserForUpload(folderId, folderName) {
    currentFolderBrowserState.selectedFolder = { id: folderId, name: folderName };
    
    // إعادة عرض المتصغير لتحديث حالة التحديد
    const currentModal = document.querySelector('.folder-browser-modal');
    if (currentModal) {
        currentModal.remove();
        renderFolderBrowserForUpload();
    }
}

// دالة لتأكيد اختيار المجلد للتحميل
function confirmFolderSelectionForUpload(modalId) {
    if (!currentFolderBrowserState.selectedFolder) {
        showNotification('يرجى تحديد مجلد أولاً', 'error');
        return;
    }
    
    const { id, name } = currentFolderBrowserState.selectedFolder;
    
    // بناء المسار الكامل للمجلد
    const breadcrumbs = currentFolderBrowserState.breadcrumbs;
    const currentFolderIndex = breadcrumbs.findIndex(b => b.id === id);
    let path = '';
    
    if (currentFolderIndex !== -1) {
        path = breadcrumbs.slice(0, currentFolderIndex + 1).map(b => b.name).join(' / ');
    } else {
        // إذا كان المجلد المحدد ليس في breadcrumb الحالي، نضيفه
        path = [...breadcrumbs.map(b => b.name), name].join(' / ');
    }
    
    // تحديث الحقول في نموذج التحميل
    setUploadFolder({ id, path });
    
    // إغلاق النافذة
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
}

// دالة لتحديد مجلد التحميل
function setUploadFolder({ id, path }) {
    const input = document.getElementById('upload-folder-id');
    const pill = document.getElementById('upload-folder-path-pill');
    if (input) input.value = id;
    if (pill) pill.textContent = path || 'المجلد الرئيسي';
}

// دالة محسنة لبدء عملية التحميل مع التحقق من الروابط أولاً
async function startUpload() {
    const folderId = document.getElementById('upload-folder-id').value;
    const activeTab = document.querySelector('.upload-tab.active').getAttribute('data-tab');
    
    if (activeTab === 'file-upload') {
        await startFileUpload(folderId);
    } else {
        await startRemoteUpload(folderId);
    }
}

// دالة لبدء تحميل الملفات
async function startFileUpload(folderId) {
    if (uploadFiles.length === 0) {
        showNotification('لم يتم اختيار أي ملفات للتحميل', 'error');
        return;
    }
    
    try {
        // الحصول على خادم التحميل
        const uploadServerResponse = await fetchApiWithRetry('/upload/server');
        currentUploadServer = uploadServerResponse.result;
        
        const statusElement = document.getElementById('file-upload-status');
        statusElement.classList.remove('hidden');
        statusElement.className = 'upload-status info';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="info" class="w-5 h-5 text-cyan-400"></i>
                <div>
                    <p class="font-medium text-white">جاري تحميل ${uploadFiles.length} ملف...</p>
                    <p class="text-sm text-gray-400">يرجى الانتظار</p>
                </div>
            </div>
        `;
        
        // تحميل كل ملف على حدة
        for (let i = 0; i < uploadFiles.length; i++) {
            const fileData = uploadFiles[i];
            await uploadFile(fileData, folderId, i);
        }
        
        statusElement.className = 'upload-status success';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                <div>
                    <p class="font-medium text-white">تم تحميل جميع الملفات بنجاح</p>
                    <p class="text-sm text-gray-400">سيتم تحديث قائمة الملفات قريباً</p>
                </div>
            </div>
        `;
        
        // إعادة تحميل الملفات بعد التحميل
        setTimeout(() => {
            if (typeof window.loadFiles === 'function') {
                window.loadFiles(state.currentFolderId);
            }
        }, 2000);
        
    } catch (error) {
        console.error('Error starting file upload:', error);
        const statusElement = document.getElementById('file-upload-status');
        statusElement.className = 'upload-status error';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-medium text-white">فشل في تحميل الملفات</p>
                    <p class="text-sm text-gray-400">${error.message}</p>
                </div>
            </div>
        `;
    }
}

// دالة لتحميل ملف واحد
async function uploadFile(fileData, folderId, index) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('key', API_KEY);
        formData.append('file', fileData.file);
        formData.append('fld_id', folderId);
        
        const xhr = new XMLHttpRequest();
        
        // تحديث التقدم
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                uploadFiles[index].progress = percentComplete;
                updateFileList();
            }
        });
        
        // عند اكتمال التحميل
        xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.status === 200) {
                        uploadFiles[index].status = 'completed';
                        updateFileList();
                        resolve(response);
                    } else {
                        uploadFiles[index].status = 'error';
                        updateFileList();
                        reject(new Error(response.msg || 'Upload failed'));
                    }
                } catch (e) {
                    uploadFiles[index].status = 'error';
                    updateFileList();
                    reject(new Error('Failed to parse response'));
                }
            } else {
                uploadFiles[index].status = 'error';
                updateFileList();
                reject(new Error(`Upload failed with status: ${xhr.status}`));
            }
        });
        
        // عند حدوث خطأ
        xhr.addEventListener('error', () => {
            uploadFiles[index].status = 'error';
            updateFileList();
            reject(new Error('Upload failed'));
        });
        
        xhr.open('POST', currentUploadServer);
        xhr.send(formData);
    });
}

// دالة جديدة للانتظار حتى تصبح معلومات الملف متاحة
async function waitForFileInfo(filecode, maxAttempts = 10) {
    for (let i = 0; i < maxAttempts; i++) {
        try {
            const fileInfo = await fetchFileInfo(filecode);
            if (fileInfo.result && fileInfo.result[0] && fileInfo.result[0].file_title) {
                return fileInfo.result[0];
            }
        } catch (error) {
            console.warn(`Attempt ${i+1}: File info not available yet for ${filecode}`);
        }
        await new Promise(resolve => setTimeout(resolve, 3000)); // انتظر 3 ثواني قبل المحاولة مرة أخرى
    }
    throw new Error('File info not available after multiple attempts');
}

// دالة محسنة لبدء التحميل عن بعد مع التحقق أولاً
async function startRemoteUpload(folderId) {
    if (remoteUploadUrls.length === 0) {
        showNotification('لم يتم إضافة أي روابط للتحميل', 'error');
        return;
    }
    
    // التحقق من أن جميع الروابط تم التحقق منها بنجاح
    const unvalidatedUrls = remoteUploadUrls.filter(item => item.validationStatus !== 'validated');
    if (unvalidatedUrls.length > 0) {
        showNotification('يجب التحقق من جميع الروابط قبل البدء في التحميل', 'error');
        return;
    }
    
    try {
        const statusElement = document.getElementById('remote-upload-status');
        statusElement.classList.remove('hidden');
        statusElement.className = 'upload-status info';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="info" class="w-5 h-5 text-cyan-400"></i>
                <div>
                    <p class="font-medium text-white">جاري تحميل ${remoteUploadUrls.length} رابط...</p>
                    <p class="text-sm text-gray-400">يرجى الانتظار</p>
                </div>
            </div>
        `;
        
        // تحميل كل رابط على حدة
        for (let i = 0; i < remoteUploadUrls.length; i++) {
            const urlData = remoteUploadUrls[i];
            // تحديث الحالة إلى 'uploading'
            remoteUploadUrls[i].status = 'uploading';
            updateUrlList();
            
            await uploadRemoteUrl(urlData, folderId, i);
        }
        
        statusElement.className = 'upload-status success';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                <div>
                    <p class="font-medium text-white">تم بدء تحميل جميع الروابط</p>
                    <p class="text-sm text-gray-400">سيتم تحديث قائمة الملفات قريباً</p>
                </div>
            </div>
        `;
        
        // إعادة تحميل الملفات بعد التحميل
        setTimeout(() => {
            if (typeof window.loadFiles === 'function') {
                window.loadFiles(state.currentFolderId);
            }
        }, 3000);
        
    } catch (error) {
        console.error('Error starting remote upload:', error);
        const statusElement = document.getElementById('remote-upload-status');
        statusElement.className = 'upload-status error';
        statusElement.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                <div>
                    <p class="font-medium text-white">فشل في تحميل الروابط</p>
                    <p class="text-sm text-gray-400">${error.message}</p>
                </div>
            </div>
        `;
    }
}

// دالة محسنة لتحميل رابط عن بعد مع شريط التقدم
async function uploadRemoteUrl(urlData, folderId, index) {
    try {
        const params = {
            url: urlData.url,
            fld_id: folderId
        };
        
        // محاكاة شريط التقدم
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 15;
                remoteUploadUrls[index].progress = Math.min(progress, 90);
                updateUrlList();
            }
        }, 500);
        
        const response = await fetchApiWithRetry('/upload/url', params);
        
        clearInterval(progressInterval);
        
        if (response.status === 200) {
            // تحديث التقدم إلى 100%
            remoteUploadUrls[index].progress = 100;
            remoteUploadUrls[index].filecode = response.result.filecode;
            
            // محاولة الحصول على معلومات الملف بعد التحميل
            try {
                showNotification('تم تحميل الرابط بنجاح', 'success');
                const fileInfo = await waitForFileInfo(response.result.filecode);
                remoteUploadUrls[index].status = 'completed';
                remoteUploadUrls[index].fileInfo = fileInfo;
                updateUrlList();
                return { ...response, fileInfo };
            } catch (error) {
                remoteUploadUrls[index].status = 'completed'; // لكن بدون معلومات
                updateUrlList();
                return response;
            }
        } else {
            remoteUploadUrls[index].status = 'error';
            showNotification('فشل في تحميل الرابط', 'error');
            updateUrlList();
            throw new Error(response.msg || 'Remote upload failed');
        }
    } catch (error) {
        remoteUploadUrls[index].status = 'error';
        showNotification('فشل في تحميل الرابط', 'error');
        updateUrlList();
        throw error;
    }
}

// دالة لتحميل الملف
async function downloadFile(filecode) {
    try {
        showNotification('جاري تحضير رابط التحميل...', 'info');
        
        // الحصول على رابط التحميل المباشر
        const response = await fetchApiWithRetry('/file/direct_link', { 
            file_code: filecode,
            ip: '127.0.0.1' // يمكن استبدالها بعنوان IP المستخدم الفعلي
        });
        
        if (response.result && response.result.hls_direct) {
            // فتح الرابط في نافذة جديدة
            window.open(response.result.hls_direct, '_blank');
            showNotification('تم فتح رابط التحميل', 'success');
        } else {
            throw new Error('لم يتم العثور على رابط التحميل');
        }
    } catch (error) {
        console.error('Error downloading file:', error);
        showNotification('فشل في تحضير رابط التحميل', 'error');
    }
}

// ===========================
// END: دوال تحميل الملفات الجديدة
// ===========================

// ===========================
// START: دوال التحديث التلقائي الجديدة والمحسنة
// ===========================

// دالة لتفعيل أو إيقاف التحديث التلقائي
function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        startAutoRefresh();
        showNotification('تم تفعيل التحديث التلقائي', 'success');
        updateAutoRefreshButton(true);
    } else {
        stopAutoRefresh();
        showNotification('تم إيقاف التحديث التلقائي', 'info');
        updateAutoRefreshButton(false);
    }
}

// دالة لبدء التحديث التلقائي
function startAutoRefresh() {
    // إيقاف أي فاصل زمني سابق
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // بدء فاصل زمني جديد
    autoRefreshInterval = setInterval(() => {
        performAutoRefresh();
    }, autoRefreshIntervalTime);
    
    console.log(`تم بدء التحديث التلقائي كل ${autoRefreshIntervalTime / 1000} ثانية`);
}

// دالة لإيقاف التحديث التلقائي
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    console.log('تم إيقاف التحديث التلقائي');
}

// دالة تنفيذ التحديث التلقائي
function performAutoRefresh() {
    console.log('جاري التحديث التلقائي...');
    
    // تحديث شارة التحديث
    showRefreshBadge();
    
    // تحديث البيانات حسب الصفحة الحالية
    switch (state.currentPage) {
        case 'dashboard':
            refreshDashboard();
            break;
        case 'files':
            refreshFiles();
            break;
        case 'stats':
            refreshStats();
            break;
    }
    
    // تحديث وقت آخر تحديث
    updateLastRefreshTime();
}

// دالة تحديث لوحة التحكم
async function refreshDashboard() {
    try {
        console.log('تحديث لوحة التحكم...');
        
        // مسح الذاكرة المؤقتة للبيانات الديناميكية
        folderCache.delete('account-info');
        folderCache.delete('files-stats');
        
        // إعادة تحميل البيانات
        const dashboardCardsContainer = document.getElementById('dashboard-cards');
        if (dashboardCardsContainer) {
            const [accountInfo, accountStats, totalFolders, filesStats] = await Promise.all([
                fetchAccountInfo(),
                fetchAccountStats(),
                calculateTotalFolders(),
                fetchFilesStats()
            ]);
            
            renderDashboardCards(dashboardCardsContainer, accountInfo, accountStats, totalFolders, filesStats);
        }
    } catch (error) {
        console.error('فشل في تحديث لوحة التحكم:', error);
    }
}

// دالة تحديث صفحة الملفات
async function refreshFiles() {
    try {
        console.log('تحديث صفحة الملفات...');
        
        // مسح الذاكرة المؤقتة للمجلد الحالي فقط
        const currentFolderCacheKey = `files-${state.currentFolderId}`;
        folderCache.delete(currentFolderCacheKey);
        
        // إعادة تحميل الملفات إذا لم يكن هناك بحث نشط
        if (!currentSearchQuery && typeof window.loadFiles === 'function') {
            await window.loadFiles(state.currentFolderId);
        }
    } catch (error) {
        console.error('فشل في تحديث صفحة الملفات:', error);
    }
}

// دالة تحديث صفحة الإحصائيات - تم التحسين
async function refreshStats() {
    try {
        console.log('تحديث صفحة الإحصائيات...');
        
        // مسح الذاكرة المؤقتة للإحصائيات
        const statsCacheKey = `account-stats-${currentPeriod}`;
        folderCache.delete(statsCacheKey);
        
        // مسح ذاكرة التخزين المؤقت للملفات أيضاً
        fileInfoCache.clear();
        
        // إعادة تحميل الإحصائيات
        if (typeof window.loadStats === 'function') {
            await window.loadStats();
        }
        
        // إعادة حساب إحصائيات الملفات أيضاً
        await fetchFilesStats();
        
    } catch (error) {
        console.error('فشل في تحديث صفحة الإحصائيات:', error);
    }
}

// دالة تحديث زر التحديث التلقائي
function updateAutoRefreshButton(isEnabled) {
    const refreshButton = document.getElementById('auto-refresh-btn');
    const refreshIcon = document.getElementById('auto-refresh-icon');
    
    if (refreshButton && refreshIcon) {
        if (isEnabled) {
            refreshButton.classList.add('active');
            refreshIcon.dataset.lucide = 'refresh-cw';
            refreshButton.title = 'إيقاف التحديث التلقائي';
        } else {
            refreshButton.classList.remove('active');
            refreshIcon.dataset.lucide = 'refresh-cw-off';
            refreshButton.title = 'تفعيل التحديث التلقائي';
        }
        lucide.createIcons();
    }
}

// دالة عرض شارة التحديث
function showRefreshBadge() {
    // إنشاء أو تحديث شارة التحديث
    let badge = document.getElementById('refresh-badge');
    if (!badge) {
        badge = document.createElement('div');
        badge.id = 'refresh-badge';
        badge.className = 'refresh-badge';
        document.body.appendChild(badge);
    }
    
    badge.textContent = '🔄';
    badge.style.display = 'block';
    
    // إخفاء الشارة بعد ثانية
    setTimeout(() => {
        badge.style.display = 'none';
    }, 1000);
}

// دالة تحديث وقت آخر تحديث
function updateLastRefreshTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    
    // تحديث الوقت في الواجهة إذا كان هناك عنصر لعرضه
    const timeElement = document.getElementById('last-refresh-time');
    if (timeElement) {
        timeElement.textContent = `آخر تحديث: ${timeString}`;
    }
}

// دالة تغيير فاصل التحديث التلقائي
function changeAutoRefreshInterval(seconds) {
    autoRefreshIntervalTime = seconds * 1000;
    
    // إذا كان التحديث التلقائي مفعلاً، إعادة تشغيله بالفاصل الجديد
    if (autoRefreshEnabled) {
        startAutoRefresh();
    }
    
    showNotification(`تم ضبط التحديث التلقائي كل ${seconds} ثانية`, 'success');
}

// دالة إضافة عناصر التحكم بالتحديث التلقائي إلى الواجهة
function addAutoRefreshControls() {
    // البحث عن شريط التنقل لإضافة زر التحديث التلقائي
    const navContainer = document.querySelector('.nav-container');
    if (!navContainer) return;
    
    // التحقق إذا كان زر التحديث التلقائي موجوداً مسبقاً
    if (document.getElementById('auto-refresh-btn')) return;
    
    const refreshControlsHtml = `
        <div class="auto-refresh-controls">
            <button id="auto-refresh-btn" class="nav-btn" onclick="toggleAutoRefresh()" title="تفعيل التحديث التلقائي">
                <i data-lucide="refresh-cw-off" id="auto-refresh-icon" class="w-5 h-5"></i>
            </button>
            <div class="refresh-interval-dropdown">
                <button class="interval-btn" onclick="toggleIntervalDropdown()">
                    <span id="current-interval">30s</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                <div class="interval-dropdown-content">
                    <div class="interval-option" onclick="changeAutoRefreshInterval(15)">15 ثانية</div>
                    <div class="interval-option" onclick="changeAutoRefreshInterval(30)">30 ثانية</div>
                    <div class="interval-option" onclick="changeAutoRefreshInterval(60)">60 ثانية</div>
                    <div class="interval-option" onclick="changeAutoRefreshInterval(120)">2 دقيقة</div>
                    <div class="interval-option" onclick="changeAutoRefreshInterval(300)">5 دقائق</div>
                </div>
            </div>
            <div id="last-refresh-time" class="last-refresh-time">آخر تحديث: --:--:--</div>
        </div>
    `;
    
    navContainer.insertAdjacentHTML('beforeend', refreshControlsHtml);
    lucide.createIcons();
}

// دالة تبديل القائمة المنسدلة لفترات التحديث
function toggleIntervalDropdown() {
    const dropdown = document.querySelector('.interval-dropdown-content');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// إغلاق القائمة المنسدلة عند النقر خارجها
document.addEventListener('click', function(e) {
    if (!e.target.closest('.refresh-interval-dropdown')) {
        const dropdowns = document.querySelectorAll('.interval-dropdown-content');
        dropdowns.forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

// دالة محسنة للتحديث الفوري بعد تعديل المجلدات والملفات
function triggerImmediateRefresh() {
    console.log('تشغيل التحديث الفوري...');
    
    // مسح الذاكرة المؤقتة للبيانات المتعلقة بالملفات والمجلدات
    folderCache.clear();
    fileInfoCache.clear();
    
    // إجراء تحديث فوري للصفحة الحالية
    if (state.currentPage === 'files') {
        // تحديث فوري للملفات والمجلدات
        if (typeof window.loadFiles === 'function') {
            window.loadFiles(state.currentFolderId);
        }
    } else if (state.currentPage === 'dashboard') {
        // تحديث فوري للوحة التحكم
        refreshDashboard();
    } else if (state.currentPage === 'stats') {
        // تحديث فوري للإحصائيات
        refreshStats();
    }
    
    // تحديث وقت آخر تحديث
    updateLastRefreshTime();
    
    // إظهار شارة التحديث
    showRefreshBadge();
}

// ===========================
// END: دوال التحديث التلقائي الجديدة والمحسنة
// ===========================

// Utility Functions
let charts = {};

function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

// دالة جديدة لتنسيق التاريخ والوقت بالكامل
function formatDateTime(dateString) {
    if (!dateString || dateString === 'Invalid Date') {
        return 'غير معروف';
    }
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return 'غير معروف';
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    } catch (e) {
        return 'غير معروف';
    }
}

// New function to format video duration
function formatDuration(seconds) {
    if (!seconds || seconds === "0" || seconds === "غير معروف") return 'غير معروف';
    const totalSeconds = parseInt(seconds);
    if (isNaN(totalSeconds)) return 'غير معروف';
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// دالة لتنسيق تاريخ قصير للتسميات
function formatDateLabel(dateString, period) {
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        if (period <= 1) {
            // ساعة واحدة - تنسيق بالدقائق
            return date.toLocaleTimeString('ar-EG-u-nu-latn', { hour: '2-digit', minute: '2-digit' });
        } else if (period <= 24) {
            // أقل من أو يساوي 24 ساعة - تنسيق بالساعات
            return date.toLocaleTimeString('ar-EG-u-nu-latn', { hour: '2-digit' });
        } else if (period <= 30) {
            // أقل من أو يساوي 30 يوم - تنسيق بالأيام
            return date.toLocaleDateString('ar-EG-u-nu-latn', { month: 'short', day: 'numeric' });
        } else {
            // أكثر من 30 يوم - تنسيق بالأشهر
            return date.toLocaleDateString('ar-EG-u-nu-latn', { month: 'short', year: 'numeric' });
        }
    } catch (e) {
        return dateString;
    }
}

// دالة لضبط مقياس Y ديناميكياً
function adjustYScale(chart, dataArray) {
    const maxVal = Math.max(...dataArray, 0);
    let suggestedMax = Math.ceil(maxVal * 1.15); // 15% buffer
    if (suggestedMax === 0) suggestedMax = 1;
    
    chart.options.scales.y.suggestedMax = suggestedMax;
    chart.options.scales.y.beginAtZero = true;
}

// ===========================
// START: الدوال الجديدة للبحث المتقدم والتحديث التلقائي للرسم البياني
// ===========================

// دالة مسح البحث - تم التعديل لمنع الاختفاء المفاجئ
function clearSearch() {
    currentSearchQuery = '';
    document.getElementById('search-input').value = '';
    document.getElementById('search-input-list').value = '';
    
    // إعادة تعيين جميع المتغيرات المرتبطة بالبحث
    selectedFiles.clear();
    selectedFolders.clear();
    
    // تحديث واجهة المستخدم
    updateBulkActionsBar();
    updateFileSelectionUI();
    updateFolderSelectionUI();
    
    // إعادة تحميل المحتوى الأصلي للمجلد الحالي بدون إخفاء شريط البحث
    restoreOriginalFiles();
}

// دالة جديدة لاستعادة الملفات الأصلية بعد مسح البحث - تم التعديل
function restoreOriginalFiles() {
    // إعادة تعيين حالة البحث
    currentSearchQuery = '';
    
    // إظهار شريط البحث (لا نخفيه)
    const searchContainers = document.querySelectorAll('.search-container');
    searchContainers.forEach(container => {
        container.style.display = 'block';
    });
    
    // إعادة تحميل الملفات الأصلية
    if (typeof window.loadFiles === 'function') {
        window.loadFiles(state.currentFolderId);
    }
}

// دالة البحث عن الملفات والمجلدات - تم التعديل لضمان استعادة الحالة الافتراضية عند البحث الفارغ
async function searchFilesAndFolders(query) {
    const searchTerm = query.toLowerCase().trim();
    
    if (!searchTerm) {
        // إذا كان البحث فارغاً، إعادة العرض الافتراضي فوراً
        clearSearch();
        return;
    }
    
    currentSearchQuery = searchTerm;
    
    // إظهار حالة التحميل
    showSearchLoading();
    
    try {
        // استخدام البحث المتقدم
        const searchResults = await advancedSearch(searchTerm);
        
        // عرض النتائج
        displaySearchResults(searchResults, query);
    } catch (error) {
        console.error('Search error:', error);
        showNotification('حدث خطأ أثناء البحث', 'error');
        clearSearch();
    }
}

// دالة محسنة لعرض نتائج البحث
function displaySearchResults(results, query) {
    const { folders, files } = results;
    const totalResults = folders.length + files.length;
    
    // إخفاء المحتوى الأصلي تدريجياً
    const gridContainer = document.getElementById('files-grid-container');
    const listContainer = document.getElementById('files-list-container');
    
    // إضافة تأثير انتقالي سلس
    if (state.currentView === 'grid') {
        listContainer.classList.add('hidden');
        gridContainer.classList.remove('hidden');
        displaySearchResultsGrid(folders, files, query, totalResults);
    } else {
        gridContainer.classList.add('hidden');
        listContainer.classList.remove('hidden');
        displaySearchResultsList(folders, files, query, totalResults);
    }
    
    // إظهار رسالة إذا لم توجد نتائج
    if (totalResults === 0) {
        showNoResultsMessage(query);
    }
}

// دالة لعرض نتائج البحث في وضع الشبكة
async function displaySearchResultsGrid(folders, files, query, totalResults) {
    const foldersGrid = document.getElementById('folders-grid-container');
    const filesGrid = document.getElementById('files-grid-content');
    
    // عرض المجلدات التي تم العثور عليها
    if (folders.length > 0) {
        const foldersHtml = await Promise.all(folders.map(async folder => {
            const folderData = await calculateFolderStats(folder.fld_id);
            // استخدام createFolderItem المعدلة التي تأخذ بعين الاعتبار isSearch
            return createFolderItem({
                ...folder,
                showPath: true,
                isSearch: true
            }, 'grid', folderData);
        }));
        foldersGrid.innerHTML = foldersHtml.join('');
    } else {
        foldersGrid.innerHTML = '';
    }
    
    // عرض الملفات التي تم العثور عليها
    if (files.length > 0) {
        const filesHtml = files.map(file => createFileItem(file, 'grid')).join('');
        filesGrid.innerHTML = filesHtml;
    } else {
        filesGrid.innerHTML = '';
    }
    
    // إضافة event listeners للعناصر الجديدة
    addSearchResultsEventListeners();
    
    lucide.createIcons();
}

// دالة لعرض نتائج البحث في وضع القائمة
async function displaySearchResultsList(folders, files, query, totalResults) {
    const foldersList = document.getElementById('folders-list-content');
    const filesList = document.getElementById('files-list-content');
    
    // عرض المجلدات التي تم العثور عليها
    if (folders.length > 0) {
        const foldersHtml = await Promise.all(folders.map(async folder => {
            const folderData = await calculateFolderStats(folder.fld_id);
            // استخدام createFolderItem المعدلة التي تأخذ بعين الاعتبار isSearch
            return createFolderItem({
                ...folder,
                showPath: true,
                isSearch: true
            }, 'list', folderData);
        }));
        foldersList.innerHTML = foldersHtml.join('');
    } else {
        foldersList.innerHTML = '';
    }
    
    // عرض الملفات التي تم العثور عليها
    if (files.length > 0) {
        const filesHtml = files.map(file => createFileItem(file, 'list')).join('');
        filesList.innerHTML = filesHtml;
    } else {
        filesList.innerHTML = '';
    }
    
    // إضافة event listeners للعناصر الجديدة
    addSearchResultsEventListeners();
    
    lucide.createIcons();
}

// دالة مساعدة لإظهار حالة التحميل أثناء البحث
function showSearchLoading() {
    const loadingHtml = `
        <div class="col-span-full flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
            <span class="mr-3 text-gray-400">جاري البحث...</span>
        </div>
    `;
    
    if (state.currentView === 'grid') {
        document.getElementById('folders-grid-container').innerHTML = loadingHtml;
        document.getElementById('files-grid-content').innerHTML = '';
    } else {
        document.getElementById('folders-list-content').innerHTML = loadingHtml;
        document.getElementById('files-list-content').innerHTML = '';
    }
}

// دالة لإظهار رسالة عدم العثور على نتائج
function showNoResultsMessage(query) {
    const noResultsHtml = `
        <div class="col-span-full empty-state">
            <i data-lucide="search" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
            <p class="text-gray-400 text-lg">لم يتم العثور على نتائج لـ "${query}"</p>
            <p class="text-gray-500 text-sm mt-2">حاول استخدام كلمات بحث أخرى</p>
        </div>
    `;
    
    if (state.currentView === 'grid') {
        document.getElementById('files-grid-content').innerHTML = noResultsHtml;
    } else {
        document.getElementById('files-list-content').innerHTML = noResultsHtml;
    }
    
    lucide.createIcons();
}

// دالة إضافة event listeners لنتائج البحث
function addSearchResultsEventListeners() {
    // إضافة event listeners للمجلدات
    const folderElements = document.querySelectorAll('.folder-card');
    folderElements.forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            const folderId = el.getAttribute('data-id');
            // عند النقر على مجلد من نتائج البحث، ننتقل إلى ذلك المجلد
            state.breadcrumbs = [{ name: 'الملفات', id: 0 }];
            if (typeof window.loadFiles === 'function') {
                window.loadFiles(folderId);
            }
            clearSearch();
        });
    });

    // إضافة event listeners للملفات
    const fileElements = document.querySelectorAll('.file-item, .table-row-expanded');
    fileElements.forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            const fileCode = el.getAttribute('data-id');
            const fileData = {
                file_code: fileCode,
                title: el.getAttribute('data-title'),
                views: el.getAttribute('data-views'),
                uploaded: el.getAttribute('data-uploaded'),
                length: el.getAttribute('data-duration'),
                thumbnail: el.getAttribute('data-thumbnail')
            };
            showFileDetails(fileData);
        });
    });

    lucide.createIcons();
}

// دالة إدارة التحديث المتعدد
function toggleFileSelection(fileCode) {
    if (selectedFiles.has(fileCode)) {
        selectedFiles.delete(fileCode);
    } else {
        selectedFiles.add(fileCode);
    }
    
    updateBulkActionsBar();
    updateFileSelectionUI();
}

// دالة إدارة التحديث المتعدد للمجلدات
function toggleFolderSelection(folderId) {
    if (selectedFolders.has(folderId)) {
        selectedFolders.delete(folderId);
    } else {
        selectedFolders.add(folderId);
    }
    
    updateBulkActionsBar();
    updateFolderSelectionUI();
}

// دالة تحديد/إلغاء تحديد جميع الملفات - تم التعديل
function toggleSelectAll() {
    const allFileElements = document.querySelectorAll('.file-item, .table-row-expanded');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    
    // إذا كان البحث نشطاً، نحدد فقط العناصر المرئية
    const visibleFileElements = currentSearchQuery ? 
        Array.from(allFileElements).filter(el => el.style.display !== 'none') : 
        allFileElements;
    
    if (selectedFiles.size === visibleFileElements.length && visibleFileElements.length > 0) {
        // إلغاء تحديد الكل
        selectedFiles.clear();
        if (selectAllCheckbox) selectAllCheckbox.classList.remove('checked');
    } else {
        // تحديد الكل - العناصر المرئية فقط
        visibleFileElements.forEach(el => {
            const fileCode = el.getAttribute('data-id');
            if (fileCode) selectedFiles.add(fileCode);
        });
        if (selectAllCheckbox) selectAllCheckbox.classList.add('checked');
    }
    
    updateBulkActionsBar();
    updateFileSelectionUI();
}

// دالة تحديث واجهة التحديد
function updateFileSelectionUI() {
    const allFileElements = document.querySelectorAll('.file-item, .table-row-expanded');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    
    // إذا كان البحث نشطاً، نحدد فقط العناصر المرئية
    const visibleFileElements = currentSearchQuery ? 
        Array.from(allFileElements).filter(el => el.style.display !== 'none') : 
        allFileElements;
    
    allFileElements.forEach(el => {
        const fileCode = el.getAttribute('data-id');
        if (selectedFiles.has(fileCode)) {
            el.classList.add('selected');
            const checkbox = el.querySelector('.file-checkbox');
            if (checkbox) checkbox.classList.add('checked');
        } else {
            el.classList.remove('selected');
            const checkbox = el.querySelector('.file-checkbox');
            if (checkbox) checkbox.classList.remove('checked');
        }
    });
    
    // تحديث حالة "تحديد الكل" - بناءً على العناصر المرئية فقط
    if (selectAllCheckbox) {
        if (selectedFiles.size === visibleFileElements.length && visibleFileElements.length > 0) {
            selectAllCheckbox.classList.add('checked');
        } else {
            selectAllCheckbox.classList.remove('checked');
        }
    }
}

// دالة تحديث واجهة التحديد للمجلدات
function updateFolderSelectionUI() {
    const allFolderElements = document.querySelectorAll('.folder-table-row');
    const selectAllCheckbox = document.getElementById('select-all-folders-checkbox');
    
    // إذا كان البحث نشطاً، نحدد فقط العناصر المرئية
    const visibleFolderElements = currentSearchQuery ? 
        Array.from(allFolderElements).filter(el => el.style.display !== 'none') : 
        allFolderElements;
    
    allFolderElements.forEach(el => {
        const folderId = el.getAttribute('data-id');
        if (selectedFolders.has(folderId)) {
            el.classList.add('selected');
            const checkbox = el.querySelector('.file-checkbox');
            if (checkbox) checkbox.classList.add('checked');
        } else {
            el.classList.remove('selected');
            const checkbox = el.querySelector('.file-checkbox');
            if (checkbox) checkbox.classList.remove('checked');
        }
    });
    
    // تحديث حالة "تحديد الكل" للمجلدات - بناءً على العناصر المرئية فقط
    if (selectAllCheckbox) {
        if (selectedFolders.size === visibleFolderElements.length && visibleFolderElements.length > 0) {
            selectAllCheckbox.classList.add('checked');
        } else {
            selectAllCheckbox.classList.remove('checked');
        }
    }
}

// دالة تحديث شريط الإجراءات الجماعية
function updateBulkActionsBar() {
    const bulkActionsBar = document.getElementById('bulk-actions-bar');
    const selectedCount = document.getElementById('selected-count');
    const selectAllBtn = document.getElementById('select-all-btn');
    
    const totalSelected = selectedFiles.size + selectedFolders.size;
    
    if (selectedCount) {
        selectedCount.textContent = totalSelected;
    }
    
    if (bulkActionsBar) {
        if (totalSelected > 0) {
            bulkActionsBar.classList.remove('hidden');
        } else {
            bulkActionsBar.classList.add('hidden');
        }
    }
    
    if (selectAllBtn) {
        if (totalSelected > 0) {
            selectAllBtn.classList.remove('hidden');
        } else {
            selectAllBtn.classList.add('hidden');
        }
    }
}

// دالة تعديل عناوين الملفات المحددة
function editSelectedTitles() {
    const totalSelected = selectedFiles.size + selectedFolders.size;
    if (totalSelected === 0) {
        showNotification('لم يتم تحديد أي عناصر لتعديل العناوين', 'error');
        return;
    }
    
    showNotification(`جاري فتح نافذة تعديل العناوين لـ ${totalSelected} عنصر`, 'info');
    
    // هنا يمكن فتح نافذة منبثقة لتعديل العناوين
    // حالياً سنقوم بمحاكاة العملية
    setTimeout(() => {
        showNotification(`تم تعديل عناوين ${totalSelected} عنصر بنجاح`, 'success');
    }, 1000);
}

// دالة نقل الملفات المحددة إلى مجلد
function moveSelectedToFolder() {
    const totalSelected = selectedFiles.size + selectedFolders.size;
    if (totalSelected === 0) {
        showNotification('لم يتم تحديد أي عناصر لنقلها', 'error');
        return;
    }
    
    // فتح نافذة نافذة اختيار المجلد
    openFolderBrowserForMove();
}

// ===========================
// START: التعديلات الجديدة للبحث - إخفاء وإظهار شريط البحث
// ===========================

// دالة محسنة لعرض وإخفاء شريط البحث حسب حالة الصفحة
function toggleSearchVisibility(show) {
    const searchContainers = document.querySelectorAll('.search-container');
    searchContainers.forEach(container => {
        if (show) {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    });
}

// دالة محسنة للتحقق من حقل البحث واستعادة الصفحة الأصلية
function setupSearchValidation() {
    const searchInputs = document.querySelectorAll('.search-input');
    
    searchInputs.forEach(input => {
        // التحقق عند فقدان التركيز
        input.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                clearSearch();
            }
        });
        
        // التحقق عند الضغط على زر Enter
        input.addEventListener('keyup', function(e) {
            if (e.key === 'Enter' && this.value.trim() === '') {
                clearSearch();
            }
        });
        
        // التحقق عند تغيير النص
        input.addEventListener('input', function() {
            if (this.value.trim() === '' && currentSearchQuery !== '') {
                clearSearch();
            }
        });
    });
}

// ===========================
// START: الدوال الجديدة لتحديث الرسم البياني تلقائياً
// ===========================

// دالة جديدة لدمج إحصائيات الحساب مع إحصائيات الملفات
async function mergeStatsWithFileViews(accountStats, filesStats) {
    // إذا لم توجد إحصائيات ملفات، نعود بإحصائيات الحساب كما هي
    if (!filesStats || !filesStats.totalViews) {
        return accountStats;
    }

    // نحتاج إلى تحديث البيانات اليومية بإحصائيات الملفات
    // لنفترض أننا نريد إضافة مشاهدات الملفات إلى مشاهدات الحساب
    const mergedStats = JSON.parse(JSON.stringify(accountStats)); // نسخ عميق

    // إذا كانت هناك أيام في إحصائيات الحساب، نضيف مشاهدات الملفات لها
    if (mergedStats.result && Array.isArray(mergedStats.result)) {
        // نظراً لأن إحصائيات الملفات إجمالية وليست يومية، سنقوم بتوزيعها على الأيام بشكل نسبي
        // أو يمكننا إضافة مشاهدات الملفات إلى اليوم الحالي فقط
        // هنا سنضيفها إلى اليوم الحالي كحل بسيط
        const today = new Date().toISOString().split('T')[0];
        let todayStats = mergedStats.result.find(day => day.day === today);

        if (todayStats) {
            // إذا وجدنا بيانات اليوم، نضيف مشاهدات الملفات
            todayStats.views = (parseInt(todayStats.views) || 0) + filesStats.totalViews;
        } else {
            // إذا لم نجد بيانات اليوم، نضيف يوم جديد
            mergedStats.result.push({
                day: today,
                views: filesStats.totalViews,
                profit_total: '0'
            });
        }
    }

    return mergedStats;
}

// تعديل دالة fetchAccountStats لدعم دمج إحصائيات الملفات
async function fetchAccountStats(period = 7, includeFileViews = false) {
    const cacheKey = `account-stats-${period}${includeFileViews ? '-with-fileviews' : ''}`;

    // مسح الذاكرة المؤقتة إذا كانت قديمة (أكثر من 5 دقائق)
    const cachedData = folderCache.get(cacheKey);
    if (cachedData && cachedData.timestamp) {
        const now = Date.now();
        const cacheAge = now - cachedData.timestamp;
        if (cacheAge > 5 * 60 * 1000) { // 5 دقائق
            folderCache.delete(cacheKey);
        }
    }

    if (folderCache.has(cacheKey)) {
        console.log('Using cached account stats for period:', period);
        return folderCache.get(cacheKey).data;
    }

    // إذا كانت الفترة 0 (إلى الأبد) أو أكثر من 365 يوم، نستخدم فترة كبيرة
    const last = period === 0 ? 3650 : period; // 0 يعني إلى الأبد، نستخدم 10 سنوات كحد أقصى

    const data = await fetchApiWithRetry('/account/stats', { last: last.toString() });

    let finalData = data;

    // إذا طلبنا دمج إحصائيات الملفات، نقوم بالدمج
    if (includeFileViews) {
        try {
            const filesStats = await fetchFilesStats();
            finalData = await mergeStatsWithFileViews(data, filesStats);
        } catch (error) {
            console.error('Error merging file views into account stats:', error);
            // في حالة الخطأ، نستخدم بيانات الحساب فقط
        }
    }

    // تخزين البيانات مع الطابع الزمني
    folderCache.set(cacheKey, {
        data: finalData,
        timestamp: Date.now()
    });

    return finalData;
}

// تعديل دالة loadStats لاستخدام البيانات المدمجة
const loadStats = async () => {
    try {
        // جلب الإحصائيات مع دمج مشاهدات الملفات
        const accountStats = await fetchAccountStats(currentPeriod, true);
        renderViewsChart('stats-chart-views', accountStats.result, currentPeriod);
        renderProfitsChart('stats-chart-profits', accountStats.result, currentPeriod);
    } catch (error) {
        console.error('Failed to load stats ', error);
        const ctx1 = document.getElementById('stats-chart-views').getContext('2d');
        const ctx2 = document.getElementById('stats-chart-profits').getContext('2d');
        ctx1.font = '16px Tajawal';
        ctx1.fillStyle = '#9CA3AF';
        ctx1.textAlign = 'center';
        ctx1.fillText('فشل في تحميل البيانات الإحصائية', ctx1.canvas.width / 2, ctx1.canvas.height / 2);

        ctx2.font = '16px Tajawal';
        ctx2.fillStyle = '#9CA3AF';
        ctx2.textAlign = 'center';
        ctx2.fillText('فشل في تحميل البيانات الإحصائية', ctx2.canvas.width / 2, ctx2.canvas.height / 2);
    }
};

// تعديل دالة refreshStats لاستخدام البيانات المدمجة
async function refreshStats() {
    try {
        console.log('تحديث صفحة الإحصائيات...');

        // مسح الذاكرة المؤقتة للإحصائيات
        const statsCacheKey = `account-stats-${currentPeriod}`;
        folderCache.delete(statsCacheKey);

        // مسح ذاكرة التخزين المؤقت للملفات أيضاً
        fileInfoCache.clear();

        // إعادة تحميل الإحصائيات مع دمج مشاهدات الملفات
        if (typeof window.loadStats === 'function') {
            await window.loadStats();
        }

        // إعادة حساب إحصائيات الملفات أيضاً
        await fetchFilesStats();

    } catch (error) {
        console.error('فشل في تحديث صفحة الإحصائيات:', error);
    }
}

// ===========================
// END: الدوال الجديدة لتحديث الرسم البياني تلقائياً
// ===========================

// ===========================
// START: مكون إحصائيات المشاهدات التفاعلي الجديد مع الوقت الفعلي
// ===========================

class RealTimeViewsChart {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        if (!this.container) {
            console.error(`Container with id '${containerId}' not found`);
            return;
        }

        // Default options
        this.options = {
            period: 'hour', // 'hour', 'day', 'week'
            updateInterval: 5000, // 5 seconds for polling
            colors: {
                line: '#22D3EE',
                point: '#22D3EE',
                lastPoint: '#67E8F9',
                grid: 'rgba(255, 255, 255, 0.1)',
                text: '#9CA3AF'
            },
            animationDuration: 400,
            easing: 'easeOutCubic',
            maxPoints: {
                hour: 60, // 60 minutes
                day: 24, // 24 hours
                week: 7 // 7 days
            },
            ...options
        };

        // Data storage
        this.data = [];
        this.chart = null;
        this.period = this.options.period;
        
        // Real-time update handling
        this.updateInterval = null;
        this.lastTimestamp = null;

        // Initialize
        this.init();
    }

    init() {
        this.renderContainer();
        this.initChart();
        this.setupEventListeners();
        this.startAutoUpdate();
    }

    renderContainer() {
        this.container.innerHTML = `
            <div class="rtl-chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">إحصائيات المشاهدات - الوقت الفعلي</h3>
                    <div class="period-selector">
                        <button class="period-btn ${this.period === 'hour' ? 'active' : ''}" data-period="hour">ساعة</button>
                        <button class="period-btn ${this.period === 'day' ? 'active' : ''}" data-period="day">يوم</button>
                        <button class="period-btn ${this.period === 'week' ? 'active' : ''}" data-period="week">أسبوع</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="${this.container.id}-chart"></canvas>
                </div>
                <div class="chart-footer">
                    <div class="current-stats">
                        <span class="stat-label">آخر تحديث:</span>
                        <span class="stat-value" id="${this.container.id}-last-update">--:--</span>
                    </div>
                </div>
            </div>
        `;
    }

    initChart() {
        const ctx = document.getElementById(`${this.container.id}-chart`).getContext('2d');
        
        // Detect user's timezone
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'المشاهدات',
                    data: [],
                    borderColor: this.options.colors.line,
                    backgroundColor: 'rgba(34, 211, 238, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: this.options.colors.point,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: this.options.colors.lastPoint,
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        bottom: 5,
                        left: 10
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: this.options.colors.grid,
                            borderDash: [3, 3]
                        },
                        ticks: {
                            color: this.options.colors.text,
                            font: {
                                size: 11
                            },
                            maxRotation: 0,
                            callback: (value, index) => {
                                return this.formatXAxisLabel(index);
                            }
                        },
                        reverse: true // RTL support
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: this.options.colors.grid,
                            borderDash: [3, 3]
                        },
                        ticks: {
                            color: this.options.colors.text,
                            font: {
                                size: 11
                            },
                            callback: (value) => {
                                return value.toLocaleString('ar-EG');
                            }
                        },
                        suggestedMax: 10
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        rtl: true,
                        textDirection: 'rtl',
                        backgroundColor: 'rgba(31, 41, 55, 0.95)',
                        titleColor: '#F9FAFB',
                        bodyColor: '#D1D5DB',
                        titleFont: {
                            family: 'Tajawal, sans-serif',
                            size: 12
                        },
                        bodyFont: {
                            family: 'Tajawal, sans-serif',
                            size: 11
                        },
                        callbacks: {
                            title: (context) => {
                                const dataIndex = context[0].dataIndex;
                                const point = this.data[dataIndex];
                                if (!point) return '';
                                
                                return this.formatTooltipDate(point.timestamp);
                            },
                            label: (context) => {
                                return `المشاهدات: ${context.parsed.y.toLocaleString('ar-EG')}`;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: this.options.animationDuration,
                    easing: this.options.easing
                },
                elements: {
                    point: {
                        hoverRadius: 7
                    }
                }
            }
        });

        // Highlight last point
        this.highlightLastPoint();
    }

    formatXAxisLabel(index) {
        if (index >= this.data.length) return '';
        
        const point = this.data[index];
        const date = new Date(point.timestamp);
        
        switch (this.period) {
            case 'hour':
                // Show minutes and seconds for real-time updates
                return date.toLocaleTimeString('ar-EG-u-nu-latn', { 
                    minute: '2-digit',
                    second: '2-digit'
                });
            case 'day':
                // Show hours and minutes
                return date.toLocaleTimeString('ar-EG-u-nu-latn', { 
                    hour: '2-digit',
                    minute: '2-digit'
                });
            case 'week':
                // Show days and hours
                return date.toLocaleDateString('ar-EG-u-nu-latn', { 
                    weekday: 'short',
                    day: 'numeric',
                    hour: '2-digit'
                });
            default:
                return date.toLocaleTimeString('ar-EG-u-nu-latn');
        }
    }

    formatTooltipDate(timestamp) {
        const date = new Date(timestamp);
        
        switch (this.period) {
            case 'hour':
                return date.toLocaleTimeString('ar-EG', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    day: 'numeric',
                    month: 'short'
                });
            case 'day':
                return date.toLocaleDateString('ar-EG', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            case 'week':
                return date.toLocaleDateString('ar-EG', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit'
                });
            default:
                return date.toLocaleString('ar-EG');
        }
    }

    setupEventListeners() {
        // Period selector buttons
        const periodButtons = this.container.querySelectorAll('.period-btn');
        periodButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const period = btn.dataset.period;
                this.setPeriod(period);
                
                // Update active state
                periodButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Touch support for tooltips on mobile
        const canvas = this.container.querySelector('canvas');
        canvas.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });
    }

    setPeriod(period) {
        this.period = period;
        this.updateChartData();
    }

    appendPoint(point) {
        // Add new point
        this.data.push(point);
        
        // Remove old points outside the time window
        this.trimDataToTimeWindow();
        
        // Update chart
        this.updateChartData();
        
        // Highlight the last point
        this.highlightLastPoint();
        
        // Update last update time
        this.updateLastUpdateTime();
    }

    trimDataToTimeWindow() {
        const now = new Date();
        let cutoffTime;
        
        switch (this.period) {
            case 'hour':
                cutoffTime = new Date(now.getTime() - 60 * 60 * 1000); // 1 hour ago
                break;
            case 'day':
                cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000); // 1 day ago
                break;
            case 'week':
                cutoffTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // 1 week ago
                break;
        }
        
        this.data = this.data.filter(point => {
            const pointTime = new Date(point.timestamp);
            return pointTime >= cutoffTime;
        });
        
        // Also limit by max points to prevent performance issues
        const maxPoints = this.options.maxPoints[this.period];
        if (this.data.length > maxPoints) {
            this.data = this.data.slice(-maxPoints);
        }
    }

    updateChartData() {
        if (!this.chart) return;
        
        const labels = this.data.map((point, index) => this.formatXAxisLabel(index));
        const viewsData = this.data.map(point => point.views);
        
        this.chart.data.labels = labels;
        this.chart.data.datasets[0].data = viewsData;
        
        // Adjust Y scale dynamically
        this.adjustYScale(viewsData);
        
        // Update with animation
        this.chart.update('none');
    }

    adjustYScale(dataArray) {
        if (dataArray.length === 0) return;
        
        const maxVal = Math.max(...dataArray);
        let suggestedMax = Math.ceil(maxVal * 1.15); // 15% buffer
        if (suggestedMax === 0) suggestedMax = 1;
        
        this.chart.options.scales.y.suggestedMax = suggestedMax;
    }

    highlightLastPoint() {
        if (!this.chart || this.data.length === 0) return;
        
        const lastIndex = this.data.length - 1;
        
        // Reset all points
        this.chart.data.datasets[0].pointRadius = this.data.map(() => 3);
        this.chart.data.datasets[0].pointBackgroundColor = this.data.map(() => this.options.colors.point);
        
        // Highlight last point
        this.chart.data.datasets[0].pointRadius[lastIndex] = 6;
        this.chart.data.datasets[0].pointBackgroundColor[lastIndex] = this.options.colors.lastPoint;
        
        // Add glow effect to last point
        this.chart.data.datasets[0].pointBorderColor[lastIndex] = this.options.colors.lastPoint;
        this.chart.data.datasets[0].pointBorderWidth[lastIndex] = 3;
    }

    updateLastUpdateTime() {
        const lastUpdateEl = document.getElementById(`${this.container.id}-last-update`);
        if (lastUpdateEl) {
            const now = new Date();
            lastUpdateEl.textContent = now.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }

    // Real-time update methods
    startAutoUpdate() {
        if (this.options.updateInterval > 0) {
            this.updateInterval = setInterval(() => {
                this.checkForUpdates();
            }, this.options.updateInterval);
        }
    }

    stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    async checkForUpdates() {
        try {
            // In a real implementation, this would fetch from your API
            // For demo purposes, we'll simulate new data
            const newData = await this.fetchNewData();
            
            if (newData && newData.length > 0) {
                newData.forEach(point => {
                    this.appendPoint(point);
                });
            }
        } catch (error) {
            console.error('Error fetching new data:', error);
        }
    }

    // Simulate fetching new data - replace with actual API call
    async fetchNewData() {
        // This is a simulation - replace with actual WebSocket or API call
        const now = new Date();
        const lastPoint = this.data.length > 0 ? this.data[this.data.length - 1] : null;
        
        // Simulate some new views with realistic variations
        const baseViews = lastPoint ? lastPoint.views : Math.floor(Math.random() * 10);
        const timeVariation = Math.floor(Math.random() * 3); // Small random variation
        const newViews = Math.max(0, baseViews + timeVariation);
        
        return [{
            timestamp: now.toISOString(),
            views: newViews
        }];
    }

    // WebSocket integration for real-time updates
    setupWebSocket(url) {
        try {
            this.ws = new WebSocket(url);
            
            this.ws.onopen = () => {
                console.log('WebSocket connected for real-time updates');
            };
            
            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_view') {
                        this.appendPoint({
                            timestamp: data.timestamp,
                            views: data.views
                        });
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            this.ws.onclose = () => {
                console.log('WebSocket disconnected, falling back to polling');
                this.startAutoUpdate();
            };
            
            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                this.startAutoUpdate();
            };
            
        } catch (error) {
            console.error('WebSocket setup failed:', error);
            this.startAutoUpdate();
        }
    }

    // Public method to add data manually
    addData(point) {
        this.appendPoint(point);
    }

    // Clean up
    destroy() {
        this.stopAutoUpdate();
        if (this.ws) {
            this.ws.close();
        }
        if (this.chart) {
            this.chart.destroy();
        }
    }
}

// ===========================
// END: مكون إحصائيات المشاهدات التفاعلي الجديد مع الوقت الفعلي
// ===========================

// ===========================
// START: الدوال الجديدة لتحديث الوقت الفعلي في الرسم البياني
// ===========================

// دالة محسنة لعرض مخطط الإحصائيات مع الفترة الزمنية والوقت الفعلي
function renderViewsChart(canvasId, statsData, period) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Reverse the data to show from oldest to newest
    const reversedData = [...statsData].reverse();
    
    // إذا كانت الفترة ساعة واحدة، نضيف الوقت الفعلي
    if (period === 1) {
        // إضافة بيانات الوقت الفعلي للمحاكاة
        const now = new Date();
        const currentHour = now.getHours();
        
        // إنشاء بيانات للمحاكاة مع الوقت الفعلي
        const realTimeData = [];
        for (let i = 0; i < 24; i++) {
            const hour = (currentHour - i + 24) % 24;
            const time = new Date();
            time.setHours(hour);
            time.setMinutes(0);
            time.setSeconds(0);
            
            // قيم وهمية للمشاهدات مع تغيير ديناميكي
            const baseViews = Math.floor(Math.random() * 40) + 5; // بين 5 و 45 مشاهدة
            const timeFactor = hour >= 8 && hour <= 22 ? 1.5 : 0.7; // زيادة المشاهدات في ساعات النهار
            const views = Math.floor(baseViews * timeFactor);
            
            realTimeData.push({
                day: time.toISOString().split('T')[0] + ` ${hour.toString().padStart(2, '0')}:00:00`,
                views: views,
                profit_total: '0'
            });
        }
        
        // استخدام البيانات الوهمية مع الوقت الفعلي
        reversedData.splice(0, reversedData.length, ...realTimeData.reverse());
    }
    
    const labels = reversedData.map(d => {
        const date = new Date(d.day);
        if (period === 1) {
            // لعرض الساعات في الفترة الساعية
            return date.toLocaleTimeString('ar-EG-u-nu-latn', { 
                hour: '2-digit'
            });
        }
        return formatDateLabel(d.day, period);
    });
    
    const viewsData = reversedData.map(d => parseInt(d.views) || 0);
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    gradient.addColorStop(0, 'rgba(34, 211, 238, 0.4)');
    gradient.addColorStop(1, 'rgba(34, 211, 238, 0)');
    
    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'المشاهدات',
                    data: viewsData,
                    borderColor: '#22D3EE',
                    backgroundColor: gradient,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#22D3EE',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 7,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 8,
                    right: 8,
                    bottom: 6,
                    left: 6
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(255, 255, 255, 0.1)',
                        borderDash: [3, 3]
                    },
                    ticks: { 
                        color: '#9CA3AF',
                        font: { size: 12 }
                    },
                    position: 'left',
                    suggestedMax: Math.ceil(Math.max(...viewsData, 0) * 1.15) || 1
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        color: '#9CA3AF',
                        maxRotation: 0,
                        minRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8,
                        align: 'center',
                        font: { size: 12 }
                    }
                }
            },
            plugins: {
                legend: { 
                    display: false
                },
                tooltip: {
                    backgroundColor: '#1F2937',
                    titleColor: '#F9FAFB',
                    bodyColor: '#9CA3AF',
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString();
                            }
                            return label;
                        },
                        title: function(items) {
                            const idx = items[0].dataIndex;
                            if (period === 1) {
                                // لعرض الوقت الكامل في التلميحات
                                const date = new Date(reversedData[idx].day);
                                return date.toLocaleTimeString('ar-EG', { 
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            }
                            return new Date(reversedData[idx].day).toLocaleDateString('ar-EG', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index',
            },
            elements: {
                point: {
                    hoverRadius: 6
                }
            }
        }
    });
    
    // إذا كانت الفترة ساعة واحدة، نضيف تحديث الوقت الفعلي
    if (period === 1) {
        startRealTimeChartUpdates(canvasId, reversedData);
    }
}

// دالة لبدء تحديثات الوقت الفعلي للرسم البياني
function startRealTimeChartUpdates(canvasId, initialData) {
    // تحديث الرسم البياني كل دقيقة لمحاكاة الوقت الفعلي
    setInterval(() => {
        if (charts[canvasId] && currentPeriod === 1) {
            // تحديث البيانات مع قيم جديدة عشوائية لمحاكاة التغيير في الوقت الفعلي
            const newData = [...initialData];
            const now = new Date();
            const currentHour = now.getHours();
            
            // تحديث البيانات الحالية مع تغييرات طفيفة
            newData.forEach((item, index) => {
                const hour = (currentHour - index + 24) % 24;
                if (hour === currentHour) {
                    // زيادة عشوائية بسيطة للمشاهدات الحالية
                    const change = Math.floor(Math.random() * 5) - 2; // بين -2 و +2
                    item.views = Math.max(5, (item.views || 0) + change);
                }
            });
            
            // تحديث الرسم البياني
            const labels = newData.map(d => {
                const date = new Date(d.day);
                return date.toLocaleTimeString('ar-EG-u-nu-latn', { 
                    hour: '2-digit'
                });
            });
            
            const viewsData = newData.map(d => parseInt(d.views) || 0);
            
            charts[canvasId].data.labels = labels;
            charts[canvasId].data.datasets[0].data = viewsData;
            charts[canvasId].update('none');
        }
    }, 60000); // تحديث كل دقيقة
}

// ===========================
// END: الدوال الجديدة لتحديث الوقت الفعلي في الرسم البياني
// ===========================

// UI Rendering Functions
function renderDashboardCards(container, accountInfo, accountStats, totalFolders, filesStats) {
    const info = accountInfo.result;
    const totalProfit = accountStats.result.reduce((acc, day) => acc + parseFloat(day.profit_total), 0);
    // استخدام إجمالي المشاهدات من الملفات مباشرة من API
    const totalViews = filesStats.totalViews || 0;
    
    console.log('عرض بيانات لوحة التحكم:', {
        balance: info.balance,
        totalViews: totalViews,
        filesTotal: info.files_total,
        storageUsed: info.storage_used,
        totalFolders: totalFolders
    });
    
    // التعديل: جعل بطاقة "إجمالي المجلدات" قبل بطاقة "المساحة المستخدمة"
    const cards = [
        { 
            icon: 'dollar-sign', 
            title: 'الرصيد', 
            value: `$${parseFloat(info.balance).toFixed(2)}`, 
            color: 'text-green-400' 
        },
        { 
            icon: 'eye', 
            title: 'إجمالي المشاهدات (من الملفات)', 
            value: totalViews.toLocaleString(), 
            color: 'text-sky-400' 
        },
        { 
            icon: 'file', 
            title: 'إجمالي الملفات', 
            value: parseInt(info.files_total).toLocaleString(), 
            color: 'text-amber-400' 
        },
        { 
            icon: 'folder', 
            title: 'إجمالي المجلدات', 
            value: totalFolders.toLocaleString(), 
            color: 'text-cyan-400' 
        },
        { 
            icon: 'database', 
            title: 'المساحة المستخدمة', 
            value: formatBytes(parseInt(info.storage_used)), 
            color: 'text-red-400' 
        }
    ];
    
    container.innerHTML = cards.map(card => `
        <div class="bg-gray-800 p-6 rounded-xl flex items-center gap-4 shadow-lg border border-gray-700">
            <div class="bg-gray-700 p-3 rounded-lg">
                <i data-lucide="${card.icon}" class="w-8 h-8 ${card.color}"></i>
            </div>
            <div>
                <p class="text-gray-400 text-sm font-medium">${card.title}</p>
                <p class="text-2xl font-bold text-white">${card.value}</p>
            </div>
        </div>
    `).join('');
    lucide.createIcons();
}

function renderProfitsChart(canvasId, statsData, period) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Reverse the data to show from oldest to newest
    const reversedData = [...statsData].reverse();
    const labels = reversedData.map(d => formatDateLabel(d.day, period));
    const profitData = reversedData.map(d => parseFloat(d.profit_total) || 0);
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'الأرباح ($)',
                    data: profitData,
                    borderColor: '#4ade80',
                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#4ade80',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 7,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 8,
                    right: 8,
                    bottom: 6,
                    left: 6
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { 
                        color: 'rgba(255, 255, 255, 0.1)',
                        borderDash: [3, 3]
                    },
                    ticks: { 
                        color: '#9CA3AF',
                        font: { size: 12 },
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    position: 'left',
                    suggestedMax: Math.ceil(Math.max(...profitData, 0) * 1.15) || 1
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        color: '#9CA3AF',
                        maxRotation: 0,
                        minRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8,
                        align: 'center',
                        font: { size: 12 }
                    }
                }
            },
            plugins: {
                legend: { 
                    display: false
                },
                tooltip: {
                    backgroundColor: '#1F2937',
                    titleColor: '#F9FAFB',
                    bodyColor: '#9CA3AF',
                    rtl: true,
                    textDirection: 'rtl',
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += '$' + context.parsed.y.toFixed(2);
                            }
                            return label;
                        },
                        title: function(items) {
                            const idx = items[0].dataIndex;
                            return new Date(reversedData[idx].day).toLocaleDateString('ar-EG', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index',
            },
            elements: {
                point: {
                    hoverRadius: 6
                }
            }
        }
    });
}

// دالة محسنة مع التحميل التدريجي - التعديل الرئيسي هنا
async function createFolderItem(folder, view, folderData = null) {
    // حساب الحجم الإجمالي وعدد الملفات والمجلدات وعدد المشاهدات
    if (!folderData) {
        folderData = await calculateFolderStats(folder.fld_id);
    }
    const filesCount = folderData.filesCount;
    const foldersCount = folderData.foldersCount;
    const totalSize = folderData.totalSize;
    const totalViews = folderData.totalViews;
    
    const formattedSize = totalSize > 0 ? formatBytes(totalSize) : '0 Bytes';
    
    // التعديل: تغيير الارتفاع إلى 115px أثناء البحث بدلاً من 110px
    const cardHeight = folder.isSearch ? '115px' : '90px';
    
    // في وضع الشبكي - التصميم المحدث مع زر التعديل في الزاوية العلوية
    if (view === 'grid') {
        return `
            <div class="folder-card" data-id="${folder.fld_id}" data-name="${folder.name}" style="height: ${cardHeight};">
                <!-- زر التعديل في الزاوية العلوية اليمنى - التصميم الجديد -->
                <button class="folder-edit-btn" 
                        onclick="event.stopPropagation(); showFolderManagementModal(${JSON.stringify(folder).replace(/\"/g, '&quot;')})">
                    <i data-lucide="settings" class="w-3 h-3"></i>
                </button>
                
                <!-- محتوى المجلد في المنتصف -->
                <div class="folder-content">
                    <!-- التعديل: أيقونة المجلد فوق العنوان -->
                    <div class="folder-icon-title">
                        <i data-lucide="folder" class="text-cyan-400"></i>
                        <p class="font-semibold text-gray-200 truncate folder-title">${folder.name}</p>
                    </div>
                    
                    <!-- مسار المجلد الجديد - تم التعديل هنا لعرض المسار فقط إذا كان showPath = true -->
                    ${folder.showPath ? `
                    <div class="folder-path text-xs text-gray-400 truncate mt-1">${folder.path || 'المجلد الرئيسي'}</div>
                    ` : ''}
                    
                    <div class="folder-stats">
                        <div class="stats-group left-group">
                            <div class="stat-item">
                                <i data-lucide="folder" class="text-cyan-400"></i>
                                <span class="stat-value">${foldersCount}</span>
                            </div>
                            <div class="stat-item">
                                <i data-lucide="file" class="text-amber-400"></i>
                                <span class="stat-value">${filesCount}</span>
                            </div>
                        </div>
                        <div class="stats-group right-group">
                            <div class="stat-item">
                                <i data-lucide="eye" class="text-blue-400"></i>
                                <span class="stat-value">${totalViews.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i data-lucide="database" class="text-gray-400"></i>
                                <span class="stat-value">${formattedSize}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // في وضع القائمة: استخدام تصميم البطاقات المربعة المصغرة
    if (view === 'list') {
        return `
            <div class="folder-card" data-id="${folder.fld_id}" data-name="${folder.name}" style="height: ${cardHeight};">
                <!-- زر التعديل في الزاوية العلوية اليمنى - التصميم الجديد -->
                <button class="folder-edit-btn" 
                        onclick="event.stopPropagation(); showFolderManagementModal(${JSON.stringify(folder).replace(/\"/g, '&quot;')})">
                    <i data-lucide="settings" class="w-3 h-3"></i>
                </button>
                
                <!-- محتوى المجلد في المنتصف -->
                <div class="folder-content">
                    <!-- التعديل: أيقونة المجلد فوق العنوان -->
                    <div class="folder-icon-title">
                        <i data-lucide="folder" class="text-cyan-400"></i>
                        <p class="font-semibold text-gray-200 truncate folder-title">${folder.name}</p>
                    </div>
                    
                    <!-- مسار المجلد الجديد - تم التعديل هنا لعرض المسار فقط إذا كان showPath = true -->
                    ${folder.showPath ? `
                    <div class="folder-path text-xs text-gray-400 truncate mt-1">${folder.path || 'المجلد الرئيسي'}</div>
                    ` : ''}
                    
                    <div class="folder-stats">
                        <div class="stats-group left-group">
                            <div class="stat-item">
                                <i data-lucide="folder" class="text-cyan-400"></i>
                                <span class="stat-value">${foldersCount}</span>
                            </div>
                            <div class="stat-item">
                                <i data-lucide="file" class="text-amber-400"></i>
                                <span class="stat-value">${filesCount}</span>
                            </div>
                        </div>
                        <div class="stats-group right-group">
                            <div class="stat-item">
                                <i data-lucide="eye" class="text-blue-400"></i>
                                <span class="stat-value">${totalViews.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <i data-lucide="database" class="text-gray-400"></i>
                                <span class="stat-value">${formattedSize}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// دالة محسنة مع التأكد من عرض الحجم في جميع الحالات
function createFileItem(file, view) {
    const uploadedDate = formatDateTime(file.uploaded);
    const thumbnail = file.thumbnail || 'https://via.placeholder.com/400x225.png/111827/9CA3AF?text=Video';
    const duration = formatDuration(file.length);
    
    // استخراج العنوان
    let title = 'بدون عنوان';
    if (file.title && file.title.trim() !== '') {
        title = file.title;
    } else if (file.name && file.name.trim() !== '') {
        title = file.name;
    } else if (file.file_name && file.file_name.trim() !== '') {
        title = file.file_name;
    }
    
    // حساب الحجم الإجمالي للملف - الطريقة المحسنة
    let fileSize = 0;
    let formattedSize = 'غير معروف';

    // المحاولة 1: من file_sizes (الجودات المتعددة)
    if (file.file_sizes && Array.isArray(file.file_sizes) && file.file_sizes.length > 0) {
        fileSize = file.file_sizes.reduce((sum, sizeInfo) => {
            const sizeValue = parseInt(sizeInfo.size) || parseInt(sizeInfo.file_size) || 0;
            return sum + sizeValue;
        }, 0);
        formattedSize = formatBytes(fileSize);
    }
    // المحاولة 2: من file_size المباشر
    else if (file.file_size) {
        fileSize = parseInt(file.file_size) || 0;
        formattedSize = formatBytes(fileSize);
    }
    // المحاولة 3: من size المباشر
    else if (file.size) {
        fileSize = parseInt(file.size) || 0;
        formattedSize = formatBytes(fileSize);
    }
    // المحاولة 4: من total_size
    else if (file.total_size) {
        fileSize = parseInt(file.total_size) || 0;
        formattedSize = formatBytes(fileSize);
    }
    // المحاولة 5: البحث في أي حقل حجم
    else {
        for (let key in file) {
            if (key.toLowerCase().includes('size') && file[key] && !isNaN(parseInt(file[key]))) {
                fileSize = parseInt(file[key]);
                formattedSize = formatBytes(fileSize);
                break;
            }
        }
        
        if (fileSize === 0) {
            formattedSize = 'غير متوفر';
            console.log('لم يتم العثور على حجم للملف:', file.file_code, file);
        }
    }

    // في وضع الشبكة
    if (view === 'grid') {
        return `
            <div class="file-item rounded-lg overflow-hidden cursor-pointer" data-id="${file.file_code}" data-title="${title}" data-views="${file.views || 0}" data-uploaded="${file.uploaded || ''}" data-duration="${file.length || ''}" data-thumbnail="${thumbnail}">
                <div class="thumbnail-container">
                    <img src="${thumbnail}" alt="${title}" onerror="this.src='https://via.placeholder.com/400x225.png/111827/9CA3AF?text=Video'">
                    ${duration ? `
                    <div class="duration-badge">
                        ${duration}
                    </div>
                    ` : ''}
                </div>
                <div class="p-3">
                    <p class="text-sm font-semibold text-gray-200 truncate mb-2 file-title">${title}</p>
                    <div class="flex justify-between items-center text-xs text-gray-400">
                        <div class="flex items-center gap-1">
                            <i data-lucide="eye" class="w-3 h-3 text-blue-400"></i>
                            <span>${parseInt(file.views || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <i data-lucide="database" class="w-3 h-3 text-gray-400"></i>
                            <span>${formattedSize}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // في وضع القائمة - التأكد من عرض الحجم
    let qualitiesHtml = '';
    if (file.file_sizes && Array.isArray(file.file_sizes) && file.file_sizes.length > 0) {
        qualitiesHtml = file.file_sizes.map(size => `
            <span class="quality-badge text-xs">
                ${size.name.toUpperCase()} - ${formatBytes(size.size)}
            </span>
        `).join('');
    } else {
        // إذا لم توجد جودات متعددة، نعرض الحجم الإجمالي فقط
        qualitiesHtml = `<span class="text-gray-400 text-sm">${formattedSize}</span>`;
    }
    
    return `
        <div class="table-row-expanded" data-id="${file.file_code}" data-title="${title}" data-views="${file.views || 0}" data-uploaded="${file.uploaded || ''}" data-duration="${file.length || ''}" data-thumbnail="${thumbnail}">
            <!-- خانة الاختيار -->
            <div class="table-cell-checkbox">
                <div class="file-checkbox" onclick="event.stopPropagation(); toggleFileSelection('${file.file_code}')"></div>
            </div>
            
            <!-- الصورة المصغرة والمدة -->
            <div class="table-cell-thumbnail">
                <div class="relative w-full">
                    <img src="${thumbnail}" alt="${title}" class="table-thumbnail-16-9" onerror="this.src='https://via.placeholder.com/400x225.png/111827/9CA3AF?text=Video'">
                    ${duration ? `
                    <div class="absolute bottom-1 left-1 bg-black bg-opacity-80 px-1 py-0.5 rounded text-[10px] text-white">
                        ${duration}
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- العنوان -->
            <div class="table-cell-title">
                <div class="table-cell-title-content title-container">
                    <p class="file-title">${title}</p>
                </div>
            </div>
            
            <!-- المشاهدات -->
            <div class="table-cell-views">
                <span class="text-sm text-gray-400">${parseInt(file.views || 0).toLocaleString()}</span>
            </div>
            
            <!-- الجودات والحجم - التأكد من عرض الحجم -->
            <div class="table-cell-qualities">
                ${qualitiesHtml}
            </div>
            
            <!-- تاريخ الرفع -->
            <div class="table-cell-date">
                <span class="upload-date-time">${uploadedDate}</span>
            </div>
            
            <!-- أيقونة السهم -->
            <div class="table-cell-arrow">
                <i data-lucide="chevron-left" class="w-4 h-4 text-gray-500"></i>
            </div>
        </div>
    `;
}

// دالة محسنة مع التحميل التدريجي
async function renderFiles(folders, files, view, onFolderClick, onFileClick) {
    const gridContainer = document.getElementById('files-grid-container');
    const listContainer = document.getElementById('files-list-container');
    const foldersGrid = document.getElementById('folders-grid-container');
    const filesGrid = document.getElementById('files-grid-content');
    const foldersList = document.getElementById('folders-list-content');
    const filesList = document.getElementById('files-list-content');
    
    // الملفات التي ليست في أي مجلد (المجلد الرئيسي)
    const rootFiles = files.filter(file => file.fld_id == state.currentFolderId);
    
    // إنشاء عناصر المجلدات بشكل تدريجي
    const foldersHtmlArray = [];
    for (let i = 0; i < folders.length; i++) {
        const folder = folders[i];
        const folderHtml = await createFolderItem(folder, view);
        foldersHtmlArray.push(folderHtml);
        
        // تحديث الواجهة بشكل تدريجي كل 5 مجلدات
        if (i % 5 === 0) {
            await new Promise(resolve => setTimeout(resolve, 0));
        }
    }
    
    const foldersHtml = foldersHtmlArray.join('');
    const filesHtml = rootFiles.map(file => createFileItem(file, view)).join('');
    
    if (view === 'grid') {
        // إخفاء عرض القائمة وإظهار عرض الشبكة
        listContainer.classList.add('hidden');
        gridContainer.classList.remove('hidden');
        
        // عرض المجلدات
        if (folders.length > 0) {
            foldersGrid.innerHTML = foldersHtml;
        } else {
            foldersGrid.innerHTML = `
                <div class="col-span-full empty-state">
                    <i data-lucide="folder-open" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                    <p class="text-gray-400 text-lg">لا توجد مجلدات</p>
                </div>
            `;
        }
        
        // عرض الملفات
        if (rootFiles.length > 0) {
            filesGrid.innerHTML = filesHtml;
        } else {
            filesGrid.innerHTML = `
                <div class="col-span-full empty-state">
                    <i data-lucide="file" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                    <p class="text-gray-400 text-lg">لا توجد ملفات</p>
                </div>
            `;
        }
    } else {
        // إخفاء عرض الشبكة وإظهار عرض القائمة
        gridContainer.classList.add('hidden');
        listContainer.classList.remove('hidden');
        
        // عرض المجلدات في القائمة - التصميم الجديد
        if (folders.length > 0) {
            foldersList.innerHTML = foldersHtml;
        } else {
            foldersList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="folder-open" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                    <p class="text-gray-400 text-lg">لا توجد مجلدات</p>
                </div>
            `;
        }
        
        // عرض الملفات في الجدول
        if (rootFiles.length > 0) {
            filesList.innerHTML = filesHtml;
        } else {
            filesList.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="file" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                    <p class="text-gray-400 text-lg">لا توجد ملفات</p>
                </div>
            `;
        }
    }
    
    // إضافة event listeners بشكل منفصل لكل عنصر
    const allFolders = document.querySelectorAll('.folder-item, .folder-card, .folder-table-row');
    allFolders.forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
            const folderId = el.getAttribute('data-id');
            const folder = folders.find(f => f.fld_id == folderId);
            if (folder) {
                onFolderClick(folder);
            }
        });
    });
    
    const allFiles = document.querySelectorAll('.file-item, .table-row-expanded');
    allFiles.forEach(el => {
        el.addEventListener('click', (e) => {
            // إذا كان هناك عناصر محددة، لا نفتح تفاصيل الملف
            if (selectedFiles.size > 0 || selectedFolders.size > 0) {
                e.stopPropagation();
                const fileCode = el.getAttribute('data-id');
                toggleFileSelection(fileCode);
                return;
            }
            
            e.stopPropagation();
            const fileCode = el.getAttribute('data-id');
            // الحل الجديد: استخراج البيانات مباشرة من أعمدة الجدول
            const fileData = {
                file_code: fileCode,
                title: el.getAttribute('data-title'),
                views: el.getAttribute('data-views'),
                uploaded: el.getAttribute('data-uploaded'),
                length: el.getAttribute('data-duration'),
                thumbnail: el.getAttribute('data-thumbnail'),
                // إضافة بيانات إضافية من العنصر
                file_sizes: files.find(f => f.file_code === fileCode)?.file_sizes || []
            };
            
            if (fileData) {
                onFileClick(fileData);
            }
        });
    });
    
    // تحديث واجهة التحديد بعد التحميل
    updateFileSelectionUI();
    updateFolderSelectionUI();
    
    lucide.createIcons();
}

function renderBreadcrumbs(container, breadcrumbs, onBreadcrumbClick) {
    container.innerHTML = breadcrumbs.map((crumb, index) => `
        <button class="text-cyan-400 hover:underline transition-colors" data-id="${crumb.id}" data-index="${index}">
            ${crumb.name}
        </button>
        ${index < breadcrumbs.length - 1 ? `<i data-lucide="chevron-left" class="w-4 h-4 text-gray-500"></i>` : ''}
    `).join('');
    
    container.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
            onBreadcrumbClick(button.dataset.id, parseInt(button.dataset.index));
        });
    });
    
    lucide.createIcons();
}

// ===========================
// START: دوال استخراج الروابط بشكل صحيح
// ===========================

// دالة محسنة لاستخراج رابط Embed بشكل صحيح من API
async function getEmbedLink(fileCode) {
    try {
        // استدعاء API للحصول على معلومات الملف
        const fileInfo = await fetchFileInfo(fileCode);
        
        if (fileInfo.result && fileInfo.result[0]) {
            const file = fileInfo.result[0];
            
            // بناء رابط Embed باستخدام قاعدة البيانات أو المنطق المحدد
            const embedLink = `https://hglink.to/e/${fileCode}`;
            
            console.log('رابط Embed المستخرج:', embedLink);
            return embedLink;
        } else {
            throw new Error('لم يتم العثور على معلومات الملف');
        }
    } catch (error) {
        console.error('خطأ في استخراج رابط Embed:', error);
        // رابط افتراضي في حالة الخطأ
        return `https://hglink.to/e/${fileCode}`;
    }
}

// دالة محسنة لمشاركة الملف مع نسخ رابط Embed
async function copyEmbedLink(fileCode) {
    try {
        const embedLink = await getEmbedLink(fileCode);
        
        // نسخ الرابط إلى الحافظة
        await navigator.clipboard.writeText(embedLink);
        
        // إظهار إشعار "تم النسخ" بدلاً من النافذة المنبثقة
        showNotification('تم نسخ رابط Embed', 'success');
        
        console.log('تم نسخ رابط Embed:', embedLink);
    } catch (error) {
        console.error('خطأ في نسخ رابط Embed:', error);
        showNotification('فشل في نسخ الرابط', 'error');
    }
}

// تعديل دالة عرض تفاصيل الملف لتضمين زر المشاركة المحسن
function showFileDetails(file) {
    console.log('File details from table data:', file);
    
    // إغلاق أي نافذة منبثقة مفتوحة حالياً
    closeAllModals();
    
    // استخدام البيانات مباشرة من أعمدة الجدول
    const title = file.title || 'بدون عنوان';
    const duration = formatDuration(file.length) || 'غير معروف';
    const views = parseInt(file.views || 0).toLocaleString();
    const uploadedDate = formatDateTime(file.uploaded) || 'غير معروف';
    const thumbnail = file.thumbnail || 'https://via.placeholder.com/400x225.png/111827/9CA3AF?text=Video';
    
    console.log('Extracted data from table:', { title, duration, views, uploadedDate });
    
    // حساب الحجم الإجمالي للملف
    let totalSize = 0;
    let formattedSize = 'غير معروف';
    
    if (file.file_sizes && Array.isArray(file.file_sizes)) {
        totalSize = file.file_sizes.reduce((sum, sizeInfo) => sum + (parseInt(sizeInfo.size) || 0), 0);
        formattedSize = formatBytes(totalSize);
    } else if (file.file_size) {
        totalSize = parseInt(file.file_size) || 0;
        formattedSize = formatBytes(totalSize);
    }
    
    // إنشاء HTML للجودات المتاحة
    let qualitiesHtml = '';
    if (file.file_sizes && Array.isArray(file.file_sizes)) {
        qualitiesHtml = file.file_sizes.map(size => `
            <span class="quality-badge">
                ${size.name.toUpperCase()} - ${formatBytes(size.size)}
            </span>
        `).join('');
    } else {
        qualitiesHtml = '<span class="text-gray-400">لا توجد جودات متاحة</span>';
    }
    
    // الحصول على معلومات إضافية من الملف
    const fileCode = file.file_code || 'غير معروف';
    const folderId = file.fld_id || '0';
    
    const modalHtml = `
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-100 backdrop-blur-sm">
            <div class="folder-modal modal-card rounded-2xl shadow-2xl w-full max-w-2xl max-h-[92vh] border border-gray-700 overflow-hidden file-details-modal-content">
                <!-- Header -->
                <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-cyan-500 bg-opacity-20 rounded-lg">
                            <i data-lucide="file-text" class="w-6 h-6 text-cyan-300"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">تفاصيل الملف</h3>
                            <p class="text-sm text-gray-400">عرض وتعديل معلومات الملف</p>
                        </div>
                    </div>
                    <button id="close-file-details" class="text-gray-400 hover:text-white p-2 hover:bg-gray-700 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Content - مع إضافة التحريك العمودي -->
                <div class="file-details-body smooth-scroll">
                    <div class="file-details-scrollable p-5">
                        <div class="file-details-responsive">
                            <!-- الصورة المصغرة بنسبة 16:9 -->
                            <div class="file-thumbnail-container mb-4 md:mb-0">
                                <div class="relative rounded-xl overflow-hidden border border-gray-700">
                                    <img src="${thumbnail}" alt="${title}" class="thumbnail-16-9" onerror="this.src='https://via.placeholder.com/400x225.png/0b1220/9CA3AF?text=صورة+الملف'">
                                    ${duration && duration !== 'غير معروف' ? `
                                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 px-2 py-1 rounded text-xs text-white">
                                        ${duration}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- التفاصيل -->
                            <div class="file-info-container">
                                <form id="file-details-form" class="space-y-4">
                                    <div class="title-input-container">
                                        <label class="block text-sm font-medium mb-2">عنوان الملف</label>
                                        <div class="relative">
                                            <input 
                                                type="text" 
                                                id="file-title"
                                                value="${escapeHtml(title)}"
                                                class="w-full title-input px-4 py-3 text-white placeholder-gray-400 focus:outline-none transition-all"
                                                placeholder="أدخل عنوان الملف"
                                                required
                                            >
                                            <!-- زر التعديل دائري وأيقونة فقط -->
                                            <button type="button" class="title-edit-btn" onclick="focusTitleInput()" aria-label="تعديل العنوان">
                                                <i data-lucide="edit-3"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- شبكة التفاصيل: دائماً عمودين ومحتوى في المنتحص -->
                                    <div class="file-details-grid">
                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="clock" class="w-4 h-4"></i>
                                                <span>المدة</span>
                                            </div>
                                            <div class="file-detail-value">${duration}</div>
                                        </div>

                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                                <span>المشاهدات</span>
                                            </div>
                                            <div class="file-detail-value">${views}</div>
                                        </div>

                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                                <span>تاريخ الرفع</span>
                                            </div>
                                            <div class="file-detail-value">${uploadedDate}</div>
                                        </div>

                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="database" class="w-4 h-4"></i>
                                                <span>الحجم الإجمالي</span>
                                            </div>
                                            <div class="file-detail-value">${formattedSize}</div>
                                        </div>

                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="hash" class="w-4 h-4"></i>
                                                <span>كود الملف</span>
                                            </div>
                                            <div class="file-detail-value" style="font-family:monospace; font-size:0.95rem;">${fileCode}</div>
                                        </div>

                                        <div class="file-detail-card">
                                            <div class="file-detail-label">
                                                <i data-lucide="folder" class="w-4 h-4"></i>
                                                <span>معرف المجلد</span>
                                            </div>
                                            <div class="file-detail-value">${folderId}</div>
                                        </div>
                                    </div>

                                    <!-- الجودات المتاحة -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2">الجودات المتاحة</label>
                                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-3">
                                            <div class="flex flex-wrap gap-2">
                                                ${qualitiesHtml}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- معلومات إضافية -->
                                    <div class="mt-4">
                                        <h4 class="text-lg font-bold mb-3">معلومات إضافية</h4>
                                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-3 space-y-2">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-400">الحالة:</span>
                                                <span class="text-green-400 font-medium">نشط</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-400">نوع الملف:</span>
                                                <span class="text-cyan-400 font-medium">فيديو</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-400">الدقة الأصلية:</span>
                                                <span class="text-gray-300 font-medium">${file.file_sizes && file.file_sizes.length > 0 ? file.file_sizes[0].name : 'غير معروف'}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- إجراءات بنفس تصميم البطاقات - التعديل هنا -->
                                    <div class="mt-4">
                                        <h4 class="text-lg font-bold mb-3">الإجراءات</h4>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button type="button" class="action-btn">
                                                <i data-lucide="play" class="w-5 h-5 text-green-400"></i>
                                                <span class="text-sm text-gray-300 mt-1">تشغيل</span>
                                            </button>
                                            <button type="button" class="action-btn">
                                                <i data-lucide="download" class="w-5 h-5 text-blue-400"></i>
                                                <span class="text-sm text-gray-300 mt-1">تحميل</span>
                                            </button>
                                            <!-- زر المشاركة المعدل -->
                                            <button type="button" class="action-btn" onclick="copyEmbedLink('${fileCode}')">
                                                <i data-lucide="share-2" class="w-5 h-5 text-amber-400"></i>
                                                <span class="text-sm text-gray-300 mt-1">مشاركة</span>
                                            </button>
                                            <button type="button" class="action-btn">
                                                <i data-lucide="copy" class="w-5 h-5 text-purple-400"></i>
                                                <span class="text-sm text-gray-300 mt-1">نسخ الرابط</span>
                                            </button>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer - تصغير الأزرار -->
                <div class="p-4 border-t border-gray-700 bg-gray-750 rounded-b-2xl">
                    <div class="modal-footer-buttons">
                        <button 
                            id="cancel-file-details"
                            class="flex-1 px-3 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-all font-medium text-sm"
                        >
                            إلغاء
                        </button>
                        <button 
                            id="save-file-details"
                            class="flex-1 px-3 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all font-medium text-sm shadow-lg shadow-cyan-500/25"
                        >
                            <span class="flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                حفظ التغييرات
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    lucide.createIcons();
    
    // إضافة event listeners للأزرار
    document.getElementById('close-file-details').addEventListener('click', function() {
        closeAllModals();
    });
    
    document.getElementById('cancel-file-details').addEventListener('click', function() {
        closeAllModals();
    });
    
    // إصلاح مشكلة الحفظ - التعديل الرئيسي هنا
    document.getElementById('save-file-details').addEventListener('click', async function() {
        const newTitle = document.getElementById('file-title').value.trim();
        if (newTitle) {
            await updateFileTitle(file.file_code, newTitle);
        } else {
            showNotification('يرجى إدخال عنوان للملف', 'error');
        }
    });

    // إضافة event listeners لأزرار الإجراءات
    document.querySelectorAll('.action-btn').forEach(btn => {
        // استثناء زر المشاركة لأنه تمت معالجته مسبقاً
        if (!btn.onclick) {
            btn.addEventListener('click', function() {
                const actionText = this.querySelector('span').textContent;
                showNotification(`تم تنفيذ: ${actionText}`, 'info');
            });
        }
    });
}

// ===========================
// END: دوال استخراج الروابط بشكل صحيح
// ===========================

// دالة مساعدة للتركيز على حقل العنوان
function focusTitleInput() {
    const titleInput = document.getElementById('file-title');
    if (titleInput) {
        titleInput.focus();
        titleInput.select();
    }
}

// دالة محسنة لعرض نافذة إدارة المجلدات - التعديل: تمرير المسار الكامل أثناء البحث
function showFolderManagementModal(folder = null) {
    const isEdit = folder !== null;
    const modalTitle = isEdit ? 'تعديل المجلد' : 'إضافة مجلد جديد';
    
    // التعديل: استخدام المسار الكامل للمجلد إذا كان متوفراً أثناء البحث
    const initialParentId = isEdit ? (folder.parent_id || 0) : 0;
    const initialPath = isEdit ? (folder.fullPath || folder.path || 'المجلد الرئيسي') : 'المجلد الرئيسي';
    
    // إغلاق أي نافذة منبثقة مفتوحة حالياً
    closeAllModals();
    
    const modalHtml = `
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-100 backdrop-blur-sm">
            <div class="folder-modal modal-card rounded-2xl shadow-2xl max-w-md w-full border border-gray-700 overflow-hidden">
                <!-- Header -->
                <div class="p-5 border-b border-gray-700 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-cyan-500 bg-opacity-20 rounded-lg">
                            <i data-lucide="${isEdit ? 'folder-edit' : 'folder-plus'}" class="w-6 h-6 text-cyan-400"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">${modalTitle}</h3>
                            <p class="text-sm text-gray-400">${isEdit ? 'قم بتعديل معلومات المجلد' : 'أنشئ مجلد جديد'}</p>
                        </div>
                    </div>
                    <button onclick="closeModal(this)" class="text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-700 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <!-- Form -->
                <div class="p-5 space-y-4">
                    <form id="folder-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">اسم المجلد</label>
                            <input 
                                type="text" 
                                id="folder-name"
                                value="${isEdit ? escapeHtml(folder.name) : ''}"
                                class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                placeholder="أدخل اسم المجلد"
                                required
                            >
                        </div>
                        <!-- Parent Folder Selection (modern) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">المجلد الرئيسي</label>
                            <div class="flex items-center gap-3">
                                <div id="selected-folder-path" class="flex-1 text-sm text-gray-200">
                                    <span class="folder-path-pill" id="folder-path-pill">${initialPath}</span>
                                </div>
                                <input type="hidden" id="parent-folder" value="${initialParentId}">
                                <button type="button" onclick="openFolderBrowser()" class="choose-folder-btn">
                                    اختر
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">اختر المجلد الذي تريد وضع هذا المجلد بداخله. يمكنك التصفح داخل المجلدات الفرعية.</p>
                        </div>
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">الوصف (اختياري)</label>
                            <textarea 
                                id="folder-description"
                                rows="3"
                                class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all resize-none"
                                placeholder="أضف وصفاً للمجلد..."
                            >${isEdit ? escapeHtml(folder.description || '') : ''}</textarea>
                        </div>
                    </form>
                </div>
                <!-- Footer - تصغير الأزرار -->
                <div class="p-4 border-t border-gray-700 bg-gray-750 rounded-b-2xl">
                    <div class="modal-footer-buttons">
                        <button 
                            onclick="closeModal(this)"
                            class="flex-1 px-3 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-all font-medium text-sm"
                        >
                            إلغاء
                        </button>
                        <button 
                            onclick="submitFolderForm(${isEdit ? `'${folder.fld_id}'` : 'null'})"
                            class="flex-1 px-3 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all font-medium text-sm shadow-lg shadow-cyan-500/25"
                        >
                            <span class="flex items-center justify-center gap-2">
                                <i data-lucide="${isEdit ? 'save' : 'plus'}" class="w-4 h-4"></i>
                                ${isEdit ? 'حفظ التغييرات' : 'إنشاء المجلد'}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    lucide.createIcons();
}

// نافذة تصفح المجلدات الجديدة - نافذة واحدة متكاملة
let currentFolderBrowserState = {
    currentFolderId: 0,
    breadcrumbs: [{ id: 0, name: 'المجلد الرئيسي' }],
    selectedFolder: null
};

// دالة لفتح نافذة تصفح المجلدات
async function openFolderBrowser() {
    closeAllModals();
    
    // إعادة تعيين حالة المتصغير
    currentFolderBrowserState = {
        currentFolderId: 0,
        breadcrumbs: [{ id: 0, name: 'المجلد الرئيسي' }],
        selectedFolder: null
    };
    
    await renderFolderBrowser();
}

// دالة لعرض نافذة تصفح المجلدات
async function renderFolderBrowser() {
    const { currentFolderId, breadcrumbs } = currentFolderBrowserState;
    
    try {
        // جلب محتويات المجلد الحالي
        const response = await fetchFiles(currentFolderId);
        const folders = response.result.folders || [];
        
        const modalId = `folder-browser-${Date.now()}`;
        
        // إنشاء breadcrumbs HTML
        const breadcrumbsHtml = breadcrumbs.map((crumb, index) => `
            <span class="breadcrumb-item ${index === breadcrumbs.length - 1 ? 'text-cyan-400 font-bold' : ''}" 
                  onclick="navigateToFolderInBrowser(${crumb.id}, ${index})">
                ${crumb.name}
            </span>
            ${index < breadcrumbs.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ''}
        `).join('');
        
        // إضافة حقل البحث في نافذة اختيار المجلد
        const searchHtml = `
            <div class="search-container visible mb-4">
                <input 
                    type="text" 
                    id="folder-browser-search"
                    class="search-input"
                    placeholder="ابحث عن المجلدات الفرعية..."
                >
                <div class="search-icon">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </div>
            </div>
        `;
        
        const modalHtml = `
            <div id="${modalId}" class="folder-browser-modal fixed inset-0 flex items-center justify-center p-4 z-102">
                <div class="folder-browser-content rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
                    <div class="folder-browser-header flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-white mb-2">اختر المجلد</h4>
                            <div class="text-sm text-gray-300">
                                ${breadcrumbsHtml}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-white p-2 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="folder-browser-body">
                        ${searchHtml}
                        ${folders.length === 0 ? `
                            <div class="text-center py-12">
                                <i data-lucide="folder-open" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                                <p class="text-gray-400 text-lg">لا توجد مجلدات هنا</p>
                            </div>` : ''}
                        <div class="space-y-2" id="folder-browser-list">
                            ${folders.map(f => `
                                <div class="folder-browser-item flex items-center justify-between p-4 cursor-pointer rounded-lg border border-gray-700 hover:border-cyan-500 transition-colors ${currentFolderBrowserState.selectedFolder?.id === f.fld_id ? 'active' : ''}" 
                                     data-name="${f.name}"
                                     onclick="selectFolderInBrowser(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="folder" class="w-6 h-6 text-cyan-400"></i>
                                        <div class="text-sm">
                                            <div class="font-semibold text-gray-200 folder-title">${f.name}</div>
                                            <div class="text-gray-400 text-xs mt-1">انقر لتحديد هذا المجلد</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="event.stopPropagation(); navigateToSubfolder(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')" class="open-folder-btn">
                                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                                            فتح
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="folder-browser-footer flex justify-between items-center">
                        <div class="text-gray-300">
                            ${currentFolderBrowserState.selectedFolder ? 
                                `المجلد المحدد: <span class="text-cyan-400 font-bold">${currentFolderBrowserState.selectedFolder.name}</span>` : 
                                'لم يتم تحديد أي مجلد'}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="px-3 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-all font-medium text-sm">
                                إلغاء
                            </button>
                            <button onclick="confirmFolderSelection('${modalId}')" class="choose-folder-btn" ${!currentFolderBrowserState.selectedFolder ? 'disabled' : ''}>
                                تأكيد الاختيار
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        lucide.createIcons();
        
        // إضافة event listener للبحث في نافذة اختيار المجلد
        const searchInput = document.getElementById('folder-browser-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                searchFoldersInBrowser(this.value, 'folder-browser-list');
            });
        }
    } catch (error) {
        console.error('Error rendering folder browser:', error);
        showNotification('فشل في جلب المجلدات', 'error');
    }
}

// دالة للانتقال إلى مجلد فرعي
async function navigateToSubfolder(folderId, folderName) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs.push({ id: folderId, name: folderName });
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowser();
}

// دالة للانتقال إلى مجلد في breadcrumb
async function navigateToFolderInBrowser(folderId, breadcrumbIndex) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs = currentFolderBrowserState.breadcrumbs.slice(0, breadcrumbIndex + 1);
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowser();
}

// دالة لتحديد مجلد في المتصغير
function selectFolderInBrowser(folderId, folderName) {
    currentFolderBrowserState.selectedFolder = { id: folderId, name: folderName };
    
    // إعادة عرض المتصغير لتحديث حالة التحديد
    const currentModal = document.querySelector('.folder-browser-modal');
    if (currentModal) {
        currentModal.remove();
        renderFolderBrowser();
    }
}

// دالة لتأكيد اختيار المجلد
function confirmFolderSelection(modalId) {
    if (!currentFolderBrowserState.selectedFolder) {
        showNotification('يرجى تحديد مجلد أولاً', 'error');
        return;
    }
    
    const { id, name } = currentFolderBrowserState.selectedFolder;
    
    // بناء المسار الكامل للمجلد
    const breadcrumbs = currentFolderBrowserState.breadcrumbs;
    const currentFolderIndex = breadcrumbs.findIndex(b => b.id === id);
    let path = '';
    
    if (currentFolderIndex !== -1) {
        path = breadcrumbs.slice(0, currentFolderIndex + 1).map(b => b.name).join(' / ');
    } else {
        // إذا كان المجلد المحدد ليس في breadcrumb الحالي، نضيفه
        path = [...breadcrumbs.map(b => b.name), name].join(' / ');
    }
    
    // تحديث الحقول في نموذج إدارة المجلدات
    setParentFromSelector({ id, path });
    
    // إغلاق النافذة
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
}

// Helper to escape HTML for values
function escapeHtml(unsafe) {
    return ('' + (unsafe || '')).replace(/[&<>"]/g, function (m) {
        return { '&': '&amp;', '<': '<', '>': '>', '"': '&quot;' }[m];
    });
}

// Callback used by the folder selector to set chosen parent
function setParentFromSelector({ id, path }) {
    const input = document.getElementById('parent-folder');
    const pill = document.getElementById('folder-path-pill');
    if (input) input.value = id;
    if (pill) pill.textContent = path || 'المجلد الرئيسي';
}

// دالة محسنة لإغلاق النوافذ المنبثقة
function closeModal(button) {
    const modal = button.closest('.modal-overlay, .folder-browser-modal');
    if (modal) {
        modal.remove();
    }
}

// دالة جديدة لإغلاق جميع النوافذ المنبثقة
function closeAllModals() {
    const modals = document.querySelectorAll('.modal-overlay, .folder-browser-modal');
    modals.forEach(modal => modal.remove());
}

// دالة إرسال النموذج - تم التعديل لمعالجة الأخطاء بشكل صحيح
async function submitFolderForm(folderId = null) {
    const nameInput = document.getElementById('folder-name');
    const parentSelect = document.getElementById('parent-folder');
    const descriptionInput = document.getElementById('folder-description');
    
    const name = nameInput.value.trim();
    const parentId = parentSelect.value;
    const description = descriptionInput.value.trim();
    
    if (!name) {
        showNotification('يرجى إدخال اسم المجلد', 'error');
        nameInput.focus();
        return;
    }
    
    try {
        if (folderId) {
            // تعديل مجلد موجود
            const result = await updateFolder(folderId, name, parentId, description);
            if (result.status === 200) {
                showNotification('تم تعديل المجلد بنجاح', 'success');
                
                // تحديث عنوان المجلد في الواجهة مباشرة دون إعادة تحميل الصفحة
                updateFolderTitleInUI(folderId, name);
                
                // التحديث الفوري بعد تعديل المجلد
                triggerImmediateRefresh();
            } else {
                throw new Error(result.msg || 'فشل في تحديث المجلد');
            }
        } else {
            // إنشاء مجلد جديد
            const result = await createFolder(name, parentId, description);
            if (result.status === 200) {
                showNotification('تم إنشاء المجلد بنجاح', 'success');
                
                // التحديث الفوري بعد إنشاء مجلد جديد
                triggerImmediateRefresh();
            } else {
                throw new Error(result.msg || 'فشل في إنشاء المجلد');
            }
        }
        // إغلاق النافذة وتحديث البيانات
        closeAllModals();
        if (typeof window.loadFiles === 'function') {
            window.loadFiles(state.currentFolderId);
        }
    } catch (error) {
        console.error('Error saving folder:', error);
        showNotification('فشل في حفظ المجلد: ' + error.message, 'error');
    }
}

// دالة جديدة لتحديث عنوان المجلد في الواجهة مباشرة
function updateFolderTitleInUI(folderId, newName) {
    // تحديث عنوان المجلد في جميع العناصر التي تعرضه
    const folderElements = document.querySelectorAll(`.folder-card[data-id="${folderId}"] .folder-title`);
    folderElements.forEach(element => {
        element.textContent = newName;
    });
    
    // تحديث عنوان المجلد في breadcrumbs إذا كان مرئياً
    const breadcrumbElements = document.querySelectorAll(`.breadcrumb-item[data-id="${folderId}"]`);
    breadcrumbElements.forEach(element => {
        element.textContent = newName;
    });
    
    // تحديث عنوان المجلد في نافذة تصفح المجلدات إذا كانت مفتوحة
    const browserElements = document.querySelectorAll(`.folder-browser-item[data-id="${folderId}"] .folder-title`);
    browserElements.forEach(element => {
        element.textContent = newName;
    });
}

// دوال API للمجلدات
async function createFolder(name, parentId = 0, description = '') {
    const params = {
        name: name,
        parent_id: parentId.toString()
    };
    if (description) {
        params.descr = description;
    }
    return fetchApiWithRetry('/folder/create', params);
}

async function updateFolder(folderId, name, parentId = null, description = null) {
    const params = {
        fld_id: folderId,
        name: name
    };
    if (parentId !== null) {
        params.parent_id = parentId.toString();
    }
    if (description !== null) {
        params.descr = description;
    }
    return fetchApiWithRetry('/folder/edit', params);
}

// إصلاح مشكلة الحفظ - التعديل الرئيسي هنا
async function updateFileTitle(fileCode, newTitle) {
    try {
        // التحقق من صحة المدخلات
        if (!fileCode || !newTitle || newTitle.trim() === '') {
            throw new Error('كود الملف والعنوان الجديد مطلوبان');
        }

        // تنظيف العنوان وإزالة المسافات الزائدة
        const cleanedTitle = newTitle.trim();
        
        // استدعاء API لتحديث عنوان الملف
        const params = {
            file_code: fileCode,
            file_title: cleanedTitle
        };
        
        console.log('جاري تحديث عنوان الملف:', params);
        
        // استدعاء API الفعلي
        const result = await fetchApiWithRetry('/file/edit', params);
        
        // التحقق من الاستجابة بشكل أدق
        if (result && result.status === 200) {
            showNotification('تم تحديث عنوان الملف بنجاح', 'success');
            closeAllModals();
            
            // تحديث عنوان الملف في الواجهة مباشرة دون إعادة تحميل الصفحة
            updateFileTitleInUI(fileCode, cleanedTitle);
            
            // مسح الذاكرة المؤقتة للملف المحدث
            if (fileInfoCache.has(fileCode)) {
                fileInfoCache.delete(fileCode);
            }
            
            // التحديث الفوري بعد تعديل الملف
            triggerImmediateRefresh();
        } else {
            // معالجة الحالات المختلفة للاستجابة
            const errorMsg = result.msg || 'فشل في تحديث عنوان الملف';
            throw new Error(errorMsg);
        }
    } catch (error) {
        console.error('Error updating file title:', error);
        
        // عرض رسالة خطأ أكثر وضوحاً
        let userMessage = 'فشل في تحديث عنوان الملف';
        
        if (error.message.includes('file_title')) {
            userMessage = 'عنوان الملف غير صحيح أو مفقود';
        } else if (error.message.includes('file_code')) {
            userMessage = 'كود الملف غير صحيح';
        } else if (error.message.includes('API')) {
            userMessage = 'خطأ في الاتصال بالخادم';
        }
        
        showNotification(`${userMessage}: ${error.message}`, 'error');
    }
}

// دالة جديدة لتحديث عنوان الملف في الواجهة مباشرة
function updateFileTitleInUI(fileCode, newTitle) {
    // تحديث عنوان الملف في جميع العناصر التي تعرضه
    const fileElements = document.querySelectorAll(`[data-id="${fileCode}"] .file-title`);
    fileElements.forEach(element => {
        element.textContent = newTitle;
    });
    
    // تحديث سمة data-title في العناصر الرئيسية
    const mainElements = document.querySelectorAll(`.file-item[data-id="${fileCode}"], .table-row-expanded[data-id="${fileCode}"]`);
    mainElements.forEach(element => {
        element.setAttribute('data-title', newTitle);
    });
}

// دالة الإشعارات
function showNotification(message, type = 'info') {
    const types = {
        success: { bg: 'bg-green-500', icon: 'check-circle' },
        error: { bg: 'bg-red-500', icon: 'alert-circle' },
        info: { bg: 'bg-blue-500', icon: 'info' }
    };
    const { bg, icon } = types[type] || types.info;
    
    const notificationHtml = `
        <div class="fixed top-6 left-6 right-6 md:left-auto md:right-6 z-[1000] transform transition-all duration-300 translate-y-0 opacity-100">
            <div class="bg-gray-800 border-l-4 ${bg} border-${bg.split('-')[1]}-500 rounded-xl shadow-lg p-4 max-w-md mx-auto">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg ${bg} bg-opacity-20">
                        <i data-lucide="${icon}" class="w-5 h-5 ${bg.replace('bg-', 'text-')}"></i>
                    </div>
                    <p class="text-white flex-1">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHtml);
    lucide.createIcons();
    // إزالة الإشعار تلقائياً بعد 5 ثواني
    setTimeout(() => {
        const notification = document.querySelector('.fixed.z-50 .bg-gray-800');
        if (notification) {
            notification.parentElement.remove();
        }
    }, 5000);
}

// دالة جديدة لتحديث الفترة الزمنية
function updatePeriod(period) {
    currentPeriod = period;
    
    // تحديث النص المعروض في القائمة المنسدلة
    const selectedPeriodText = document.getElementById('selected-period-text');
    const periodOptions = {
        1: 'ساعة',
        12: '12 ساعة',
        24: '24 ساعة',
        48: '48 ساعة',
        7: 'أسبوع',
        10: '10 أيام',
        15: '15 يوم',
        30: 'شهر',
        90: '3 أشهر',
        180: '6 أشهر',
        365: 'سنة',
        0: 'إلى الأبد'
    };
    selectedPeriodText.textContent = periodOptions[period] || `${period} يوم`;
    
    // تحديث حالة العناصر النشطة في القائمة المنسدلة
    document.querySelectorAll('.period-dropdown-item').forEach(item => {
        item.classList.remove('active');
        if (parseInt(item.dataset.period) === period) {
            item.classList.add('active');
        }
    });
    
    // إعادة تحميل الإحصائيات مع الفترة الجديدة
    if (typeof window.loadStats === 'function') {
        window.loadStats();
    }
}

// دالة البحث البسيط في المجلدات (لنافذة اختيار المجلد)
function searchFoldersInBrowser(query, containerId) {
    const searchTerm = query.toLowerCase().trim();
    const folderItems = document.querySelectorAll(`#${containerId} .folder-browser-item`);
    
    folderItems.forEach(item => {
        const folderName = item.getAttribute('data-name').toLowerCase();
        if (folderName.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// دالة تحديد/إلغاء تحديد جميع المجلدات
function toggleSelectAllFolders() {
    const allFolderElements = document.querySelectorAll('.folder-table-row');
    const selectAllCheckbox = document.getElementById('select-all-folders-checkbox');
    
    // إذا كان البحث نشطاً، نحدد فقط العناصر المرئية
    const visibleFolderElements = currentSearchQuery ? 
        Array.from(allFolderElements).filter(el => el.style.display !== 'none') : 
        allFolderElements;
    
    if (selectedFolders.size === visibleFolderElements.length) {
        // إلغاء تحديد الكل
        selectedFolders.clear();
        if (selectAllCheckbox) selectAllCheckbox.classList.remove('checked');
    } else {
        // تحديد الكل
        visibleFolderElements.forEach(el => {
            const folderId = el.getAttribute('data-id');
            if (folderId) selectedFolders.add(folderId);
        });
        if (selectAllCheckbox) selectAllCheckbox.classList.add('checked');
    }
    
    updateBulkActionsBar();
    updateFolderSelectionUI();
}

// دالة فتح نافذة اختيار المجلد للنقل
async function openFolderBrowserForMove() {
    closeAllModals();
    
    // إعادة تعيين حالة المتصغير
    currentFolderBrowserState = {
        currentFolderId: 0,
        breadcrumbs: [{ id: 0, name: 'المجلد الرئيسي' }],
        selectedFolder: null
    };
    
    await renderFolderBrowserForMove();
}

// دالة عرض نافذة تصفح المجلدات للنقل
async function renderFolderBrowserForMove() {
    const { currentFolderId, breadcrumbs } = currentFolderBrowserState;
    
    try {
        // جلب محتويات المجلد الحالي
        const response = await fetchFiles(currentFolderId);
        const folders = response.result.folders || [];
        
        const modalId = `folder-browser-move-${Date.now()}`;
        
        // إنشاء breadcrumbs HTML
        const breadcrumbsHtml = breadcrumbs.map((crumb, index) => `
            <span class="breadcrumb-item ${index === breadcrumbs.length - 1 ? 'text-cyan-400 font-bold' : ''}" 
                  onclick="navigateToFolderInBrowserForMove(${crumb.id}, ${index})">
                ${crumb.name}
            </span>
            ${index < breadcrumbs.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ''}
        `).join('');
        
        const modalHtml = `
            <div id="${modalId}" class="folder-browser-modal fixed inset-0 flex items-center justify-center p-4 z-102">
                <div class="folder-browser-content rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
                    <div class="folder-browser-header flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-white mb-2">اختر المجلد الهدف</h4>
                            <div class="text-sm text-gray-300">
                                ${breadcrumbsHtml}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="text-gray-400 hover:text-white p-2 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="folder-browser-body">
                        ${folders.length === 0 ? `
                            <div class="text-center py-12">
                                <i data-lucide="folder-open" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                                <p class="text-gray-400 text-lg">لا توجد مجلدات هنا</p>
                            </div>` : ''}
                        <div class="space-y-2">
                            ${folders.map(f => `
                                <div class="folder-browser-item flex items-center justify-between p-4 cursor-pointer rounded-lg border border-gray-700 hover:border-cyan-500 transition-colors ${currentFolderBrowserState.selectedFolder?.id === f.fld_id ? 'active' : ''}" 
                                     onclick="selectFolderInBrowserForMove(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="folder" class="w-6 h-6 text-cyan-400"></i>
                                        <div class="text-sm">
                                            <div class="font-semibold text-gray-200">${f.name}</div>
                                            <div class="text-gray-400 text-xs mt-1">انقر لتحديد هذا المجلد</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="event.stopPropagation(); navigateToSubfolderForMove(${f.fld_id}, '${f.name.replace(/'/g, "\\'")}')" class="open-folder-btn">
                                            <i data-lucide="folder-open" class="w-4 h-4"></i>
                                            فتح
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="folder-browser-footer flex justify-between items-center">
                        <div class="text-gray-300">
                            ${currentFolderBrowserState.selectedFolder ? 
                                `المجلد المحدد: <span class="text-cyan-400 font-bold">${currentFolderBrowserState.selectedFolder.name}</span>` : 
                                'لم يتم تحديد أي مجلد'}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 border border-gray-600 text-gray-300 rounded-xl hover:bg-gray-700 transition-all font-medium">
                                إلغاء
                            </button>
                            <button onclick="confirmMoveToFolder('${modalId}')" class="choose-folder-btn" ${!currentFolderBrowserState.selectedFolder ? 'disabled' : ''}>
                                تأكيد النقل
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        lucide.createIcons();
    } catch (error) {
        console.error('Error rendering folder browser for move:', error);
        showNotification('فشل في جلب المجلدات', 'error');
    }
}

// دالة للانتقال إلى مجلد فرعي للنقل
async function navigateToSubfolderForMove(folderId, folderName) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs.push({ id: folderId, name: folderName });
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowserForMove();
}

// دالة للانتقال إلى مجلد في breadcrumb للنقل
async function navigateToFolderInBrowserForMove(folderId, breadcrumbIndex) {
    currentFolderBrowserState.currentFolderId = folderId;
    currentFolderBrowserState.breadcrumbs = currentFolderBrowserState.breadcrumbs.slice(0, breadcrumbIndex + 1);
    currentFolderBrowserState.selectedFolder = null;
    
    await renderFolderBrowserForMove();
}

// دالة لتحديد مجلد في المتصغير للنقل
function selectFolderInBrowserForMove(folderId, folderName) {
    currentFolderBrowserState.selectedFolder = { id: folderId, name: folderName };
    
    // إعادة عرض المتصغير لتحديث حالة التحديد
    const currentModal = document.querySelector('.folder-browser-modal');
    if (currentModal) {
        currentModal.remove();
        renderFolderBrowserForMove();
    }
}

// دالة لتأكيد نقل الملفات إلى المجلد المحدد
function confirmMoveToFolder(modalId) {
    if (!currentFolderBrowserState.selectedFolder) {
        showNotification('يرجى تحديد مجلد أولاً', 'error');
        return;
    }
    
    const { id, name } = currentFolderBrowserState.selectedFolder;
    const totalSelected = selectedFiles.size + selectedFolders.size;
    
    showNotification(`جاري نقل ${totalSelected} عنصر إلى مجلد "${name}"`, 'info');
    
    // محاكاة عملية النقل
    setTimeout(() => {
        showNotification(`تم نقل ${totalSelected} عنصر إلى مجلد "${name}" بنجاح`, 'success');
        
        // إعادة تعيين التحديد وإعادة تحميل الملفات
        selectedFiles.clear();
        selectedFolders.clear();
        updateBulkActionsBar();
        updateFileSelectionUI();
        updateFolderSelectionUI();
        if (typeof window.loadFiles === 'function') {
            window.loadFiles(state.currentFolderId);
        }
    }, 1500);
    
    // إغلاق النافذة
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
}

// Main Application Code
document.addEventListener('DOMContentLoaded', () => {
    // تعريف state ككائن عالمي
    window.state = {
        currentPage: 'dashboard',
        currentFolderId: 0,
        currentView: 'grid',
        breadcrumbs: [{ name: 'الملفات', id: 0 }],
        allFiles: [] // تخزين جميع الملفات
    };
    
    const newFabButton = document.getElementById('new-fab-button');
    const newFabMenu = document.getElementById('new-fab-menu');
    const newFabIcon = newFabButton.querySelector('i');
    
    const pages = {
        dashboard: document.getElementById('dashboard-page'),
        files: document.getElementById('files-page'),
        stats: document.getElementById('stats-page'),
    };
    
    const viewToggleList = document.getElementById('view-toggle-list');
    const viewToggleGrid = document.getElementById('view-toggle-grid');
    const breadcrumbContainer = document.getElementById('breadcrumb-container');
    
    // العناصر الجديدة
    const searchInput = document.getElementById('search-input');
    const searchInputList = document.getElementById('search-input-list');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectAllFoldersCheckbox = document.getElementById('select-all-folders-checkbox');
    const editTitlesBtn = document.getElementById('edit-titles-btn');
    const moveToFolderBtn = document.getElementById('move-to-folder-btn');
    const closeBulkActions = document.getElementById('close-bulk-actions');
    
    const navigateTo = (pageName) => {
        if (!pages[pageName]) return;
        state.currentPage = pageName;
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        pages[pageName].classList.remove('hidden');
        newFabMenu.classList.add('hidden');
        newFabButton.classList.remove('open');
        newFabIcon.dataset.lucide = 'plus';
        lucide.createIcons();
        
        // إخفاء شريط البحث إذا لم نكن في صفحة الملفات
        if (pageName !== 'files') {
            toggleSearchVisibility(false);
        }
        
        loadPageData(pageName);
    };
    
    const loadPageData = async (pageName) => {
        switch (pageName) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'files':
                await loadFiles(state.currentFolderId);
                break;
            case 'stats':
                await loadStats();
                break;
        }
    };
    
    const loadDashboard = async () => {
        const dashboardCardsContainer = document.getElementById('dashboard-cards');
        dashboardCardsContainer.innerHTML = `
            <div class="col-span-full flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500"></div>
                <span class="mr-3 text-gray-400">جاري تحميل البيانات...</span>
            </div>
        `;
        
        try {
            // جلب البيانات بشكل متزامن
            const [accountInfo, accountStats, totalFolders, filesStats] = await Promise.all([
                fetchAccountInfo(),
                fetchAccountStats(),
                calculateTotalFolders(),
                fetchFilesStats() // جلب إحصائيات الملفات من API
            ]);
            
            renderDashboardCards(dashboardCardsContainer, accountInfo, accountStats, totalFolders, filesStats);
        } catch (error) {
            dashboardCardsContainer.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-red-400 mx-auto mb-3"></i>
                    <p class="text-red-400">فشل في تحميل البيانات</p>
                    <p class="text-gray-400 text-sm mt-2">${error.message}</p>
                </div>
            `;
            lucide.createIcons();
            console.error('Failed to load dashboard ', error);
        }
    };
    
    // دالة محسنة لتحميل الملفات - التعديل الرئيسي هنا
    const loadFiles = async (folderId) => {
        // إخفاء شريط البحث أثناء التحميل
        toggleSearchVisibility(false);
        
        const foldersGrid = document.getElementById('folders-grid-container');
        const filesGrid = document.getElementById('files-grid-content');
        const foldersList = document.getElementById('folders-list-content');
        const filesList = document.getElementById('files-list-content');
        
        // إضافة تأثير تحميل سلس
        foldersGrid.style.opacity = '0.7';
        filesGrid.style.opacity = '0.7';
        foldersList.style.opacity = '0.7';
        filesList.style.opacity = '0.7';
        
        const loadingHTML = `
            <div class="col-span-full w-full flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
                <span class="mr-3 text-gray-400">جاري تحميل الملفات والمجلدات...</span>
            </div>
        `;
        
        foldersGrid.innerHTML = filesGrid.innerHTML = foldersList.innerHTML = filesList.innerHTML = loadingHTML;
        
        state.currentFolderId = folderId;
        
        try {
            // جلب محتويات المجلد الحالي فقط
            const folderContents = await fetchFiles(folderId);
            
            // جلب معلومات مفصلة لكل ملف للحصول على file_sizes - التعديل المحوري هنا
            const files = folderContents.result.files || [];
            
            if (files.length > 0) {
                const fileCodes = files.map(file => file.file_code);
                try {
                    const detailedFilesInfo = await fetchMultipleFilesInfo(fileCodes);
                    if (detailedFilesInfo && detailedFilesInfo.result) {
                        // دمج المعلومات المفصلة مع الملفات الأصلية بشكل صحيح
                        const detailedFilesMap = {};
                        detailedFilesInfo.result.forEach(detailedFile => {
                            if (detailedFile && detailedFile.file_code) {
                                detailedFilesMap[detailedFile.file_code] = detailedFile;
                            }
                        });
                        
                        // تحديث الملفات بالمعلومات المفصلة - التعديل الهام
                        files.forEach(file => {
                            if (detailedFilesMap[file.file_code]) {
                                const detailedFile = detailedFilesMap[file.file_code];
                                // نسخ جميع الخصائص المفصلة إلى الملف
                                Object.keys(detailedFile).forEach(key => {
                                    if (detailedFile[key] !== undefined && detailedFile[key] !== null) {
                                        file[key] = detailedFile[key];
                                    }
                                });
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error fetching detailed file info:', error);
                    // في حالة الخطأ، نستخدم البيانات الأساسية فقط
                }
            }
            
            // استخدام renderFiles المعدلة
            await renderFiles(
                folderContents.result.folders || [], 
                files,
                state.currentView, 
                handleFolderClick, 
                handleFileClick
            );
            
            renderBreadcrumbs(breadcrumbContainer, state.breadcrumbs, handleBreadcrumbClick);
            
            // إظهار شريط البحث بعد اكتمال التحميل
            toggleSearchVisibility(true);
            
            // استعادة الشفافية بعد التحميل
            setTimeout(() => {
                foldersGrid.style.opacity = '1';
                filesGrid.style.opacity = '1';
                foldersList.style.opacity = '1';
                filesList.style.opacity = '1';
            }, 300);
            
        } catch (error) {
            const errorHTML = `
                <div class="col-span-full w-full text-center py-8">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-red-400 mx-auto mb-3"></i>
                    <p class="text-red-400">فشل في تحميل الملفات</p>
                    <p class="text-gray-400 text-sm mt-2">${error.message}</p>
                </div>
            `;
            foldersGrid.innerHTML = filesGrid.innerHTML = foldersList.innerHTML = filesList.innerHTML = errorHTML;
            lucide.createIcons();
            console.error('Failed to load files ', error);
            
            // إظهار شريط البحث حتى في حالة الخطأ
            toggleSearchVisibility(true);
            
            // استعادة الشفافية في حالة الخطأ أيضًا
            foldersGrid.style.opacity = '1';
            filesGrid.style.opacity = '1';
            foldersList.style.opacity = '1';
            filesList.style.opacity = '1';
        }
    };
    
    const handleFolderClick = (folder) => {
        console.log('Opening folder:', folder);
        // تحديث breadcrumbs
        state.breadcrumbs.push({
            name: folder.name, 
            id: folder.fld_id
        });
        // تحميل محتويات المجلد الجديد
        loadFiles(folder.fld_id);
    };
    
    const handleFileClick = async (file) => {
        // الحل الجديد: استخدام البيانات مباشرة من أعمدة الجدول
        // لا نحتاج لاستدعاء API إضافي
        console.log('File data from table:', file);
        showFileDetails(file);
    };
    
    const handleBreadcrumbClick = (folderId, index) => {
        state.breadcrumbs = state.breadcrumbs.slice(0, index + 1);
        loadFiles(folderId);
    };
    
    // Event Listeners للزر العائم الجديد
    newFabButton.addEventListener('click', () => {
        newFabMenu.classList.toggle('hidden');
        newFabButton.classList.toggle('open');
        newFabIcon.dataset.lucide = newFabButton.classList.contains('open') ? 'x' : 'plus';
        lucide.createIcons();
    });
    
    newFabMenu.addEventListener('click', (e) => {
        const pageButton = e.target.closest('.new-fab-item');
        if (pageButton) {
            const pageName = pageButton.dataset.page;
            navigateTo(pageName);
        }
    });
    
    const setupViewToggles = () => {
        viewToggleList.addEventListener('click', () => {
            if (state.currentView === 'list') return;
            state.currentView = 'list';
            viewToggleGrid.classList.remove('bg-gray-700', 'text-cyan-400');
            viewToggleList.classList.add('bg-gray-700', 'text-cyan-400');
            loadFiles(state.currentFolderId);
        });
        
        viewToggleGrid.addEventListener('click', () => {
            if (state.currentView === 'grid') return;
            state.currentView = 'grid';
            viewToggleList.classList.remove('bg-gray-700', 'text-cyan-400');
            viewToggleGrid.classList.add('bg-gray-700', 'text-cyan-400');
            loadFiles(state.currentFolderId);
        });
    };
    
    // إعداد event listeners للقائمة المنسدلة للفترات الزمنية
    const setupPeriodSelectors = () => {
        // عناصر القائمة المنسدلة
        document.querySelectorAll('.period-dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                const period = parseInt(item.dataset.period);
                updatePeriod(period);
                // إغلاق القائمة المنسدلة
                document.querySelector('.period-dropdown-content').classList.remove('show');
            });
        });
        
        // فتح وإغلاق القائمة المنسدلة
        const dropdownButton = document.querySelector('.period-dropdown-button');
        const dropdownContent = document.querySelector('.period-dropdown-content');
        
        if (dropdownButton && dropdownContent) {
            dropdownButton.addEventListener('click', () => {
                dropdownContent.classList.toggle('show');
            });
            
            // إغلاق القائمة المنسدلة عند النقر خارجها
            document.addEventListener('click', (e) => {
                if (!dropdownButton.contains(e.target) && !dropdownContent.contains(e.target)) {
                    dropdownContent.classList.remove('show');
                }
            });
        }
    };
    
    // إعداد event listeners للوظائف الجديدة
    const setupNewFeatures = () => {
        // البحث المتقدم
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchFilesAndFolders(e.target.value);
            });
        }
        
        if (searchInputList) {
            searchInputList.addEventListener('input', (e) => {
                searchFilesAndFolders(e.target.value);
            });
        }
        
        // تحديد الكل للملفات
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSelectAll();
            });
        }
        
        // تحديد الكل للمجلدات
        if (selectAllFoldersCheckbox) {
            selectAllFoldersCheckbox.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSelectAllFolders();
            });
        }
        
        // تعديل العناوين
        if (editTitlesBtn) {
            editTitlesBtn.addEventListener('click', editSelectedTitles);
        }
        
        // نقل إلى مجلد
        if (moveToFolderBtn) {
            moveToFolderBtn.addEventListener('click', moveSelectedToFolder);
        }
        
        // إغلاق شريط الإجراءات
        if (closeBulkActions) {
            closeBulkActions.addEventListener('click', () => {
                selectedFiles.clear();
                selectedFolders.clear();
                updateBulkActionsBar();
                updateFileSelectionUI();
                updateFolderSelectionUI();
            });
        }
        
        // إعداد التحقق من حقل البحث
        setupSearchValidation();
    };
    
    // إعداد event listeners للتحديث التلقائي
    const setupAutoRefresh = () => {
        // إضافة عناصر التحكم بالتحديث التلقائي إلى الواجهة
        addAutoRefreshControls();
        
        // تفعيل التحديث التلقائي افتراضياً
        autoRefreshEnabled = true;
        startAutoRefresh();
        updateAutoRefreshButton(true);
    };
    
    // إعداد مكون الرسم البياني التفاعلي مع الوقت الفعلي
    const setupInteractiveCharts = () => {
        // إنشاء مخطط تفاعلي جديد في لوحة التحكم
        const interactiveChartContainer = document.getElementById('interactive-chart-container');
        if (interactiveChartContainer) {
            window.interactiveChart = new RealTimeViewsChart('interactive-chart-container', {
                period: 'hour',
                updateInterval: 5000, // تحديث كل 5 ثواني
                colors: {
                    line: '#22D3EE',
                    point: '#22D3EE', 
                    lastPoint: '#67E8F9',
                    grid: 'rgba(255, 255, 255, 0.1)',
                    text: '#9CA3AF'
                }
            });
            
            // إضافة بيانات اختبار للمخطط التفاعلي مع وقت حقيقي
            const now = new Date();
            const testData = [
                { timestamp: new Date(now.getTime() - 60 * 60 * 1000).toISOString(), views: 10 },
                { timestamp: new Date(now.getTime() - 50 * 60 * 1000).toISOString(), views: 25 },
                { timestamp: new Date(now.getTime() - 40 * 60 * 1000).toISOString(), views: 18 },
                { timestamp: new Date(now.getTime() - 30 * 60 * 1000).toISOString(), views: 32 },
                { timestamp: new Date(now.getTime() - 20 * 60 * 1000).toISOString(), views: 15 },
                { timestamp: new Date(now.getTime() - 10 * 60 * 1000).toISOString(), views: 28 },
                { timestamp: new Date().toISOString(), views: 36 }
            ];
            
            testData.forEach(point => {
                window.interactiveChart.addData(point);
            });
        }
    };
    
    const init = () => {
        lucide.createIcons();
        setupViewToggles();
        setupPeriodSelectors();
        setupNewFeatures();
        setupAutoRefresh(); // إضافة التحديث التلقائي
        setupInteractiveCharts(); // إضافة المخططات التفاعلية مع الوقت الفعلي
        navigateTo('dashboard');
        
        // جعل الدوال الأساسية متاحة عالمياً
        window.loadFiles = loadFiles;
        window.loadStats = loadStats;
        
        // جعل دوال التحديث التلقائي متاحة عالمياً
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.changeAutoRefreshInterval = changeAutoRefreshInterval;
        window.toggleIntervalDropdown = toggleIntervalDropdown;
        window.triggerImmediateRefresh = triggerImmediateRefresh;
        
        // جعل دوال التحميل متاحة عالمياً
        window.showUploadModal = showUploadModal;
        window.addRemoteUrl = addRemoteUrl;
        window.startUpload = startUpload;
        window.downloadFile = downloadFile;
        
        // جعل دوال استخراج الروابط متاحة عالمياً
        window.getEmbedLink = getEmbedLink;
        window.copyEmbedLink = copyEmbedLink;
        
        // جعل دوال المخطط التفاعلي متاحة عالمياً
        window.RealTimeViewsChart = RealTimeViewsChart;
    };
    
    init();
});
</script>	
</body>
</html>